var bf=Object.defineProperty;var _f=(nt,be,ze)=>be in nt?bf(nt,be,{enumerable:!0,configurable:!0,writable:!0,value:ze}):nt[be]=ze;var rt=(nt,be,ze)=>_f(nt,typeof be!="symbol"?be+"":be,ze);(function(){"use strict";function nt(n){if(typeof n>"u")return null;try{return JSON.parse(n)}catch{}let e="";const t=[];let r=!1,a=!1;for(let i of n){if(r)i==='"'&&!a?r=!1:i===`
`&&!a?i="\\n":i==="\\"?a=!a:a=!1;else if(i==='"')r=!0,a=!1;else if(i==="{")t.push("}");else if(i==="[")t.push("]");else if(i==="}"||i==="]")if(t&&t[t.length-1]===i)t.pop();else return null;e+=i}r&&(e+='"');for(let i=t.length-1;i>=0;i-=1)e+=t[i];try{return JSON.parse(e)}catch{return null}}function be(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var ze,ei;function Go(){return ei||(ei=1,ze=function(n,e){if(typeof n!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,n.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()}),ze}var Zo=Go(),Wo=be(Zo),tr={exports:{}},ti;function Jo(){if(ti)return tr.exports;ti=1;const n=/[\p{Lu}]/u,e=/[\p{Ll}]/u,t=/^[\p{Lu}](?![\p{Lu}])/gu,r=/([\p{Alpha}\p{N}_]|$)/u,a=/[_.\- ]+/,i=new RegExp("^"+a.source),s=new RegExp(a.source+r.source,"gu"),o=new RegExp("\\d+"+r.source,"gu"),u=(d,f,p)=>{let m=!1,g=!1,y=!1;for(let _=0;_<d.length;_++){const b=d[_];m&&n.test(b)?(d=d.slice(0,_)+"-"+d.slice(_),m=!1,y=g,g=!0,_++):g&&y&&e.test(b)?(d=d.slice(0,_-1)+"-"+d.slice(_-1),y=g,g=!1,m=!0):(m=f(b)===b&&p(b)!==b,y=g,g=p(b)===b&&f(b)!==b)}return d},l=(d,f)=>(t.lastIndex=0,d.replace(t,p=>f(p))),c=(d,f)=>(s.lastIndex=0,o.lastIndex=0,d.replace(s,(p,m)=>f(m)).replace(o,p=>f(p))),h=(d,f)=>{if(!(typeof d=="string"||Array.isArray(d)))throw new TypeError("Expected the input to be `string | string[]`");if(f={pascalCase:!1,preserveConsecutiveUppercase:!1,...f},Array.isArray(d)?d=d.map(y=>y.trim()).filter(y=>y.length).join("-"):d=d.trim(),d.length===0)return"";const p=f.locale===!1?y=>y.toLowerCase():y=>y.toLocaleLowerCase(f.locale),m=f.locale===!1?y=>y.toUpperCase():y=>y.toLocaleUpperCase(f.locale);return d.length===1?f.pascalCase?m(d):p(d):(d!==p(d)&&(d=u(d,p,m)),d=d.replace(i,""),f.preserveConsecutiveUppercase?d=l(d,p):d=p(d),f.pascalCase&&(d=m(d.charAt(0))+d.slice(1)),c(d,m))};return tr.exports=h,tr.exports.default=h,tr.exports}Jo();function Ko(n,e){return e?.[n]||Wo(n)}function Xo(n,e,t){const r={};for(const a in n)Object.hasOwn(n,a)&&(r[e(a,t)]=n[a]);return r}function ri(n){return Array.isArray(n)?[...n]:{...n}}function Yo(n,e){const t=ri(n);for(const[r,a]of Object.entries(e)){const[i,...s]=r.split(".").reverse();let o=t;for(const u of s.reverse()){if(o[u]===void 0)break;o[u]=ri(o[u]),o=o[u]}o[i]!==void 0&&(o[i]={lc:1,type:"secret",id:[a]})}return t}function ni(n){const e=Object.getPrototypeOf(n);return typeof n.lc_name=="function"&&(typeof e.lc_name!="function"||n.lc_name()!==e.lc_name())?n.lc_name():n.name}class at{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,ni(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_serializable_keys!==void 0?this.lc_kwargs=Object.fromEntries(Object.entries(e||{}).filter(([r])=>this.lc_serializable_keys?.includes(r))):this.lc_kwargs=e??{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof at||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},r=Object.keys(this.lc_kwargs).reduce((a,i)=>(a[i]=i in this?this[i]:this.lc_kwargs[i],a),{});for(let a=Object.getPrototypeOf(this);a;a=Object.getPrototypeOf(a))Object.assign(e,Reflect.get(a,"lc_aliases",this)),Object.assign(t,Reflect.get(a,"lc_secrets",this)),Object.assign(r,Reflect.get(a,"lc_attributes",this));return Object.keys(t).forEach(a=>{let i=this,s=r;const[o,...u]=a.split(".").reverse();for(const l of u.reverse()){if(!(l in i)||i[l]===void 0)return;(!(l in s)||s[l]===void 0)&&(typeof i[l]=="object"&&i[l]!=null?s[l]={}:Array.isArray(i[l])&&(s[l]=[])),i=i[l],s=s[l]}o in i&&i[o]!==void 0&&(s[o]=s[o]||i[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:Xo(Object.keys(t).length?Yo(r,t):r,Ko,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}function ai(n){return typeof n=="object"&&n!==null&&"type"in n&&typeof n.type=="string"&&"source_type"in n&&(n.source_type==="url"||n.source_type==="base64"||n.source_type==="text"||n.source_type==="id")}function Qo(n,e){return typeof n=="string"?n===""?e:typeof e=="string"?n+e:Array.isArray(e)&&e.some(t=>ai(t))?[{type:"text",source_type:"text",text:n},...e]:[{type:"text",text:n},...e]:Array.isArray(e)?Br(n,e)??[...n,...e]:e===""?n:Array.isArray(n)&&n.some(t=>ai(t))?[...n,{type:"file",source_type:"text",text:e}]:[...n,{type:"text",text:e}]}function eu(n,e){function t(r,a){if(typeof r!="object"||r===null||r===void 0)return r;if(a>=e)return Array.isArray(r)?"[Array]":"[Object]";if(Array.isArray(r))return r.map(s=>t(s,a+1));const i={};for(const s of Object.keys(r))i[s]=t(r[s],a+1);return i}return JSON.stringify(t(n,0),null,2)}class Fe extends at{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:Array.isArray(this.content)?this.content.map(e=>typeof e=="string"?e:e.type==="text"?e.text:"").join(""):""}getType(){return this._getType()}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;const t=eu(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${t}`}}function rr(n,e){const t={...n};for(const[r,a]of Object.entries(e))if(t[r]==null)t[r]=a;else{if(a==null)continue;if(typeof t[r]!=typeof a||Array.isArray(t[r])!==Array.isArray(a))throw new Error(`field[${r}] already exists in the message chunk, but with a different type.`);if(typeof t[r]=="string"){if(r==="type")continue;t[r]+=a}else if(typeof t[r]=="object"&&!Array.isArray(t[r]))t[r]=rr(t[r],a);else if(Array.isArray(t[r]))t[r]=Br(t[r],a);else{if(t[r]===a)continue;console.warn(`field[${r}] already exists in this message chunk and value has unsupported type.`)}}return t}function Br(n,e){if(!(n===void 0&&e===void 0)){if(n===void 0||e===void 0)return n||e;{const t=[...n];for(const r of e)if(typeof r=="object"&&"index"in r&&typeof r.index=="number"){const a=t.findIndex(i=>i.index===r.index);a!==-1?t[a]=rr(t[a],r):t.push(r)}else{if(typeof r=="object"&&"text"in r&&r.text==="")continue;t.push(r)}return t}}}class tu extends Fe{}function ru(n){return typeof n.role=="string"}function ii(n){return typeof n?._getType=="function"}class nu extends Fe{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}constructor(e,t,r){typeof e=="string"&&(e={content:e,name:r,tool_call_id:t}),super(e),Object.defineProperty(this,"lc_direct_tool_output",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}_getType(){return"tool"}static isInstance(e){return e._getType()==="tool"}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}function au(n){const e=[],t=[];for(const r of n)if(r.function){const a=r.function.name;try{const i=JSON.parse(r.function.arguments),s={name:a||"",args:i||{},id:r.id};e.push(s)}catch{t.push({name:a,args:r.function.arguments,id:r.id,error:"Malformed args."})}}else continue;return[e,t]}class nr extends Fe{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let r;if(typeof e=="string")r={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{r=e;const a=r.additional_kwargs?.tool_calls,i=r.tool_calls;a!=null&&a.length>0&&(i===void 0||i.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(a!=null&&i===void 0){const[s,o]=au(a);r.tool_calls=s??[],r.invalid_tool_calls=o??[]}else r.tool_calls=r.tool_calls??[],r.invalid_tool_calls=r.invalid_tool_calls??[]}catch{r.tool_calls=[],r.invalid_tool_calls=[]}}super(r),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r!="string"&&(this.tool_calls=r.tool_calls??this.tool_calls,this.invalid_tool_calls=r.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=r.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}}class ar extends tu{constructor(e){let t;if(typeof e=="string")t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0};else{const r=[],a=[];for(const i of e.tool_call_chunks){let s={};try{if(s=nt(i.args||"{}"),s===null||typeof s!="object"||Array.isArray(s))throw new Error("Malformed tool call chunk args.");r.push({name:i.name??"",args:s,id:i.id,type:"tool_call"})}catch{a.push({name:i.name,args:i.args,id:i.id,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:r,invalid_tool_calls:a,usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){const t={content:Qo(this.content,e.content),additional_kwargs:rr(this.additional_kwargs,e.additional_kwargs),response_metadata:rr(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){const r=Br(this.tool_call_chunks,e.tool_call_chunks);r!==void 0&&r.length>0&&(t.tool_call_chunks=r)}if(this.usage_metadata!==void 0||e.usage_metadata!==void 0){const r={...(this.usage_metadata?.input_token_details?.audio!==void 0||e.usage_metadata?.input_token_details?.audio!==void 0)&&{audio:(this.usage_metadata?.input_token_details?.audio??0)+(e.usage_metadata?.input_token_details?.audio??0)},...(this.usage_metadata?.input_token_details?.cache_read!==void 0||e.usage_metadata?.input_token_details?.cache_read!==void 0)&&{cache_read:(this.usage_metadata?.input_token_details?.cache_read??0)+(e.usage_metadata?.input_token_details?.cache_read??0)},...(this.usage_metadata?.input_token_details?.cache_creation!==void 0||e.usage_metadata?.input_token_details?.cache_creation!==void 0)&&{cache_creation:(this.usage_metadata?.input_token_details?.cache_creation??0)+(e.usage_metadata?.input_token_details?.cache_creation??0)}},a={...(this.usage_metadata?.output_token_details?.audio!==void 0||e.usage_metadata?.output_token_details?.audio!==void 0)&&{audio:(this.usage_metadata?.output_token_details?.audio??0)+(e.usage_metadata?.output_token_details?.audio??0)},...(this.usage_metadata?.output_token_details?.reasoning!==void 0||e.usage_metadata?.output_token_details?.reasoning!==void 0)&&{reasoning:(this.usage_metadata?.output_token_details?.reasoning??0)+(e.usage_metadata?.output_token_details?.reasoning??0)}},i=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},s=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},o={input_tokens:i.input_tokens+s.input_tokens,output_tokens:i.output_tokens+s.output_tokens,total_tokens:i.total_tokens+s.total_tokens,...Object.keys(r).length>0&&{input_token_details:r},...Object.keys(a).length>0&&{output_token_details:a}};t.usage_metadata=o}return new ar(t)}}class ir extends Fe{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return ir}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}}class At extends Fe{static lc_name(){return"HumanMessage"}_getType(){return"human"}constructor(e,t){super(e,t)}}class Vr extends Fe{static lc_name(){return"SystemMessage"}_getType(){return"system"}constructor(e,t){super(e,t)}}function qr(n,e){return n.lc_error_code=e,n.message=`${n.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,n}function si(n){return!!(n&&typeof n=="object"&&"type"in n&&n.type==="tool_call")}class iu extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}}function su(n){return si(n)?n:typeof n.id=="string"&&n.type==="function"&&typeof n.function=="object"&&n.function!==null&&"arguments"in n.function&&typeof n.function.arguments=="string"&&"name"in n.function&&typeof n.function.name=="string"?{id:n.id,args:JSON.parse(n.function.arguments),name:n.function.name,type:"tool_call"}:n}function ou(n){return typeof n=="object"&&n!=null&&n.lc===1&&Array.isArray(n.id)&&n.kwargs!=null&&typeof n.kwargs=="object"}function Hr(n){let e,t;if(ou(n)){const r=n.id.at(-1);r==="HumanMessage"||r==="HumanMessageChunk"?e="user":r==="AIMessage"||r==="AIMessageChunk"?e="assistant":r==="SystemMessage"||r==="SystemMessageChunk"?e="system":r==="FunctionMessage"||r==="FunctionMessageChunk"?e="function":r==="ToolMessage"||r==="ToolMessageChunk"?e="tool":e="unknown",t=n.kwargs}else{const{type:r,...a}=n;e=r,t=a}if(e==="human"||e==="user")return new At(t);if(e==="ai"||e==="assistant"){const{tool_calls:r,...a}=t;if(!Array.isArray(r))return new nr(t);const i=r.map(su);return new nr({...a,tool_calls:i})}else{if(e==="system")return new Vr(t);if(e==="developer")return new Vr({...t,additional_kwargs:{...t.additional_kwargs,__openai_role__:"developer"}});if(e==="tool"&&"tool_call_id"in t)return new nu({...t,content:t.content,tool_call_id:t.tool_call_id,name:t.name});throw qr(new Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.

Received: ${JSON.stringify(n,null,2)}`),"MESSAGE_COERCION_FAILURE")}}function sr(n){if(typeof n=="string")return new At(n);if(ii(n))return n;if(Array.isArray(n)){const[e,t]=n;return Hr({type:e,content:t})}else if(ru(n)){const{role:e,...t}=n;return Hr({...t,type:e})}else return Hr(n)}function zr(n,e="Human",t="AI"){const r=[];for(const a of n){let i;if(a._getType()==="human")i=e;else if(a._getType()==="ai")i=t;else if(a._getType()==="system")i="System";else if(a._getType()==="function")i="Function";else if(a._getType()==="tool")i="Tool";else if(a._getType()==="generic")i=a.role;else throw new Error(`Got unsupported message type: ${a._getType()}`);const s=a.name?`${a.name}, `:"",o=typeof a.content=="string"?a.content:JSON.stringify(a.content,null,2);r.push(`${i}: ${s}${o}`)}return r.join(`
`)}var z;(function(n){n.assertEqual=a=>{};function e(a){}n.assertIs=e;function t(a){throw new Error}n.assertNever=t,n.arrayToEnum=a=>{const i={};for(const s of a)i[s]=s;return i},n.getValidEnumValues=a=>{const i=n.objectKeys(a).filter(o=>typeof a[a[o]]!="number"),s={};for(const o of i)s[o]=a[o];return n.objectValues(s)},n.objectValues=a=>n.objectKeys(a).map(function(i){return a[i]}),n.objectKeys=typeof Object.keys=="function"?a=>Object.keys(a):a=>{const i=[];for(const s in a)Object.prototype.hasOwnProperty.call(a,s)&&i.push(s);return i},n.find=(a,i)=>{for(const s of a)if(i(s))return s},n.isInteger=typeof Number.isInteger=="function"?a=>Number.isInteger(a):a=>typeof a=="number"&&Number.isFinite(a)&&Math.floor(a)===a;function r(a,i=" | "){return a.map(s=>typeof s=="string"?`'${s}'`:s).join(i)}n.joinValues=r,n.jsonStringifyReplacer=(a,i)=>typeof i=="bigint"?i.toString():i})(z||(z={}));var oi;(function(n){n.mergeShapes=(e,t)=>({...e,...t})})(oi||(oi={}));const A=z.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Ge=n=>{switch(typeof n){case"undefined":return A.undefined;case"string":return A.string;case"number":return Number.isNaN(n)?A.nan:A.number;case"boolean":return A.boolean;case"function":return A.function;case"bigint":return A.bigint;case"symbol":return A.symbol;case"object":return Array.isArray(n)?A.array:n===null?A.null:n.then&&typeof n.then=="function"&&n.catch&&typeof n.catch=="function"?A.promise:typeof Map<"u"&&n instanceof Map?A.map:typeof Set<"u"&&n instanceof Set?A.set:typeof Date<"u"&&n instanceof Date?A.date:A.object;default:return A.unknown}},w=z.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class De extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(i){return i.message},r={_errors:[]},a=i=>{for(const s of i.issues)if(s.code==="invalid_union")s.unionErrors.map(a);else if(s.code==="invalid_return_type")a(s.returnTypeError);else if(s.code==="invalid_arguments")a(s.argumentsError);else if(s.path.length===0)r._errors.push(t(s));else{let o=r,u=0;for(;u<s.path.length;){const l=s.path[u];u===s.path.length-1?(o[l]=o[l]||{_errors:[]},o[l]._errors.push(t(s))):o[l]=o[l]||{_errors:[]},o=o[l],u++}}};return a(this),r}static assert(e){if(!(e instanceof De))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,z.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},r=[];for(const a of this.issues)a.path.length>0?(t[a.path[0]]=t[a.path[0]]||[],t[a.path[0]].push(e(a))):r.push(e(a));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}}De.create=n=>new De(n);const Gr=(n,e)=>{let t;switch(n.code){case w.invalid_type:n.received===A.undefined?t="Required":t=`Expected ${n.expected}, received ${n.received}`;break;case w.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(n.expected,z.jsonStringifyReplacer)}`;break;case w.unrecognized_keys:t=`Unrecognized key(s) in object: ${z.joinValues(n.keys,", ")}`;break;case w.invalid_union:t="Invalid input";break;case w.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${z.joinValues(n.options)}`;break;case w.invalid_enum_value:t=`Invalid enum value. Expected ${z.joinValues(n.options)}, received '${n.received}'`;break;case w.invalid_arguments:t="Invalid function arguments";break;case w.invalid_return_type:t="Invalid function return type";break;case w.invalid_date:t="Invalid date";break;case w.invalid_string:typeof n.validation=="object"?"includes"in n.validation?(t=`Invalid input: must include "${n.validation.includes}"`,typeof n.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${n.validation.position}`)):"startsWith"in n.validation?t=`Invalid input: must start with "${n.validation.startsWith}"`:"endsWith"in n.validation?t=`Invalid input: must end with "${n.validation.endsWith}"`:z.assertNever(n.validation):n.validation!=="regex"?t=`Invalid ${n.validation}`:t="Invalid";break;case w.too_small:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at least":"more than"} ${n.minimum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at least":"over"} ${n.minimum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${n.minimum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(n.minimum))}`:t="Invalid input";break;case w.too_big:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at most":"less than"} ${n.maximum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at most":"under"} ${n.maximum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="bigint"?t=`BigInt must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly":n.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(n.maximum))}`:t="Invalid input";break;case w.custom:t="Invalid input";break;case w.invalid_intersection_types:t="Intersection results could not be merged";break;case w.not_multiple_of:t=`Number must be a multiple of ${n.multipleOf}`;break;case w.not_finite:t="Number must be finite";break;default:t=e.defaultError,z.assertNever(n)}return{message:t}};let uu=Gr;function lu(){return uu}const cu=n=>{const{data:e,path:t,errorMaps:r,issueData:a}=n,i=[...t,...a.path||[]],s={...a,path:i};if(a.message!==void 0)return{...a,path:i,message:a.message};let o="";const u=r.filter(l=>!!l).slice().reverse();for(const l of u)o=l(s,{data:e,defaultError:o}).message;return{...a,path:i,message:o}};function x(n,e){const t=lu(),r=cu({issueData:e,data:n.data,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,t,t===Gr?void 0:Gr].filter(a=>!!a)});n.common.issues.push(r)}class _e{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){const r=[];for(const a of t){if(a.status==="aborted")return L;a.status==="dirty"&&e.dirty(),r.push(a.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){const r=[];for(const a of t){const i=await a.key,s=await a.value;r.push({key:i,value:s})}return _e.mergeObjectSync(e,r)}static mergeObjectSync(e,t){const r={};for(const a of t){const{key:i,value:s}=a;if(i.status==="aborted"||s.status==="aborted")return L;i.status==="dirty"&&e.dirty(),s.status==="dirty"&&e.dirty(),i.value!=="__proto__"&&(typeof s.value<"u"||a.alwaysSet)&&(r[i.value]=s.value)}return{status:e.value,value:r}}}const L=Object.freeze({status:"aborted"}),Rt=n=>({status:"dirty",value:n}),xe=n=>({status:"valid",value:n}),ui=n=>n.status==="aborted",li=n=>n.status==="dirty",ht=n=>n.status==="valid",or=n=>typeof Promise<"u"&&n instanceof Promise;var R;(function(n){n.errToObj=e=>typeof e=="string"?{message:e}:e||{},n.toString=e=>typeof e=="string"?e:e?.message})(R||(R={}));class Ze{constructor(e,t,r,a){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=a}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const ci=(n,e)=>{if(ht(e))return{success:!0,data:e.value};if(!n.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new De(n.common.issues);return this._error=t,this._error}}};function V(n){if(!n)return{};const{errorMap:e,invalid_type_error:t,required_error:r,description:a}=n;if(e&&(t||r))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:a}:{errorMap:(s,o)=>{const{message:u}=n;return s.code==="invalid_enum_value"?{message:u??o.defaultError}:typeof o.data>"u"?{message:u??r??o.defaultError}:s.code!=="invalid_type"?{message:o.defaultError}:{message:u??t??o.defaultError}},description:a}}class H{get description(){return this._def.description}_getType(e){return Ge(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:Ge(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new _e,ctx:{common:e.parent.common,data:e.data,parsedType:Ge(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(or(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){const r={common:{issues:[],async:t?.async??!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Ge(e)},a=this._parseSync({data:e,path:r.path,parent:r});return ci(r,a)}"~validate"(e){const t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Ge(e)};if(!this["~standard"].async)try{const r=this._parseSync({data:e,path:[],parent:t});return ht(r)?{value:r.value}:{issues:t.common.issues}}catch(r){r?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(r=>ht(r)?{value:r.value}:{issues:t.common.issues})}async parseAsync(e,t){const r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){const r={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Ge(e)},a=this._parse({data:e,path:r.path,parent:r}),i=await(or(a)?a:Promise.resolve(a));return ci(r,i)}refine(e,t){const r=a=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(a):t;return this._refinement((a,i)=>{const s=e(a),o=()=>i.addIssue({code:w.custom,...r(a)});return typeof Promise<"u"&&s instanceof Promise?s.then(u=>u?!0:(o(),!1)):s?!0:(o(),!1)})}refinement(e,t){return this._refinement((r,a)=>e(r)?!0:(a.addIssue(typeof t=="function"?t(r,a):t),!1))}_refinement(e){return new mt({schema:this,typeName:v.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:t=>this["~validate"](t)}}optional(){return Be.create(this,this._def)}nullable(){return gt.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return je.create(this)}promise(){return dr.create(this,this._def)}or(e){return lr.create([this,e],this._def)}and(e){return cr.create(this,e,this._def)}transform(e){return new mt({...V(this._def),schema:this,typeName:v.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t=typeof e=="function"?e:()=>e;return new Kr({...V(this._def),innerType:this,defaultValue:t,typeName:v.ZodDefault})}brand(){return new $u({typeName:v.ZodBranded,type:this,...V(this._def)})}catch(e){const t=typeof e=="function"?e:()=>e;return new Xr({...V(this._def),innerType:this,catchValue:t,typeName:v.ZodCatch})}describe(e){const t=this.constructor;return new t({...this._def,description:e})}pipe(e){return Yr.create(this,e)}readonly(){return Qr.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const du=/^c[^\s-]{8,}$/i,hu=/^[0-9a-z]+$/,fu=/^[0-9A-HJKMNP-TV-Z]{26}$/i,pu=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,mu=/^[a-z0-9_-]{21}$/i,gu=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,yu=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,bu=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,_u="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let Zr;const wu=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,vu=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,Eu=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,Ou=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,xu=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Su=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,di="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",Tu=new RegExp(`^${di}$`);function hi(n){let e="[0-5]\\d";n.precision?e=`${e}\\.\\d{${n.precision}}`:n.precision==null&&(e=`${e}(\\.\\d+)?`);const t=n.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${t}`}function Pu(n){return new RegExp(`^${hi(n)}$`)}function Au(n){let e=`${di}T${hi(n)}`;const t=[];return t.push(n.local?"Z?":"Z"),n.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function Ru(n,e){return!!((e==="v4"||!e)&&wu.test(n)||(e==="v6"||!e)&&Eu.test(n))}function Iu(n,e){if(!gu.test(n))return!1;try{const[t]=n.split("."),r=t.replace(/-/g,"+").replace(/_/g,"/").padEnd(t.length+(4-t.length%4)%4,"="),a=JSON.parse(atob(r));return!(typeof a!="object"||a===null||"typ"in a&&a?.typ!=="JWT"||!a.alg||e&&a.alg!==e)}catch{return!1}}function ku(n,e){return!!((e==="v4"||!e)&&vu.test(n)||(e==="v6"||!e)&&Ou.test(n))}class Ue extends H{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==A.string){const i=this._getOrReturnCtx(e);return x(i,{code:w.invalid_type,expected:A.string,received:i.parsedType}),L}const r=new _e;let a;for(const i of this._def.checks)if(i.kind==="min")e.data.length<i.value&&(a=this._getOrReturnCtx(e,a),x(a,{code:w.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),r.dirty());else if(i.kind==="max")e.data.length>i.value&&(a=this._getOrReturnCtx(e,a),x(a,{code:w.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),r.dirty());else if(i.kind==="length"){const s=e.data.length>i.value,o=e.data.length<i.value;(s||o)&&(a=this._getOrReturnCtx(e,a),s?x(a,{code:w.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}):o&&x(a,{code:w.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}),r.dirty())}else if(i.kind==="email")bu.test(e.data)||(a=this._getOrReturnCtx(e,a),x(a,{validation:"email",code:w.invalid_string,message:i.message}),r.dirty());else if(i.kind==="emoji")Zr||(Zr=new RegExp(_u,"u")),Zr.test(e.data)||(a=this._getOrReturnCtx(e,a),x(a,{validation:"emoji",code:w.invalid_string,message:i.message}),r.dirty());else if(i.kind==="uuid")pu.test(e.data)||(a=this._getOrReturnCtx(e,a),x(a,{validation:"uuid",code:w.invalid_string,message:i.message}),r.dirty());else if(i.kind==="nanoid")mu.test(e.data)||(a=this._getOrReturnCtx(e,a),x(a,{validation:"nanoid",code:w.invalid_string,message:i.message}),r.dirty());else if(i.kind==="cuid")du.test(e.data)||(a=this._getOrReturnCtx(e,a),x(a,{validation:"cuid",code:w.invalid_string,message:i.message}),r.dirty());else if(i.kind==="cuid2")hu.test(e.data)||(a=this._getOrReturnCtx(e,a),x(a,{validation:"cuid2",code:w.invalid_string,message:i.message}),r.dirty());else if(i.kind==="ulid")fu.test(e.data)||(a=this._getOrReturnCtx(e,a),x(a,{validation:"ulid",code:w.invalid_string,message:i.message}),r.dirty());else if(i.kind==="url")try{new URL(e.data)}catch{a=this._getOrReturnCtx(e,a),x(a,{validation:"url",code:w.invalid_string,message:i.message}),r.dirty()}else i.kind==="regex"?(i.regex.lastIndex=0,i.regex.test(e.data)||(a=this._getOrReturnCtx(e,a),x(a,{validation:"regex",code:w.invalid_string,message:i.message}),r.dirty())):i.kind==="trim"?e.data=e.data.trim():i.kind==="includes"?e.data.includes(i.value,i.position)||(a=this._getOrReturnCtx(e,a),x(a,{code:w.invalid_string,validation:{includes:i.value,position:i.position},message:i.message}),r.dirty()):i.kind==="toLowerCase"?e.data=e.data.toLowerCase():i.kind==="toUpperCase"?e.data=e.data.toUpperCase():i.kind==="startsWith"?e.data.startsWith(i.value)||(a=this._getOrReturnCtx(e,a),x(a,{code:w.invalid_string,validation:{startsWith:i.value},message:i.message}),r.dirty()):i.kind==="endsWith"?e.data.endsWith(i.value)||(a=this._getOrReturnCtx(e,a),x(a,{code:w.invalid_string,validation:{endsWith:i.value},message:i.message}),r.dirty()):i.kind==="datetime"?Au(i).test(e.data)||(a=this._getOrReturnCtx(e,a),x(a,{code:w.invalid_string,validation:"datetime",message:i.message}),r.dirty()):i.kind==="date"?Tu.test(e.data)||(a=this._getOrReturnCtx(e,a),x(a,{code:w.invalid_string,validation:"date",message:i.message}),r.dirty()):i.kind==="time"?Pu(i).test(e.data)||(a=this._getOrReturnCtx(e,a),x(a,{code:w.invalid_string,validation:"time",message:i.message}),r.dirty()):i.kind==="duration"?yu.test(e.data)||(a=this._getOrReturnCtx(e,a),x(a,{validation:"duration",code:w.invalid_string,message:i.message}),r.dirty()):i.kind==="ip"?Ru(e.data,i.version)||(a=this._getOrReturnCtx(e,a),x(a,{validation:"ip",code:w.invalid_string,message:i.message}),r.dirty()):i.kind==="jwt"?Iu(e.data,i.alg)||(a=this._getOrReturnCtx(e,a),x(a,{validation:"jwt",code:w.invalid_string,message:i.message}),r.dirty()):i.kind==="cidr"?ku(e.data,i.version)||(a=this._getOrReturnCtx(e,a),x(a,{validation:"cidr",code:w.invalid_string,message:i.message}),r.dirty()):i.kind==="base64"?xu.test(e.data)||(a=this._getOrReturnCtx(e,a),x(a,{validation:"base64",code:w.invalid_string,message:i.message}),r.dirty()):i.kind==="base64url"?Su.test(e.data)||(a=this._getOrReturnCtx(e,a),x(a,{validation:"base64url",code:w.invalid_string,message:i.message}),r.dirty()):z.assertNever(i);return{status:r.value,value:e.data}}_regex(e,t,r){return this.refinement(a=>e.test(a),{validation:t,code:w.invalid_string,...R.errToObj(r)})}_addCheck(e){return new Ue({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...R.errToObj(e)})}url(e){return this._addCheck({kind:"url",...R.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...R.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...R.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...R.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...R.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...R.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...R.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...R.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...R.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...R.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...R.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...R.errToObj(e)})}datetime(e){return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof e?.precision>"u"?null:e?.precision,offset:e?.offset??!1,local:e?.local??!1,...R.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof e?.precision>"u"?null:e?.precision,...R.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...R.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...R.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...R.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...R.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...R.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...R.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...R.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...R.errToObj(t)})}nonempty(e){return this.min(1,R.errToObj(e))}trim(){return new Ue({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Ue({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Ue({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}Ue.create=n=>new Ue({checks:[],typeName:v.ZodString,coerce:n?.coerce??!1,...V(n)});function Cu(n,e){const t=(n.toString().split(".")[1]||"").length,r=(e.toString().split(".")[1]||"").length,a=t>r?t:r,i=Number.parseInt(n.toFixed(a).replace(".","")),s=Number.parseInt(e.toFixed(a).replace(".",""));return i%s/10**a}class It extends H{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==A.number){const i=this._getOrReturnCtx(e);return x(i,{code:w.invalid_type,expected:A.number,received:i.parsedType}),L}let r;const a=new _e;for(const i of this._def.checks)i.kind==="int"?z.isInteger(e.data)||(r=this._getOrReturnCtx(e,r),x(r,{code:w.invalid_type,expected:"integer",received:"float",message:i.message}),a.dirty()):i.kind==="min"?(i.inclusive?e.data<i.value:e.data<=i.value)&&(r=this._getOrReturnCtx(e,r),x(r,{code:w.too_small,minimum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),a.dirty()):i.kind==="max"?(i.inclusive?e.data>i.value:e.data>=i.value)&&(r=this._getOrReturnCtx(e,r),x(r,{code:w.too_big,maximum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),a.dirty()):i.kind==="multipleOf"?Cu(e.data,i.value)!==0&&(r=this._getOrReturnCtx(e,r),x(r,{code:w.not_multiple_of,multipleOf:i.value,message:i.message}),a.dirty()):i.kind==="finite"?Number.isFinite(e.data)||(r=this._getOrReturnCtx(e,r),x(r,{code:w.not_finite,message:i.message}),a.dirty()):z.assertNever(i);return{status:a.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,R.toString(t))}gt(e,t){return this.setLimit("min",e,!1,R.toString(t))}lte(e,t){return this.setLimit("max",e,!0,R.toString(t))}lt(e,t){return this.setLimit("max",e,!1,R.toString(t))}setLimit(e,t,r,a){return new It({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:R.toString(a)}]})}_addCheck(e){return new It({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:R.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:R.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:R.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:R.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:R.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:R.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:R.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:R.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:R.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&z.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const r of this._def.checks){if(r.kind==="finite"||r.kind==="int"||r.kind==="multipleOf")return!0;r.kind==="min"?(t===null||r.value>t)&&(t=r.value):r.kind==="max"&&(e===null||r.value<e)&&(e=r.value)}return Number.isFinite(t)&&Number.isFinite(e)}}It.create=n=>new It({checks:[],typeName:v.ZodNumber,coerce:n?.coerce||!1,...V(n)});class kt extends H{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==A.bigint)return this._getInvalidInput(e);let r;const a=new _e;for(const i of this._def.checks)i.kind==="min"?(i.inclusive?e.data<i.value:e.data<=i.value)&&(r=this._getOrReturnCtx(e,r),x(r,{code:w.too_small,type:"bigint",minimum:i.value,inclusive:i.inclusive,message:i.message}),a.dirty()):i.kind==="max"?(i.inclusive?e.data>i.value:e.data>=i.value)&&(r=this._getOrReturnCtx(e,r),x(r,{code:w.too_big,type:"bigint",maximum:i.value,inclusive:i.inclusive,message:i.message}),a.dirty()):i.kind==="multipleOf"?e.data%i.value!==BigInt(0)&&(r=this._getOrReturnCtx(e,r),x(r,{code:w.not_multiple_of,multipleOf:i.value,message:i.message}),a.dirty()):z.assertNever(i);return{status:a.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return x(t,{code:w.invalid_type,expected:A.bigint,received:t.parsedType}),L}gte(e,t){return this.setLimit("min",e,!0,R.toString(t))}gt(e,t){return this.setLimit("min",e,!1,R.toString(t))}lte(e,t){return this.setLimit("max",e,!0,R.toString(t))}lt(e,t){return this.setLimit("max",e,!1,R.toString(t))}setLimit(e,t,r,a){return new kt({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:R.toString(a)}]})}_addCheck(e){return new kt({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:R.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:R.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:R.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:R.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:R.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}kt.create=n=>new kt({checks:[],typeName:v.ZodBigInt,coerce:n?.coerce??!1,...V(n)});class fi extends H{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==A.boolean){const r=this._getOrReturnCtx(e);return x(r,{code:w.invalid_type,expected:A.boolean,received:r.parsedType}),L}return xe(e.data)}}fi.create=n=>new fi({typeName:v.ZodBoolean,coerce:n?.coerce||!1,...V(n)});class ur extends H{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==A.date){const i=this._getOrReturnCtx(e);return x(i,{code:w.invalid_type,expected:A.date,received:i.parsedType}),L}if(Number.isNaN(e.data.getTime())){const i=this._getOrReturnCtx(e);return x(i,{code:w.invalid_date}),L}const r=new _e;let a;for(const i of this._def.checks)i.kind==="min"?e.data.getTime()<i.value&&(a=this._getOrReturnCtx(e,a),x(a,{code:w.too_small,message:i.message,inclusive:!0,exact:!1,minimum:i.value,type:"date"}),r.dirty()):i.kind==="max"?e.data.getTime()>i.value&&(a=this._getOrReturnCtx(e,a),x(a,{code:w.too_big,message:i.message,inclusive:!0,exact:!1,maximum:i.value,type:"date"}),r.dirty()):z.assertNever(i);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new ur({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:R.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:R.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}}ur.create=n=>new ur({checks:[],coerce:n?.coerce||!1,typeName:v.ZodDate,...V(n)});class pi extends H{_parse(e){if(this._getType(e)!==A.symbol){const r=this._getOrReturnCtx(e);return x(r,{code:w.invalid_type,expected:A.symbol,received:r.parsedType}),L}return xe(e.data)}}pi.create=n=>new pi({typeName:v.ZodSymbol,...V(n)});class mi extends H{_parse(e){if(this._getType(e)!==A.undefined){const r=this._getOrReturnCtx(e);return x(r,{code:w.invalid_type,expected:A.undefined,received:r.parsedType}),L}return xe(e.data)}}mi.create=n=>new mi({typeName:v.ZodUndefined,...V(n)});class gi extends H{_parse(e){if(this._getType(e)!==A.null){const r=this._getOrReturnCtx(e);return x(r,{code:w.invalid_type,expected:A.null,received:r.parsedType}),L}return xe(e.data)}}gi.create=n=>new gi({typeName:v.ZodNull,...V(n)});class Wr extends H{constructor(){super(...arguments),this._any=!0}_parse(e){return xe(e.data)}}Wr.create=n=>new Wr({typeName:v.ZodAny,...V(n)});class yi extends H{constructor(){super(...arguments),this._unknown=!0}_parse(e){return xe(e.data)}}yi.create=n=>new yi({typeName:v.ZodUnknown,...V(n)});class We extends H{_parse(e){const t=this._getOrReturnCtx(e);return x(t,{code:w.invalid_type,expected:A.never,received:t.parsedType}),L}}We.create=n=>new We({typeName:v.ZodNever,...V(n)});class bi extends H{_parse(e){if(this._getType(e)!==A.undefined){const r=this._getOrReturnCtx(e);return x(r,{code:w.invalid_type,expected:A.void,received:r.parsedType}),L}return xe(e.data)}}bi.create=n=>new bi({typeName:v.ZodVoid,...V(n)});class je extends H{_parse(e){const{ctx:t,status:r}=this._processInputParams(e),a=this._def;if(t.parsedType!==A.array)return x(t,{code:w.invalid_type,expected:A.array,received:t.parsedType}),L;if(a.exactLength!==null){const s=t.data.length>a.exactLength.value,o=t.data.length<a.exactLength.value;(s||o)&&(x(t,{code:s?w.too_big:w.too_small,minimum:o?a.exactLength.value:void 0,maximum:s?a.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:a.exactLength.message}),r.dirty())}if(a.minLength!==null&&t.data.length<a.minLength.value&&(x(t,{code:w.too_small,minimum:a.minLength.value,type:"array",inclusive:!0,exact:!1,message:a.minLength.message}),r.dirty()),a.maxLength!==null&&t.data.length>a.maxLength.value&&(x(t,{code:w.too_big,maximum:a.maxLength.value,type:"array",inclusive:!0,exact:!1,message:a.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map((s,o)=>a.type._parseAsync(new Ze(t,s,t.path,o)))).then(s=>_e.mergeArray(r,s));const i=[...t.data].map((s,o)=>a.type._parseSync(new Ze(t,s,t.path,o)));return _e.mergeArray(r,i)}get element(){return this._def.type}min(e,t){return new je({...this._def,minLength:{value:e,message:R.toString(t)}})}max(e,t){return new je({...this._def,maxLength:{value:e,message:R.toString(t)}})}length(e,t){return new je({...this._def,exactLength:{value:e,message:R.toString(t)}})}nonempty(e){return this.min(1,e)}}je.create=(n,e)=>new je({type:n,minLength:null,maxLength:null,exactLength:null,typeName:v.ZodArray,...V(e)});function ft(n){if(n instanceof X){const e={};for(const t in n.shape){const r=n.shape[t];e[t]=Be.create(ft(r))}return new X({...n._def,shape:()=>e})}else return n instanceof je?new je({...n._def,type:ft(n.element)}):n instanceof Be?Be.create(ft(n.unwrap())):n instanceof gt?gt.create(ft(n.unwrap())):n instanceof it?it.create(n.items.map(e=>ft(e))):n}class X extends H{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),t=z.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==A.object){const l=this._getOrReturnCtx(e);return x(l,{code:w.invalid_type,expected:A.object,received:l.parsedType}),L}const{status:r,ctx:a}=this._processInputParams(e),{shape:i,keys:s}=this._getCached(),o=[];if(!(this._def.catchall instanceof We&&this._def.unknownKeys==="strip"))for(const l in a.data)s.includes(l)||o.push(l);const u=[];for(const l of s){const c=i[l],h=a.data[l];u.push({key:{status:"valid",value:l},value:c._parse(new Ze(a,h,a.path,l)),alwaysSet:l in a.data})}if(this._def.catchall instanceof We){const l=this._def.unknownKeys;if(l==="passthrough")for(const c of o)u.push({key:{status:"valid",value:c},value:{status:"valid",value:a.data[c]}});else if(l==="strict")o.length>0&&(x(a,{code:w.unrecognized_keys,keys:o}),r.dirty());else if(l!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const l=this._def.catchall;for(const c of o){const h=a.data[c];u.push({key:{status:"valid",value:c},value:l._parse(new Ze(a,h,a.path,c)),alwaysSet:c in a.data})}}return a.common.async?Promise.resolve().then(async()=>{const l=[];for(const c of u){const h=await c.key,d=await c.value;l.push({key:h,value:d,alwaysSet:c.alwaysSet})}return l}).then(l=>_e.mergeObjectSync(r,l)):_e.mergeObjectSync(r,u)}get shape(){return this._def.shape()}strict(e){return R.errToObj,new X({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,r)=>{const a=this._def.errorMap?.(t,r).message??r.defaultError;return t.code==="unrecognized_keys"?{message:R.errToObj(e).message??a}:{message:a}}}:{}})}strip(){return new X({...this._def,unknownKeys:"strip"})}passthrough(){return new X({...this._def,unknownKeys:"passthrough"})}extend(e){return new X({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new X({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:v.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new X({...this._def,catchall:e})}pick(e){const t={};for(const r of z.objectKeys(e))e[r]&&this.shape[r]&&(t[r]=this.shape[r]);return new X({...this._def,shape:()=>t})}omit(e){const t={};for(const r of z.objectKeys(this.shape))e[r]||(t[r]=this.shape[r]);return new X({...this._def,shape:()=>t})}deepPartial(){return ft(this)}partial(e){const t={};for(const r of z.objectKeys(this.shape)){const a=this.shape[r];e&&!e[r]?t[r]=a:t[r]=a.optional()}return new X({...this._def,shape:()=>t})}required(e){const t={};for(const r of z.objectKeys(this.shape))if(e&&!e[r])t[r]=this.shape[r];else{let i=this.shape[r];for(;i instanceof Be;)i=i._def.innerType;t[r]=i}return new X({...this._def,shape:()=>t})}keyof(){return Ei(z.objectKeys(this.shape))}}X.create=(n,e)=>new X({shape:()=>n,unknownKeys:"strip",catchall:We.create(),typeName:v.ZodObject,...V(e)}),X.strictCreate=(n,e)=>new X({shape:()=>n,unknownKeys:"strict",catchall:We.create(),typeName:v.ZodObject,...V(e)}),X.lazycreate=(n,e)=>new X({shape:n,unknownKeys:"strip",catchall:We.create(),typeName:v.ZodObject,...V(e)});class lr extends H{_parse(e){const{ctx:t}=this._processInputParams(e),r=this._def.options;function a(i){for(const o of i)if(o.result.status==="valid")return o.result;for(const o of i)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;const s=i.map(o=>new De(o.ctx.common.issues));return x(t,{code:w.invalid_union,unionErrors:s}),L}if(t.common.async)return Promise.all(r.map(async i=>{const s={...t,common:{...t.common,issues:[]},parent:null};return{result:await i._parseAsync({data:t.data,path:t.path,parent:s}),ctx:s}})).then(a);{let i;const s=[];for(const u of r){const l={...t,common:{...t.common,issues:[]},parent:null},c=u._parseSync({data:t.data,path:t.path,parent:l});if(c.status==="valid")return c;c.status==="dirty"&&!i&&(i={result:c,ctx:l}),l.common.issues.length&&s.push(l.common.issues)}if(i)return t.common.issues.push(...i.ctx.common.issues),i.result;const o=s.map(u=>new De(u));return x(t,{code:w.invalid_union,unionErrors:o}),L}}get options(){return this._def.options}}lr.create=(n,e)=>new lr({options:n,typeName:v.ZodUnion,...V(e)});function Jr(n,e){const t=Ge(n),r=Ge(e);if(n===e)return{valid:!0,data:n};if(t===A.object&&r===A.object){const a=z.objectKeys(e),i=z.objectKeys(n).filter(o=>a.indexOf(o)!==-1),s={...n,...e};for(const o of i){const u=Jr(n[o],e[o]);if(!u.valid)return{valid:!1};s[o]=u.data}return{valid:!0,data:s}}else if(t===A.array&&r===A.array){if(n.length!==e.length)return{valid:!1};const a=[];for(let i=0;i<n.length;i++){const s=n[i],o=e[i],u=Jr(s,o);if(!u.valid)return{valid:!1};a.push(u.data)}return{valid:!0,data:a}}else return t===A.date&&r===A.date&&+n==+e?{valid:!0,data:n}:{valid:!1}}class cr extends H{_parse(e){const{status:t,ctx:r}=this._processInputParams(e),a=(i,s)=>{if(ui(i)||ui(s))return L;const o=Jr(i.value,s.value);return o.valid?((li(i)||li(s))&&t.dirty(),{status:t.value,value:o.data}):(x(r,{code:w.invalid_intersection_types}),L)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([i,s])=>a(i,s)):a(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}}cr.create=(n,e,t)=>new cr({left:n,right:e,typeName:v.ZodIntersection,...V(t)});class it extends H{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==A.array)return x(r,{code:w.invalid_type,expected:A.array,received:r.parsedType}),L;if(r.data.length<this._def.items.length)return x(r,{code:w.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),L;!this._def.rest&&r.data.length>this._def.items.length&&(x(r,{code:w.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const i=[...r.data].map((s,o)=>{const u=this._def.items[o]||this._def.rest;return u?u._parse(new Ze(r,s,r.path,o)):null}).filter(s=>!!s);return r.common.async?Promise.all(i).then(s=>_e.mergeArray(t,s)):_e.mergeArray(t,i)}get items(){return this._def.items}rest(e){return new it({...this._def,rest:e})}}it.create=(n,e)=>{if(!Array.isArray(n))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new it({items:n,typeName:v.ZodTuple,rest:null,...V(e)})};class _i extends H{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==A.map)return x(r,{code:w.invalid_type,expected:A.map,received:r.parsedType}),L;const a=this._def.keyType,i=this._def.valueType,s=[...r.data.entries()].map(([o,u],l)=>({key:a._parse(new Ze(r,o,r.path,[l,"key"])),value:i._parse(new Ze(r,u,r.path,[l,"value"]))}));if(r.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const u of s){const l=await u.key,c=await u.value;if(l.status==="aborted"||c.status==="aborted")return L;(l.status==="dirty"||c.status==="dirty")&&t.dirty(),o.set(l.value,c.value)}return{status:t.value,value:o}})}else{const o=new Map;for(const u of s){const l=u.key,c=u.value;if(l.status==="aborted"||c.status==="aborted")return L;(l.status==="dirty"||c.status==="dirty")&&t.dirty(),o.set(l.value,c.value)}return{status:t.value,value:o}}}}_i.create=(n,e,t)=>new _i({valueType:e,keyType:n,typeName:v.ZodMap,...V(t)});class Ct extends H{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==A.set)return x(r,{code:w.invalid_type,expected:A.set,received:r.parsedType}),L;const a=this._def;a.minSize!==null&&r.data.size<a.minSize.value&&(x(r,{code:w.too_small,minimum:a.minSize.value,type:"set",inclusive:!0,exact:!1,message:a.minSize.message}),t.dirty()),a.maxSize!==null&&r.data.size>a.maxSize.value&&(x(r,{code:w.too_big,maximum:a.maxSize.value,type:"set",inclusive:!0,exact:!1,message:a.maxSize.message}),t.dirty());const i=this._def.valueType;function s(u){const l=new Set;for(const c of u){if(c.status==="aborted")return L;c.status==="dirty"&&t.dirty(),l.add(c.value)}return{status:t.value,value:l}}const o=[...r.data.values()].map((u,l)=>i._parse(new Ze(r,u,r.path,l)));return r.common.async?Promise.all(o).then(u=>s(u)):s(o)}min(e,t){return new Ct({...this._def,minSize:{value:e,message:R.toString(t)}})}max(e,t){return new Ct({...this._def,maxSize:{value:e,message:R.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}Ct.create=(n,e)=>new Ct({valueType:n,minSize:null,maxSize:null,typeName:v.ZodSet,...V(e)});class wi extends H{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}wi.create=(n,e)=>new wi({getter:n,typeName:v.ZodLazy,...V(e)});class vi extends H{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return x(t,{received:t.data,code:w.invalid_literal,expected:this._def.value}),L}return{status:"valid",value:e.data}}get value(){return this._def.value}}vi.create=(n,e)=>new vi({value:n,typeName:v.ZodLiteral,...V(e)});function Ei(n,e){return new pt({values:n,typeName:v.ZodEnum,...V(e)})}class pt extends H{_parse(e){if(typeof e.data!="string"){const t=this._getOrReturnCtx(e),r=this._def.values;return x(t,{expected:z.joinValues(r),received:t.parsedType,code:w.invalid_type}),L}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const t=this._getOrReturnCtx(e),r=this._def.values;return x(t,{received:t.data,code:w.invalid_enum_value,options:r}),L}return xe(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return pt.create(e,{...this._def,...t})}exclude(e,t=this._def){return pt.create(this.options.filter(r=>!e.includes(r)),{...this._def,...t})}}pt.create=Ei;class Oi extends H{_parse(e){const t=z.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==A.string&&r.parsedType!==A.number){const a=z.objectValues(t);return x(r,{expected:z.joinValues(a),received:r.parsedType,code:w.invalid_type}),L}if(this._cache||(this._cache=new Set(z.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const a=z.objectValues(t);return x(r,{received:r.data,code:w.invalid_enum_value,options:a}),L}return xe(e.data)}get enum(){return this._def.values}}Oi.create=(n,e)=>new Oi({values:n,typeName:v.ZodNativeEnum,...V(e)});class dr extends H{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==A.promise&&t.common.async===!1)return x(t,{code:w.invalid_type,expected:A.promise,received:t.parsedType}),L;const r=t.parsedType===A.promise?t.data:Promise.resolve(t.data);return xe(r.then(a=>this._def.type.parseAsync(a,{path:t.path,errorMap:t.common.contextualErrorMap})))}}dr.create=(n,e)=>new dr({type:n,typeName:v.ZodPromise,...V(e)});class mt extends H{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===v.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:r}=this._processInputParams(e),a=this._def.effect||null,i={addIssue:s=>{x(r,s),s.fatal?t.abort():t.dirty()},get path(){return r.path}};if(i.addIssue=i.addIssue.bind(i),a.type==="preprocess"){const s=a.transform(r.data,i);if(r.common.async)return Promise.resolve(s).then(async o=>{if(t.value==="aborted")return L;const u=await this._def.schema._parseAsync({data:o,path:r.path,parent:r});return u.status==="aborted"?L:u.status==="dirty"||t.value==="dirty"?Rt(u.value):u});{if(t.value==="aborted")return L;const o=this._def.schema._parseSync({data:s,path:r.path,parent:r});return o.status==="aborted"?L:o.status==="dirty"||t.value==="dirty"?Rt(o.value):o}}if(a.type==="refinement"){const s=o=>{const u=a.refinement(o,i);if(r.common.async)return Promise.resolve(u);if(u instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(r.common.async===!1){const o=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return o.status==="aborted"?L:(o.status==="dirty"&&t.dirty(),s(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(o=>o.status==="aborted"?L:(o.status==="dirty"&&t.dirty(),s(o.value).then(()=>({status:t.value,value:o.value}))))}if(a.type==="transform")if(r.common.async===!1){const s=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!ht(s))return L;const o=a.transform(s.value,i);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(s=>ht(s)?Promise.resolve(a.transform(s.value,i)).then(o=>({status:t.value,value:o})):L);z.assertNever(a)}}mt.create=(n,e,t)=>new mt({schema:n,typeName:v.ZodEffects,effect:e,...V(t)}),mt.createWithPreprocess=(n,e,t)=>new mt({schema:e,effect:{type:"preprocess",transform:n},typeName:v.ZodEffects,...V(t)});class Be extends H{_parse(e){return this._getType(e)===A.undefined?xe(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Be.create=(n,e)=>new Be({innerType:n,typeName:v.ZodOptional,...V(e)});class gt extends H{_parse(e){return this._getType(e)===A.null?xe(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}gt.create=(n,e)=>new gt({innerType:n,typeName:v.ZodNullable,...V(e)});class Kr extends H{_parse(e){const{ctx:t}=this._processInputParams(e);let r=t.data;return t.parsedType===A.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}Kr.create=(n,e)=>new Kr({innerType:n,typeName:v.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...V(e)});class Xr extends H{_parse(e){const{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},a=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return or(a)?a.then(i=>({status:"valid",value:i.status==="valid"?i.value:this._def.catchValue({get error(){return new De(r.common.issues)},input:r.data})})):{status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new De(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}}Xr.create=(n,e)=>new Xr({innerType:n,typeName:v.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...V(e)});class xi extends H{_parse(e){if(this._getType(e)!==A.nan){const r=this._getOrReturnCtx(e);return x(r,{code:w.invalid_type,expected:A.nan,received:r.parsedType}),L}return{status:"valid",value:e.data}}}xi.create=n=>new xi({typeName:v.ZodNaN,...V(n)});class $u extends H{_parse(e){const{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}}class Yr extends H{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{const i=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return i.status==="aborted"?L:i.status==="dirty"?(t.dirty(),Rt(i.value)):this._def.out._parseAsync({data:i.value,path:r.path,parent:r})})();{const a=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return a.status==="aborted"?L:a.status==="dirty"?(t.dirty(),{status:"dirty",value:a.value}):this._def.out._parseSync({data:a.value,path:r.path,parent:r})}}static create(e,t){return new Yr({in:e,out:t,typeName:v.ZodPipeline})}}class Qr extends H{_parse(e){const t=this._def.innerType._parse(e),r=a=>(ht(a)&&(a.value=Object.freeze(a.value)),a);return or(t)?t.then(a=>r(a)):r(t)}unwrap(){return this._def.innerType}}Qr.create=(n,e)=>new Qr({innerType:n,typeName:v.ZodReadonly,...V(e)});var v;(function(n){n.ZodString="ZodString",n.ZodNumber="ZodNumber",n.ZodNaN="ZodNaN",n.ZodBigInt="ZodBigInt",n.ZodBoolean="ZodBoolean",n.ZodDate="ZodDate",n.ZodSymbol="ZodSymbol",n.ZodUndefined="ZodUndefined",n.ZodNull="ZodNull",n.ZodAny="ZodAny",n.ZodUnknown="ZodUnknown",n.ZodNever="ZodNever",n.ZodVoid="ZodVoid",n.ZodArray="ZodArray",n.ZodObject="ZodObject",n.ZodUnion="ZodUnion",n.ZodDiscriminatedUnion="ZodDiscriminatedUnion",n.ZodIntersection="ZodIntersection",n.ZodTuple="ZodTuple",n.ZodRecord="ZodRecord",n.ZodMap="ZodMap",n.ZodSet="ZodSet",n.ZodFunction="ZodFunction",n.ZodLazy="ZodLazy",n.ZodLiteral="ZodLiteral",n.ZodEnum="ZodEnum",n.ZodEffects="ZodEffects",n.ZodNativeEnum="ZodNativeEnum",n.ZodOptional="ZodOptional",n.ZodNullable="ZodNullable",n.ZodDefault="ZodDefault",n.ZodCatch="ZodCatch",n.ZodPromise="ZodPromise",n.ZodBranded="ZodBranded",n.ZodPipeline="ZodPipeline",n.ZodReadonly="ZodReadonly"})(v||(v={}));const ju=Ue.create,Si=Wr.create;We.create,je.create;const Nu=X.create;lr.create,cr.create,it.create,pt.create,dr.create,Be.create,gt.create;var $t={exports:{}},en={},tn,Ti;function Lu(){if(Ti)return tn;Ti=1;function n(e,t){typeof t=="boolean"&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}return tn=n,n.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},n.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},n.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=new Date().getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var r=this._timeouts.shift();if(r===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1);else return!1;var a=this;return this._timer=setTimeout(function(){a._attempts++,a._operationTimeoutCb&&(a._timeout=setTimeout(function(){a._operationTimeoutCb(a._attempts)},a._operationTimeout),a._options.unref&&a._timeout.unref()),a._fn(a._attempts)},r),this._options.unref&&this._timer.unref(),!0},n.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){r._operationTimeoutCb()},r._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},n.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},n.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},n.prototype.start=n.prototype.try,n.prototype.errors=function(){return this._errors},n.prototype.attempts=function(){return this._attempts},n.prototype.mainError=function(){if(this._errors.length===0)return null;for(var e={},t=null,r=0,a=0;a<this._errors.length;a++){var i=this._errors[a],s=i.message,o=(e[s]||0)+1;e[s]=o,o>=r&&(t=i,r=o)}return t},tn}var Pi;function Mu(){return Pi||(Pi=1,function(n){var e=Lu();n.operation=function(t){var r=n.timeouts(t);return new e(r,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},n.timeouts=function(t){if(t instanceof Array)return[].concat(t);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var a in t)r[a]=t[a];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],s=0;s<r.retries;s++)i.push(this.createTimeout(s,r));return t&&t.forever&&!i.length&&i.push(this.createTimeout(s,r)),i.sort(function(o,u){return o-u}),i},n.createTimeout=function(t,r){var a=r.randomize?Math.random()+1:1,i=Math.round(a*Math.max(r.minTimeout,1)*Math.pow(r.factor,t));return i=Math.min(i,r.maxTimeout),i},n.wrap=function(t,r,a){if(r instanceof Array&&(a=r,r=null),!a){a=[];for(var i in t)typeof t[i]=="function"&&a.push(i)}for(var s=0;s<a.length;s++){var o=a[s],u=t[o];t[o]=function(c){var h=n.operation(r),d=Array.prototype.slice.call(arguments,1),f=d.pop();d.push(function(p){h.retry(p)||(p&&(arguments[0]=h.mainError()),f.apply(this,arguments))}),h.attempt(function(){c.apply(t,d)})}.bind(t,u),t[o].options=r}}}(en)),en}var rn,Ai;function Fu(){return Ai||(Ai=1,rn=Mu()),rn}var Ri;function Du(){if(Ri)return $t.exports;Ri=1;const n=Fu(),e=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class t extends Error{constructor(o){super(),o instanceof Error?(this.originalError=o,{message:o}=o):(this.originalError=new Error(o),this.originalError.stack=this.stack),this.name="AbortError",this.message=o}}const r=(s,o,u)=>{const l=u.retries-(o-1);return s.attemptNumber=o,s.retriesLeft=l,s},a=s=>e.includes(s),i=(s,o)=>new Promise((u,l)=>{o={onFailedAttempt:()=>{},retries:10,...o};const c=n.operation(o);c.attempt(async h=>{try{u(await s(h))}catch(d){if(!(d instanceof Error)){l(new TypeError(`Non-error was thrown: "${d}". You should only throw errors.`));return}if(d instanceof t)c.stop(),l(d.originalError);else if(d instanceof TypeError&&!a(d.message))c.stop(),l(d);else{r(d,h,o);try{await o.onFailedAttempt(d)}catch(f){l(f);return}c.retry(d)||l(c.mainError())}}})});return $t.exports=i,$t.exports.default=i,$t.exports.AbortError=t,$t.exports}var Uu=Du(),hr=be(Uu),Bu=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function jt(n){return typeof n=="string"&&Bu.test(n)}for(var ie=[],nn=0;nn<256;++nn)ie.push((nn+256).toString(16).slice(1));function Vu(n,e=0){return(ie[n[e+0]]+ie[n[e+1]]+ie[n[e+2]]+ie[n[e+3]]+"-"+ie[n[e+4]]+ie[n[e+5]]+"-"+ie[n[e+6]]+ie[n[e+7]]+"-"+ie[n[e+8]]+ie[n[e+9]]+"-"+ie[n[e+10]]+ie[n[e+11]]+ie[n[e+12]]+ie[n[e+13]]+ie[n[e+14]]+ie[n[e+15]]).toLowerCase()}var fr,qu=new Uint8Array(16);function Hu(){if(!fr&&(fr=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!fr))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return fr(qu)}var zu=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Ii={randomUUID:zu};function ue(n,e,t){if(Ii.randomUUID&&!n)return Ii.randomUUID();n=n||{};var r=n.random||(n.rng||Hu)();return r[6]=r[6]&15|64,r[8]=r[8]&63|128,Vu(r)}var pr={},an={exports:{}},ki;function Gu(){return ki||(ki=1,function(n){var e=Object.prototype.hasOwnProperty,t="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(t=!1));function a(u,l,c){this.fn=u,this.context=l,this.once=c||!1}function i(u,l,c,h,d){if(typeof c!="function")throw new TypeError("The listener must be a function");var f=new a(c,h||u,d),p=t?t+l:l;return u._events[p]?u._events[p].fn?u._events[p]=[u._events[p],f]:u._events[p].push(f):(u._events[p]=f,u._eventsCount++),u}function s(u,l){--u._eventsCount===0?u._events=new r:delete u._events[l]}function o(){this._events=new r,this._eventsCount=0}o.prototype.eventNames=function(){var l=[],c,h;if(this._eventsCount===0)return l;for(h in c=this._events)e.call(c,h)&&l.push(t?h.slice(1):h);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(c)):l},o.prototype.listeners=function(l){var c=t?t+l:l,h=this._events[c];if(!h)return[];if(h.fn)return[h.fn];for(var d=0,f=h.length,p=new Array(f);d<f;d++)p[d]=h[d].fn;return p},o.prototype.listenerCount=function(l){var c=t?t+l:l,h=this._events[c];return h?h.fn?1:h.length:0},o.prototype.emit=function(l,c,h,d,f,p){var m=t?t+l:l;if(!this._events[m])return!1;var g=this._events[m],y=arguments.length,_,b;if(g.fn){switch(g.once&&this.removeListener(l,g.fn,void 0,!0),y){case 1:return g.fn.call(g.context),!0;case 2:return g.fn.call(g.context,c),!0;case 3:return g.fn.call(g.context,c,h),!0;case 4:return g.fn.call(g.context,c,h,d),!0;case 5:return g.fn.call(g.context,c,h,d,f),!0;case 6:return g.fn.call(g.context,c,h,d,f,p),!0}for(b=1,_=new Array(y-1);b<y;b++)_[b-1]=arguments[b];g.fn.apply(g.context,_)}else{var P=g.length,E;for(b=0;b<P;b++)switch(g[b].once&&this.removeListener(l,g[b].fn,void 0,!0),y){case 1:g[b].fn.call(g[b].context);break;case 2:g[b].fn.call(g[b].context,c);break;case 3:g[b].fn.call(g[b].context,c,h);break;case 4:g[b].fn.call(g[b].context,c,h,d);break;default:if(!_)for(E=1,_=new Array(y-1);E<y;E++)_[E-1]=arguments[E];g[b].fn.apply(g[b].context,_)}}return!0},o.prototype.on=function(l,c,h){return i(this,l,c,h,!1)},o.prototype.once=function(l,c,h){return i(this,l,c,h,!0)},o.prototype.removeListener=function(l,c,h,d){var f=t?t+l:l;if(!this._events[f])return this;if(!c)return s(this,f),this;var p=this._events[f];if(p.fn)p.fn===c&&(!d||p.once)&&(!h||p.context===h)&&s(this,f);else{for(var m=0,g=[],y=p.length;m<y;m++)(p[m].fn!==c||d&&!p[m].once||h&&p[m].context!==h)&&g.push(p[m]);g.length?this._events[f]=g.length===1?g[0]:g:s(this,f)}return this},o.prototype.removeAllListeners=function(l){var c;return l?(c=t?t+l:l,this._events[c]&&s(this,c)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=t,o.EventEmitter=o,n.exports=o}(an)),an.exports}var Nt={exports:{}},sn,Ci;function Zu(){return Ci||(Ci=1,sn=(n,e)=>(e=e||(()=>{}),n.then(t=>new Promise(r=>{r(e())}).then(()=>t),t=>new Promise(r=>{r(e())}).then(()=>{throw t})))),sn}var $i;function Wu(){if($i)return Nt.exports;$i=1;const n=Zu();class e extends Error{constructor(a){super(a),this.name="TimeoutError"}}const t=(r,a,i)=>new Promise((s,o)=>{if(typeof a!="number"||a<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(a===1/0){s(r);return}const u=setTimeout(()=>{if(typeof i=="function"){try{s(i())}catch(h){o(h)}return}const l=typeof i=="string"?i:`Promise timed out after ${a} milliseconds`,c=i instanceof Error?i:new e(l);typeof r.cancel=="function"&&r.cancel(),o(c)},a);n(r.then(s,o),()=>{clearTimeout(u)})});return Nt.exports=t,Nt.exports.default=t,Nt.exports.TimeoutError=e,Nt.exports}var mr={},gr={},ji;function Ju(){if(ji)return gr;ji=1,Object.defineProperty(gr,"__esModule",{value:!0});function n(e,t,r){let a=0,i=e.length;for(;i>0;){const s=i/2|0;let o=a+s;r(e[o],t)<=0?(a=++o,i-=s+1):i=s}return a}return gr.default=n,gr}var Ni;function Ku(){if(Ni)return mr;Ni=1,Object.defineProperty(mr,"__esModule",{value:!0});const n=Ju();class e{constructor(){this._queue=[]}enqueue(r,a){a=Object.assign({priority:0},a);const i={priority:a.priority,run:r};if(this.size&&this._queue[this.size-1].priority>=a.priority){this._queue.push(i);return}const s=n.default(this._queue,i,(o,u)=>u.priority-o.priority);this._queue.splice(s,0,i)}dequeue(){const r=this._queue.shift();return r?.run}filter(r){return this._queue.filter(a=>a.priority===r.priority).map(a=>a.run)}get size(){return this._queue.length}}return mr.default=e,mr}var Li;function Xu(){if(Li)return pr;Li=1,Object.defineProperty(pr,"__esModule",{value:!0});const n=Gu(),e=Wu(),t=Ku(),r=()=>{},a=new e.TimeoutError;class i extends n{constructor(o){var u,l,c,h;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=r,this._resolveIdle=r,o=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:t.default},o),!(typeof o.intervalCap=="number"&&o.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(l=(u=o.intervalCap)===null||u===void 0?void 0:u.toString())!==null&&l!==void 0?l:""}\` (${typeof o.intervalCap})`);if(o.interval===void 0||!(Number.isFinite(o.interval)&&o.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(h=(c=o.interval)===null||c===void 0?void 0:c.toString())!==null&&h!==void 0?h:""}\` (${typeof o.interval})`);this._carryoverConcurrencyCount=o.carryoverConcurrencyCount,this._isIntervalIgnored=o.intervalCap===1/0||o.interval===0,this._intervalCap=o.intervalCap,this._interval=o.interval,this._queue=new o.queueClass,this._queueClass=o.queueClass,this.concurrency=o.concurrency,this._timeout=o.timeout,this._throwOnTimeout=o.throwOnTimeout===!0,this._isPaused=o.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=r,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=r,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const o=Date.now();if(this._intervalId===void 0){const u=this._intervalEnd-o;if(u<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},u)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const o=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const u=this._queue.dequeue();return u?(this.emit("active"),u(),o&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(o){if(!(typeof o=="number"&&o>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${o}\` (${typeof o})`);this._concurrency=o,this._processQueue()}async add(o,u={}){return new Promise((l,c)=>{const h=async()=>{this._pendingCount++,this._intervalCount++;try{const d=this._timeout===void 0&&u.timeout===void 0?o():e.default(Promise.resolve(o()),u.timeout===void 0?this._timeout:u.timeout,()=>{(u.throwOnTimeout===void 0?this._throwOnTimeout:u.throwOnTimeout)&&c(a)});l(await d)}catch(d){c(d)}this._next()};this._queue.enqueue(h,u),this._tryToStartAnother(),this.emit("add")})}async addAll(o,u){return Promise.all(o.map(async l=>this.add(l,u)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(o=>{const u=this._resolveEmpty;this._resolveEmpty=()=>{u(),o()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(o=>{const u=this._resolveIdle;this._resolveIdle=()=>{u(),o()}})}get size(){return this._queue.size}sizeBy(o){return this._queue.filter(o).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(o){this._timeout=o}}return pr.default=i,pr}var Yu=Xu(),Ve=be(Yu);const Qu=(...n)=>fetch(...n),Mi=Symbol.for("ls:fetch_implementation"),el=()=>{const n=globalThis[Mi];return n?typeof n=="function"&&"Headers"in n&&"Request"in n&&"Response"in n:!1},I=n=>async(...e)=>{if(n||Ne("DEBUG")==="true"){const[r,a]=e;console.log(`→ ${a?.method||"GET"} ${r}`)}const t=await(globalThis[Mi]??Qu)(...e);return(n||Ne("DEBUG")==="true")&&console.log(`← ${t.status} ${t.statusText} ${t.url}`),t},tl=[400,401,403,404,405,406,407,408],rl=[409];let Fi=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.debug=e.debug,"default"in Ve?this.queue=new Ve.default({concurrency:this.maxConcurrency}):this.queue=new Ve({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){const r=this.onFailedResponseHook;return this.queue.add(()=>hr(()=>e(...t).catch(a=>{throw a instanceof Error?a:new Error(a)}),{async onFailedAttempt(a){if(a.message.startsWith("Cancel")||a.message.startsWith("TimeoutError")||a.message.startsWith("AbortError")||a?.code==="ECONNABORTED")throw a;const i=a?.response,s=i?.status;if(s){if(tl.includes(+s))throw a;if(rl.includes(+s))return;r&&await r(i)}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,i)=>{e.signal?.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>I(this.debug)(...e).then(t=>t.ok?t:Promise.reject(t)))}};function Di(n){return typeof n?._getType=="function"}function Ui(n){const e={type:n._getType(),data:{content:n.content}};return n?.additional_kwargs&&Object.keys(n.additional_kwargs).length>0&&(e.data.additional_kwargs={...n.additional_kwargs}),e}function F(n,e){if(!jt(n)){const t=e!==void 0?`Invalid UUID for ${e}: ${n}`:`Invalid UUID: ${n}`;throw new Error(t)}return n}const Bi={};function Vi(n){Bi[n]||(console.warn(n),Bi[n]=!0)}var yr={exports:{}},on,qi;function br(){if(qi)return on;qi=1;const n="2.0.0",e=256,t=Number.MAX_SAFE_INTEGER||9007199254740991,r=16,a=e-6;return on={MAX_LENGTH:e,MAX_SAFE_COMPONENT_LENGTH:r,MAX_SAFE_BUILD_LENGTH:a,MAX_SAFE_INTEGER:t,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:n,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2},on}var un,Hi;function _r(){if(Hi)return un;Hi=1;var n={};return un=typeof process=="object"&&n&&n.NODE_DEBUG&&/\bsemver\b/i.test(n.NODE_DEBUG)?(...t)=>console.error("SEMVER",...t):()=>{},un}var zi;function Lt(){return zi||(zi=1,function(n,e){const{MAX_SAFE_COMPONENT_LENGTH:t,MAX_SAFE_BUILD_LENGTH:r,MAX_LENGTH:a}=br(),i=_r();e=n.exports={};const s=e.re=[],o=e.safeRe=[],u=e.src=[],l=e.safeSrc=[],c=e.t={};let h=0;const d="[a-zA-Z0-9-]",f=[["\\s",1],["\\d",a],[d,r]],p=g=>{for(const[y,_]of f)g=g.split(`${y}*`).join(`${y}{0,${_}}`).split(`${y}+`).join(`${y}{1,${_}}`);return g},m=(g,y,_)=>{const b=p(y),P=h++;i(g,P,y),c[g]=P,u[P]=y,l[P]=b,s[P]=new RegExp(y,_?"g":void 0),o[P]=new RegExp(b,_?"g":void 0)};m("NUMERICIDENTIFIER","0|[1-9]\\d*"),m("NUMERICIDENTIFIERLOOSE","\\d+"),m("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${d}*`),m("MAINVERSION",`(${u[c.NUMERICIDENTIFIER]})\\.(${u[c.NUMERICIDENTIFIER]})\\.(${u[c.NUMERICIDENTIFIER]})`),m("MAINVERSIONLOOSE",`(${u[c.NUMERICIDENTIFIERLOOSE]})\\.(${u[c.NUMERICIDENTIFIERLOOSE]})\\.(${u[c.NUMERICIDENTIFIERLOOSE]})`),m("PRERELEASEIDENTIFIER",`(?:${u[c.NONNUMERICIDENTIFIER]}|${u[c.NUMERICIDENTIFIER]})`),m("PRERELEASEIDENTIFIERLOOSE",`(?:${u[c.NONNUMERICIDENTIFIER]}|${u[c.NUMERICIDENTIFIERLOOSE]})`),m("PRERELEASE",`(?:-(${u[c.PRERELEASEIDENTIFIER]}(?:\\.${u[c.PRERELEASEIDENTIFIER]})*))`),m("PRERELEASELOOSE",`(?:-?(${u[c.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${u[c.PRERELEASEIDENTIFIERLOOSE]})*))`),m("BUILDIDENTIFIER",`${d}+`),m("BUILD",`(?:\\+(${u[c.BUILDIDENTIFIER]}(?:\\.${u[c.BUILDIDENTIFIER]})*))`),m("FULLPLAIN",`v?${u[c.MAINVERSION]}${u[c.PRERELEASE]}?${u[c.BUILD]}?`),m("FULL",`^${u[c.FULLPLAIN]}$`),m("LOOSEPLAIN",`[v=\\s]*${u[c.MAINVERSIONLOOSE]}${u[c.PRERELEASELOOSE]}?${u[c.BUILD]}?`),m("LOOSE",`^${u[c.LOOSEPLAIN]}$`),m("GTLT","((?:<|>)?=?)"),m("XRANGEIDENTIFIERLOOSE",`${u[c.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),m("XRANGEIDENTIFIER",`${u[c.NUMERICIDENTIFIER]}|x|X|\\*`),m("XRANGEPLAIN",`[v=\\s]*(${u[c.XRANGEIDENTIFIER]})(?:\\.(${u[c.XRANGEIDENTIFIER]})(?:\\.(${u[c.XRANGEIDENTIFIER]})(?:${u[c.PRERELEASE]})?${u[c.BUILD]}?)?)?`),m("XRANGEPLAINLOOSE",`[v=\\s]*(${u[c.XRANGEIDENTIFIERLOOSE]})(?:\\.(${u[c.XRANGEIDENTIFIERLOOSE]})(?:\\.(${u[c.XRANGEIDENTIFIERLOOSE]})(?:${u[c.PRERELEASELOOSE]})?${u[c.BUILD]}?)?)?`),m("XRANGE",`^${u[c.GTLT]}\\s*${u[c.XRANGEPLAIN]}$`),m("XRANGELOOSE",`^${u[c.GTLT]}\\s*${u[c.XRANGEPLAINLOOSE]}$`),m("COERCEPLAIN",`(^|[^\\d])(\\d{1,${t}})(?:\\.(\\d{1,${t}}))?(?:\\.(\\d{1,${t}}))?`),m("COERCE",`${u[c.COERCEPLAIN]}(?:$|[^\\d])`),m("COERCEFULL",u[c.COERCEPLAIN]+`(?:${u[c.PRERELEASE]})?(?:${u[c.BUILD]})?(?:$|[^\\d])`),m("COERCERTL",u[c.COERCE],!0),m("COERCERTLFULL",u[c.COERCEFULL],!0),m("LONETILDE","(?:~>?)"),m("TILDETRIM",`(\\s*)${u[c.LONETILDE]}\\s+`,!0),e.tildeTrimReplace="$1~",m("TILDE",`^${u[c.LONETILDE]}${u[c.XRANGEPLAIN]}$`),m("TILDELOOSE",`^${u[c.LONETILDE]}${u[c.XRANGEPLAINLOOSE]}$`),m("LONECARET","(?:\\^)"),m("CARETTRIM",`(\\s*)${u[c.LONECARET]}\\s+`,!0),e.caretTrimReplace="$1^",m("CARET",`^${u[c.LONECARET]}${u[c.XRANGEPLAIN]}$`),m("CARETLOOSE",`^${u[c.LONECARET]}${u[c.XRANGEPLAINLOOSE]}$`),m("COMPARATORLOOSE",`^${u[c.GTLT]}\\s*(${u[c.LOOSEPLAIN]})$|^$`),m("COMPARATOR",`^${u[c.GTLT]}\\s*(${u[c.FULLPLAIN]})$|^$`),m("COMPARATORTRIM",`(\\s*)${u[c.GTLT]}\\s*(${u[c.LOOSEPLAIN]}|${u[c.XRANGEPLAIN]})`,!0),e.comparatorTrimReplace="$1$2$3",m("HYPHENRANGE",`^\\s*(${u[c.XRANGEPLAIN]})\\s+-\\s+(${u[c.XRANGEPLAIN]})\\s*$`),m("HYPHENRANGELOOSE",`^\\s*(${u[c.XRANGEPLAINLOOSE]})\\s+-\\s+(${u[c.XRANGEPLAINLOOSE]})\\s*$`),m("STAR","(<|>)?=?\\s*\\*"),m("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),m("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")}(yr,yr.exports)),yr.exports}var ln,Gi;function cn(){if(Gi)return ln;Gi=1;const n=Object.freeze({loose:!0}),e=Object.freeze({});return ln=r=>r?typeof r!="object"?n:r:e,ln}var dn,Zi;function Wi(){if(Zi)return dn;Zi=1;const n=/^[0-9]+$/,e=(r,a)=>{const i=n.test(r),s=n.test(a);return i&&s&&(r=+r,a=+a),r===a?0:i&&!s?-1:s&&!i?1:r<a?-1:1};return dn={compareIdentifiers:e,rcompareIdentifiers:(r,a)=>e(a,r)},dn}var hn,Ji;function le(){if(Ji)return hn;Ji=1;const n=_r(),{MAX_LENGTH:e,MAX_SAFE_INTEGER:t}=br(),{safeRe:r,t:a}=Lt(),i=cn(),{compareIdentifiers:s}=Wi();class o{constructor(l,c){if(c=i(c),l instanceof o){if(l.loose===!!c.loose&&l.includePrerelease===!!c.includePrerelease)return l;l=l.version}else if(typeof l!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof l}".`);if(l.length>e)throw new TypeError(`version is longer than ${e} characters`);n("SemVer",l,c),this.options=c,this.loose=!!c.loose,this.includePrerelease=!!c.includePrerelease;const h=l.trim().match(c.loose?r[a.LOOSE]:r[a.FULL]);if(!h)throw new TypeError(`Invalid Version: ${l}`);if(this.raw=l,this.major=+h[1],this.minor=+h[2],this.patch=+h[3],this.major>t||this.major<0)throw new TypeError("Invalid major version");if(this.minor>t||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>t||this.patch<0)throw new TypeError("Invalid patch version");h[4]?this.prerelease=h[4].split(".").map(d=>{if(/^[0-9]+$/.test(d)){const f=+d;if(f>=0&&f<t)return f}return d}):this.prerelease=[],this.build=h[5]?h[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(l){if(n("SemVer.compare",this.version,this.options,l),!(l instanceof o)){if(typeof l=="string"&&l===this.version)return 0;l=new o(l,this.options)}return l.version===this.version?0:this.compareMain(l)||this.comparePre(l)}compareMain(l){return l instanceof o||(l=new o(l,this.options)),s(this.major,l.major)||s(this.minor,l.minor)||s(this.patch,l.patch)}comparePre(l){if(l instanceof o||(l=new o(l,this.options)),this.prerelease.length&&!l.prerelease.length)return-1;if(!this.prerelease.length&&l.prerelease.length)return 1;if(!this.prerelease.length&&!l.prerelease.length)return 0;let c=0;do{const h=this.prerelease[c],d=l.prerelease[c];if(n("prerelease compare",c,h,d),h===void 0&&d===void 0)return 0;if(d===void 0)return 1;if(h===void 0)return-1;if(h===d)continue;return s(h,d)}while(++c)}compareBuild(l){l instanceof o||(l=new o(l,this.options));let c=0;do{const h=this.build[c],d=l.build[c];if(n("build compare",c,h,d),h===void 0&&d===void 0)return 0;if(d===void 0)return 1;if(h===void 0)return-1;if(h===d)continue;return s(h,d)}while(++c)}inc(l,c,h){if(l.startsWith("pre")){if(!c&&h===!1)throw new Error("invalid increment argument: identifier is empty");if(c){const d=`-${c}`.match(this.options.loose?r[a.PRERELEASELOOSE]:r[a.PRERELEASE]);if(!d||d[1]!==c)throw new Error(`invalid identifier: ${c}`)}}switch(l){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",c,h);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",c,h);break;case"prepatch":this.prerelease.length=0,this.inc("patch",c,h),this.inc("pre",c,h);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",c,h),this.inc("pre",c,h);break;case"release":if(this.prerelease.length===0)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{const d=Number(h)?1:0;if(this.prerelease.length===0)this.prerelease=[d];else{let f=this.prerelease.length;for(;--f>=0;)typeof this.prerelease[f]=="number"&&(this.prerelease[f]++,f=-2);if(f===-1){if(c===this.prerelease.join(".")&&h===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(d)}}if(c){let f=[c,d];h===!1&&(f=[c]),s(this.prerelease[0],c)===0?isNaN(this.prerelease[1])&&(this.prerelease=f):this.prerelease=f}break}default:throw new Error(`invalid increment argument: ${l}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}return hn=o,hn}var fn,Ki;function yt(){if(Ki)return fn;Ki=1;const n=le();return fn=(t,r,a=!1)=>{if(t instanceof n)return t;try{return new n(t,r)}catch(i){if(!a)return null;throw i}},fn}var pn,Xi;function nl(){if(Xi)return pn;Xi=1;const n=yt();return pn=(t,r)=>{const a=n(t,r);return a?a.version:null},pn}var mn,Yi;function al(){if(Yi)return mn;Yi=1;const n=yt();return mn=(t,r)=>{const a=n(t.trim().replace(/^[=v]+/,""),r);return a?a.version:null},mn}var gn,Qi;function il(){if(Qi)return gn;Qi=1;const n=le();return gn=(t,r,a,i,s)=>{typeof a=="string"&&(s=i,i=a,a=void 0);try{return new n(t instanceof n?t.version:t,a).inc(r,i,s).version}catch{return null}},gn}var yn,es;function sl(){if(es)return yn;es=1;const n=yt();return yn=(t,r)=>{const a=n(t,null,!0),i=n(r,null,!0),s=a.compare(i);if(s===0)return null;const o=s>0,u=o?a:i,l=o?i:a,c=!!u.prerelease.length;if(!!l.prerelease.length&&!c){if(!l.patch&&!l.minor)return"major";if(l.compareMain(u)===0)return l.minor&&!l.patch?"minor":"patch"}const d=c?"pre":"";return a.major!==i.major?d+"major":a.minor!==i.minor?d+"minor":a.patch!==i.patch?d+"patch":"prerelease"},yn}var bn,ts;function ol(){if(ts)return bn;ts=1;const n=le();return bn=(t,r)=>new n(t,r).major,bn}var _n,rs;function ul(){if(rs)return _n;rs=1;const n=le();return _n=(t,r)=>new n(t,r).minor,_n}var wn,ns;function ll(){if(ns)return wn;ns=1;const n=le();return wn=(t,r)=>new n(t,r).patch,wn}var vn,as;function cl(){if(as)return vn;as=1;const n=yt();return vn=(t,r)=>{const a=n(t,r);return a&&a.prerelease.length?a.prerelease:null},vn}var En,is;function Te(){if(is)return En;is=1;const n=le();return En=(t,r,a)=>new n(t,a).compare(new n(r,a)),En}var On,ss;function dl(){if(ss)return On;ss=1;const n=Te();return On=(t,r,a)=>n(r,t,a),On}var xn,os;function hl(){if(os)return xn;os=1;const n=Te();return xn=(t,r)=>n(t,r,!0),xn}var Sn,us;function Tn(){if(us)return Sn;us=1;const n=le();return Sn=(t,r,a)=>{const i=new n(t,a),s=new n(r,a);return i.compare(s)||i.compareBuild(s)},Sn}var Pn,ls;function fl(){if(ls)return Pn;ls=1;const n=Tn();return Pn=(t,r)=>t.sort((a,i)=>n(a,i,r)),Pn}var An,cs;function pl(){if(cs)return An;cs=1;const n=Tn();return An=(t,r)=>t.sort((a,i)=>n(i,a,r)),An}var Rn,ds;function wr(){if(ds)return Rn;ds=1;const n=Te();return Rn=(t,r,a)=>n(t,r,a)>0,Rn}var In,hs;function kn(){if(hs)return In;hs=1;const n=Te();return In=(t,r,a)=>n(t,r,a)<0,In}var Cn,fs;function ps(){if(fs)return Cn;fs=1;const n=Te();return Cn=(t,r,a)=>n(t,r,a)===0,Cn}var $n,ms;function gs(){if(ms)return $n;ms=1;const n=Te();return $n=(t,r,a)=>n(t,r,a)!==0,$n}var jn,ys;function Nn(){if(ys)return jn;ys=1;const n=Te();return jn=(t,r,a)=>n(t,r,a)>=0,jn}var Ln,bs;function Mn(){if(bs)return Ln;bs=1;const n=Te();return Ln=(t,r,a)=>n(t,r,a)<=0,Ln}var Fn,_s;function ws(){if(_s)return Fn;_s=1;const n=ps(),e=gs(),t=wr(),r=Nn(),a=kn(),i=Mn();return Fn=(o,u,l,c)=>{switch(u){case"===":return typeof o=="object"&&(o=o.version),typeof l=="object"&&(l=l.version),o===l;case"!==":return typeof o=="object"&&(o=o.version),typeof l=="object"&&(l=l.version),o!==l;case"":case"=":case"==":return n(o,l,c);case"!=":return e(o,l,c);case">":return t(o,l,c);case">=":return r(o,l,c);case"<":return a(o,l,c);case"<=":return i(o,l,c);default:throw new TypeError(`Invalid operator: ${u}`)}},Fn}var Dn,vs;function ml(){if(vs)return Dn;vs=1;const n=le(),e=yt(),{safeRe:t,t:r}=Lt();return Dn=(i,s)=>{if(i instanceof n)return i;if(typeof i=="number"&&(i=String(i)),typeof i!="string")return null;s=s||{};let o=null;if(!s.rtl)o=i.match(s.includePrerelease?t[r.COERCEFULL]:t[r.COERCE]);else{const f=s.includePrerelease?t[r.COERCERTLFULL]:t[r.COERCERTL];let p;for(;(p=f.exec(i))&&(!o||o.index+o[0].length!==i.length);)(!o||p.index+p[0].length!==o.index+o[0].length)&&(o=p),f.lastIndex=p.index+p[1].length+p[2].length;f.lastIndex=-1}if(o===null)return null;const u=o[2],l=o[3]||"0",c=o[4]||"0",h=s.includePrerelease&&o[5]?`-${o[5]}`:"",d=s.includePrerelease&&o[6]?`+${o[6]}`:"";return e(`${u}.${l}.${c}${h}${d}`,s)},Dn}var Un,Es;function gl(){if(Es)return Un;Es=1;class n{constructor(){this.max=1e3,this.map=new Map}get(t){const r=this.map.get(t);if(r!==void 0)return this.map.delete(t),this.map.set(t,r),r}delete(t){return this.map.delete(t)}set(t,r){if(!this.delete(t)&&r!==void 0){if(this.map.size>=this.max){const i=this.map.keys().next().value;this.delete(i)}this.map.set(t,r)}return this}}return Un=n,Un}var Bn,Os;function Pe(){if(Os)return Bn;Os=1;const n=/\s+/g;class e{constructor(O,j){if(j=a(j),O instanceof e)return O.loose===!!j.loose&&O.includePrerelease===!!j.includePrerelease?O:new e(O.raw,j);if(O instanceof i)return this.raw=O.value,this.set=[[O]],this.formatted=void 0,this;if(this.options=j,this.loose=!!j.loose,this.includePrerelease=!!j.includePrerelease,this.raw=O.trim().replace(n," "),this.set=this.raw.split("||").map(C=>this.parseRange(C.trim())).filter(C=>C.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const C=this.set[0];if(this.set=this.set.filter(N=>!m(N[0])),this.set.length===0)this.set=[C];else if(this.set.length>1){for(const N of this.set)if(N.length===1&&g(N[0])){this.set=[N];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let O=0;O<this.set.length;O++){O>0&&(this.formatted+="||");const j=this.set[O];for(let C=0;C<j.length;C++)C>0&&(this.formatted+=" "),this.formatted+=j[C].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(O){const C=((this.options.includePrerelease&&f)|(this.options.loose&&p))+":"+O,N=r.get(C);if(N)return N;const $=this.options.loose,D=$?u[l.HYPHENRANGELOOSE]:u[l.HYPHENRANGE];O=O.replace(D,Ya(this.options.includePrerelease)),s("hyphen replace",O),O=O.replace(u[l.COMPARATORTRIM],c),s("comparator trim",O),O=O.replace(u[l.TILDETRIM],h),s("tilde trim",O),O=O.replace(u[l.CARETTRIM],d),s("caret trim",O);let Z=O.split(" ").map(Q=>_(Q,this.options)).join(" ").split(/\s+/).map(Q=>Qt(Q,this.options));$&&(Z=Z.filter(Q=>(s("loose invalid filter",Q,this.options),!!Q.match(u[l.COMPARATORLOOSE])))),s("range list",Z);const q=new Map,K=Z.map(Q=>new i(Q,this.options));for(const Q of K){if(m(Q))return[Q];q.set(Q.value,Q)}q.size>1&&q.has("")&&q.delete("");const pe=[...q.values()];return r.set(C,pe),pe}intersects(O,j){if(!(O instanceof e))throw new TypeError("a Range is required");return this.set.some(C=>y(C,j)&&O.set.some(N=>y(N,j)&&C.every($=>N.every(D=>$.intersects(D,j)))))}test(O){if(!O)return!1;if(typeof O=="string")try{O=new o(O,this.options)}catch{return!1}for(let j=0;j<this.set.length;j++)if(Qa(this.set[j],O,this.options))return!0;return!1}}Bn=e;const t=gl(),r=new t,a=cn(),i=vr(),s=_r(),o=le(),{safeRe:u,t:l,comparatorTrimReplace:c,tildeTrimReplace:h,caretTrimReplace:d}=Lt(),{FLAG_INCLUDE_PRERELEASE:f,FLAG_LOOSE:p}=br(),m=T=>T.value==="<0.0.0-0",g=T=>T.value==="",y=(T,O)=>{let j=!0;const C=T.slice();let N=C.pop();for(;j&&C.length;)j=C.every($=>N.intersects($,O)),N=C.pop();return j},_=(T,O)=>(s("comp",T,O),T=k(T,O),s("caret",T),T=P(T,O),s("tildes",T),T=S(T,O),s("xrange",T),T=Yt(T,O),s("stars",T),T),b=T=>!T||T.toLowerCase()==="x"||T==="*",P=(T,O)=>T.trim().split(/\s+/).map(j=>E(j,O)).join(" "),E=(T,O)=>{const j=O.loose?u[l.TILDELOOSE]:u[l.TILDE];return T.replace(j,(C,N,$,D,Z)=>{s("tilde",T,C,N,$,D,Z);let q;return b(N)?q="":b($)?q=`>=${N}.0.0 <${+N+1}.0.0-0`:b(D)?q=`>=${N}.${$}.0 <${N}.${+$+1}.0-0`:Z?(s("replaceTilde pr",Z),q=`>=${N}.${$}.${D}-${Z} <${N}.${+$+1}.0-0`):q=`>=${N}.${$}.${D} <${N}.${+$+1}.0-0`,s("tilde return",q),q})},k=(T,O)=>T.trim().split(/\s+/).map(j=>M(j,O)).join(" "),M=(T,O)=>{s("caret",T,O);const j=O.loose?u[l.CARETLOOSE]:u[l.CARET],C=O.includePrerelease?"-0":"";return T.replace(j,(N,$,D,Z,q)=>{s("caret",T,N,$,D,Z,q);let K;return b($)?K="":b(D)?K=`>=${$}.0.0${C} <${+$+1}.0.0-0`:b(Z)?$==="0"?K=`>=${$}.${D}.0${C} <${$}.${+D+1}.0-0`:K=`>=${$}.${D}.0${C} <${+$+1}.0.0-0`:q?(s("replaceCaret pr",q),$==="0"?D==="0"?K=`>=${$}.${D}.${Z}-${q} <${$}.${D}.${+Z+1}-0`:K=`>=${$}.${D}.${Z}-${q} <${$}.${+D+1}.0-0`:K=`>=${$}.${D}.${Z}-${q} <${+$+1}.0.0-0`):(s("no pr"),$==="0"?D==="0"?K=`>=${$}.${D}.${Z}${C} <${$}.${D}.${+Z+1}-0`:K=`>=${$}.${D}.${Z}${C} <${$}.${+D+1}.0-0`:K=`>=${$}.${D}.${Z} <${+$+1}.0.0-0`),s("caret return",K),K})},S=(T,O)=>(s("replaceXRanges",T,O),T.split(/\s+/).map(j=>$e(j,O)).join(" ")),$e=(T,O)=>{T=T.trim();const j=O.loose?u[l.XRANGELOOSE]:u[l.XRANGE];return T.replace(j,(C,N,$,D,Z,q)=>{s("xRange",T,C,N,$,D,Z,q);const K=b($),pe=K||b(D),Q=pe||b(Z),er=Q;return N==="="&&er&&(N=""),q=O.includePrerelease?"-0":"",K?N===">"||N==="<"?C="<0.0.0-0":C="*":N&&er?(pe&&(D=0),Z=0,N===">"?(N=">=",pe?($=+$+1,D=0,Z=0):(D=+D+1,Z=0)):N==="<="&&(N="<",pe?$=+$+1:D=+D+1),N==="<"&&(q="-0"),C=`${N+$}.${D}.${Z}${q}`):pe?C=`>=${$}.0.0${q} <${+$+1}.0.0-0`:Q&&(C=`>=${$}.${D}.0${q} <${$}.${+D+1}.0-0`),s("xRange return",C),C})},Yt=(T,O)=>(s("replaceStars",T,O),T.trim().replace(u[l.STAR],"")),Qt=(T,O)=>(s("replaceGTE0",T,O),T.trim().replace(u[O.includePrerelease?l.GTE0PRE:l.GTE0],"")),Ya=T=>(O,j,C,N,$,D,Z,q,K,pe,Q,er)=>(b(C)?j="":b(N)?j=`>=${C}.0.0${T?"-0":""}`:b($)?j=`>=${C}.${N}.0${T?"-0":""}`:D?j=`>=${j}`:j=`>=${j}${T?"-0":""}`,b(K)?q="":b(pe)?q=`<${+K+1}.0.0-0`:b(Q)?q=`<${K}.${+pe+1}.0-0`:er?q=`<=${K}.${pe}.${Q}-${er}`:T?q=`<${K}.${pe}.${+Q+1}-0`:q=`<=${q}`,`${j} ${q}`.trim()),Qa=(T,O,j)=>{for(let C=0;C<T.length;C++)if(!T[C].test(O))return!1;if(O.prerelease.length&&!j.includePrerelease){for(let C=0;C<T.length;C++)if(s(T[C].semver),T[C].semver!==i.ANY&&T[C].semver.prerelease.length>0){const N=T[C].semver;if(N.major===O.major&&N.minor===O.minor&&N.patch===O.patch)return!0}return!1}return!0};return Bn}var Vn,xs;function vr(){if(xs)return Vn;xs=1;const n=Symbol("SemVer ANY");class e{static get ANY(){return n}constructor(c,h){if(h=t(h),c instanceof e){if(c.loose===!!h.loose)return c;c=c.value}c=c.trim().split(/\s+/).join(" "),s("comparator",c,h),this.options=h,this.loose=!!h.loose,this.parse(c),this.semver===n?this.value="":this.value=this.operator+this.semver.version,s("comp",this)}parse(c){const h=this.options.loose?r[a.COMPARATORLOOSE]:r[a.COMPARATOR],d=c.match(h);if(!d)throw new TypeError(`Invalid comparator: ${c}`);this.operator=d[1]!==void 0?d[1]:"",this.operator==="="&&(this.operator=""),d[2]?this.semver=new o(d[2],this.options.loose):this.semver=n}toString(){return this.value}test(c){if(s("Comparator.test",c,this.options.loose),this.semver===n||c===n)return!0;if(typeof c=="string")try{c=new o(c,this.options)}catch{return!1}return i(c,this.operator,this.semver,this.options)}intersects(c,h){if(!(c instanceof e))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new u(c.value,h).test(this.value):c.operator===""?c.value===""?!0:new u(this.value,h).test(c.semver):(h=t(h),h.includePrerelease&&(this.value==="<0.0.0-0"||c.value==="<0.0.0-0")||!h.includePrerelease&&(this.value.startsWith("<0.0.0")||c.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&c.operator.startsWith(">")||this.operator.startsWith("<")&&c.operator.startsWith("<")||this.semver.version===c.semver.version&&this.operator.includes("=")&&c.operator.includes("=")||i(this.semver,"<",c.semver,h)&&this.operator.startsWith(">")&&c.operator.startsWith("<")||i(this.semver,">",c.semver,h)&&this.operator.startsWith("<")&&c.operator.startsWith(">")))}}Vn=e;const t=cn(),{safeRe:r,t:a}=Lt(),i=ws(),s=_r(),o=le(),u=Pe();return Vn}var qn,Ss;function Er(){if(Ss)return qn;Ss=1;const n=Pe();return qn=(t,r,a)=>{try{r=new n(r,a)}catch{return!1}return r.test(t)},qn}var Hn,Ts;function yl(){if(Ts)return Hn;Ts=1;const n=Pe();return Hn=(t,r)=>new n(t,r).set.map(a=>a.map(i=>i.value).join(" ").trim().split(" ")),Hn}var zn,Ps;function bl(){if(Ps)return zn;Ps=1;const n=le(),e=Pe();return zn=(r,a,i)=>{let s=null,o=null,u=null;try{u=new e(a,i)}catch{return null}return r.forEach(l=>{u.test(l)&&(!s||o.compare(l)===-1)&&(s=l,o=new n(s,i))}),s},zn}var Gn,As;function _l(){if(As)return Gn;As=1;const n=le(),e=Pe();return Gn=(r,a,i)=>{let s=null,o=null,u=null;try{u=new e(a,i)}catch{return null}return r.forEach(l=>{u.test(l)&&(!s||o.compare(l)===1)&&(s=l,o=new n(s,i))}),s},Gn}var Zn,Rs;function wl(){if(Rs)return Zn;Rs=1;const n=le(),e=Pe(),t=wr();return Zn=(a,i)=>{a=new e(a,i);let s=new n("0.0.0");if(a.test(s)||(s=new n("0.0.0-0"),a.test(s)))return s;s=null;for(let o=0;o<a.set.length;++o){const u=a.set[o];let l=null;u.forEach(c=>{const h=new n(c.semver.version);switch(c.operator){case">":h.prerelease.length===0?h.patch++:h.prerelease.push(0),h.raw=h.format();case"":case">=":(!l||t(h,l))&&(l=h);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${c.operator}`)}}),l&&(!s||t(s,l))&&(s=l)}return s&&a.test(s)?s:null},Zn}var Wn,Is;function vl(){if(Is)return Wn;Is=1;const n=Pe();return Wn=(t,r)=>{try{return new n(t,r).range||"*"}catch{return null}},Wn}var Jn,ks;function Kn(){if(ks)return Jn;ks=1;const n=le(),e=vr(),{ANY:t}=e,r=Pe(),a=Er(),i=wr(),s=kn(),o=Mn(),u=Nn();return Jn=(c,h,d,f)=>{c=new n(c,f),h=new r(h,f);let p,m,g,y,_;switch(d){case">":p=i,m=o,g=s,y=">",_=">=";break;case"<":p=s,m=u,g=i,y="<",_="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(a(c,h,f))return!1;for(let b=0;b<h.set.length;++b){const P=h.set[b];let E=null,k=null;if(P.forEach(M=>{M.semver===t&&(M=new e(">=0.0.0")),E=E||M,k=k||M,p(M.semver,E.semver,f)?E=M:g(M.semver,k.semver,f)&&(k=M)}),E.operator===y||E.operator===_||(!k.operator||k.operator===y)&&m(c,k.semver))return!1;if(k.operator===_&&g(c,k.semver))return!1}return!0},Jn}var Xn,Cs;function El(){if(Cs)return Xn;Cs=1;const n=Kn();return Xn=(t,r,a)=>n(t,r,">",a),Xn}var Yn,$s;function Ol(){if($s)return Yn;$s=1;const n=Kn();return Yn=(t,r,a)=>n(t,r,"<",a),Yn}var Qn,js;function xl(){if(js)return Qn;js=1;const n=Pe();return Qn=(t,r,a)=>(t=new n(t,a),r=new n(r,a),t.intersects(r,a)),Qn}var ea,Ns;function Sl(){if(Ns)return ea;Ns=1;const n=Er(),e=Te();return ea=(t,r,a)=>{const i=[];let s=null,o=null;const u=t.sort((d,f)=>e(d,f,a));for(const d of u)n(d,r,a)?(o=d,s||(s=d)):(o&&i.push([s,o]),o=null,s=null);s&&i.push([s,null]);const l=[];for(const[d,f]of i)d===f?l.push(d):!f&&d===u[0]?l.push("*"):f?d===u[0]?l.push(`<=${f}`):l.push(`${d} - ${f}`):l.push(`>=${d}`);const c=l.join(" || "),h=typeof r.raw=="string"?r.raw:String(r);return c.length<h.length?c:r},ea}var ta,Ls;function Tl(){if(Ls)return ta;Ls=1;const n=Pe(),e=vr(),{ANY:t}=e,r=Er(),a=Te(),i=(h,d,f={})=>{if(h===d)return!0;h=new n(h,f),d=new n(d,f);let p=!1;e:for(const m of h.set){for(const g of d.set){const y=u(m,g,f);if(p=p||y!==null,y)continue e}if(p)return!1}return!0},s=[new e(">=0.0.0-0")],o=[new e(">=0.0.0")],u=(h,d,f)=>{if(h===d)return!0;if(h.length===1&&h[0].semver===t){if(d.length===1&&d[0].semver===t)return!0;f.includePrerelease?h=s:h=o}if(d.length===1&&d[0].semver===t){if(f.includePrerelease)return!0;d=o}const p=new Set;let m,g;for(const S of h)S.operator===">"||S.operator===">="?m=l(m,S,f):S.operator==="<"||S.operator==="<="?g=c(g,S,f):p.add(S.semver);if(p.size>1)return null;let y;if(m&&g){if(y=a(m.semver,g.semver,f),y>0)return null;if(y===0&&(m.operator!==">="||g.operator!=="<="))return null}for(const S of p){if(m&&!r(S,String(m),f)||g&&!r(S,String(g),f))return null;for(const $e of d)if(!r(S,String($e),f))return!1;return!0}let _,b,P,E,k=g&&!f.includePrerelease&&g.semver.prerelease.length?g.semver:!1,M=m&&!f.includePrerelease&&m.semver.prerelease.length?m.semver:!1;k&&k.prerelease.length===1&&g.operator==="<"&&k.prerelease[0]===0&&(k=!1);for(const S of d){if(E=E||S.operator===">"||S.operator===">=",P=P||S.operator==="<"||S.operator==="<=",m){if(M&&S.semver.prerelease&&S.semver.prerelease.length&&S.semver.major===M.major&&S.semver.minor===M.minor&&S.semver.patch===M.patch&&(M=!1),S.operator===">"||S.operator===">="){if(_=l(m,S,f),_===S&&_!==m)return!1}else if(m.operator===">="&&!r(m.semver,String(S),f))return!1}if(g){if(k&&S.semver.prerelease&&S.semver.prerelease.length&&S.semver.major===k.major&&S.semver.minor===k.minor&&S.semver.patch===k.patch&&(k=!1),S.operator==="<"||S.operator==="<="){if(b=c(g,S,f),b===S&&b!==g)return!1}else if(g.operator==="<="&&!r(g.semver,String(S),f))return!1}if(!S.operator&&(g||m)&&y!==0)return!1}return!(m&&P&&!g&&y!==0||g&&E&&!m&&y!==0||M||k)},l=(h,d,f)=>{if(!h)return d;const p=a(h.semver,d.semver,f);return p>0?h:p<0||d.operator===">"&&h.operator===">="?d:h},c=(h,d,f)=>{if(!h)return d;const p=a(h.semver,d.semver,f);return p<0?h:p>0||d.operator==="<"&&h.operator==="<="?d:h};return ta=i,ta}var ra,Ms;function Pl(){if(Ms)return ra;Ms=1;const n=Lt(),e=br(),t=le(),r=Wi(),a=yt(),i=nl(),s=al(),o=il(),u=sl(),l=ol(),c=ul(),h=ll(),d=cl(),f=Te(),p=dl(),m=hl(),g=Tn(),y=fl(),_=pl(),b=wr(),P=kn(),E=ps(),k=gs(),M=Nn(),S=Mn(),$e=ws(),Yt=ml(),Qt=vr(),Ya=Pe(),Qa=Er(),T=yl(),O=bl(),j=_l(),C=wl(),N=vl(),$=Kn(),D=El(),Z=Ol(),q=xl(),K=Sl(),pe=Tl();return ra={parse:a,valid:i,clean:s,inc:o,diff:u,major:l,minor:c,patch:h,prerelease:d,compare:f,rcompare:p,compareLoose:m,compareBuild:g,sort:y,rsort:_,gt:b,lt:P,eq:E,neq:k,gte:M,lte:S,cmp:$e,coerce:Yt,Comparator:Qt,Range:Ya,satisfies:Qa,toComparators:T,maxSatisfying:O,minSatisfying:j,minVersion:C,validRange:N,outside:$,gtr:D,ltr:Z,intersects:q,simplifyRange:K,subset:pe,SemVer:t,re:n.re,src:n.src,tokens:n.t,SEMVER_SPEC_VERSION:e.SEMVER_SPEC_VERSION,RELEASE_TYPES:e.RELEASE_TYPES,compareIdentifiers:r.compareIdentifiers,rcompareIdentifiers:r.rcompareIdentifiers},ra}Pl();function Je(n){if(!n||n.split("/").length>2||n.startsWith("/")||n.endsWith("/")||n.split(":").length>2)throw new Error(`Invalid identifier format: ${n}`);const[e,t]=n.split(":"),r=t||"latest";if(e.includes("/")){const[a,i]=e.split("/",2);if(!a||!i)throw new Error(`Invalid identifier format: ${n}`);return[a,i,r]}else{if(!e)throw new Error(`Invalid identifier format: ${n}`);return["-",e,r]}}class Al extends Error{constructor(e){super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithConflictError",this.status=409}}async function U(n,e,t){let r;if(n.ok){t&&(r=await n.text());return}r=await n.text();const a=`Failed to ${e}. Received status [${n.status}]: ${n.statusText}. Server response: ${r}`;if(n.status===409)throw new Al(a);const i=new Error(a);throw i.status=n.status,i}var Fs="[...]",Rl={result:"[Circular]"},Or=[],bt=[];const Il=new TextEncoder;function kl(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function xr(n){return Il.encode(n)}function we(n,e,t,r,a){try{const i=JSON.stringify(n,t,r);return xr(i)}catch(i){if(!i.message?.includes("Converting circular structure to JSON"))return console.warn(`[WARNING]: LangSmith received unserializable value.${e?`
Context: ${e}`:""}`),xr("[Unserializable]");console.warn(`[WARNING]: LangSmith received circular JSON. This will decrease tracer performance. ${e?`
Context: ${e}`:""}`),typeof a>"u"&&(a=kl()),aa(n,"",0,[],void 0,0,a);let s;try{bt.length===0?s=JSON.stringify(n,t,r):s=JSON.stringify(n,Cl(t),r)}catch{return xr("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;Or.length!==0;){const o=Or.pop();o.length===4?Object.defineProperty(o[0],o[1],o[3]):o[0][o[1]]=o[2]}}return xr(s)}}function na(n,e,t,r){var a=Object.getOwnPropertyDescriptor(r,t);a.get!==void 0?a.configurable?(Object.defineProperty(r,t,{value:n}),Or.push([r,t,e,a])):bt.push([e,t,n]):(r[t]=n,Or.push([r,t,e]))}function aa(n,e,t,r,a,i,s){i+=1;var o;if(typeof n=="object"&&n!==null){for(o=0;o<r.length;o++)if(r[o]===n){na(Rl,n,e,a);return}if(typeof s.depthLimit<"u"&&i>s.depthLimit){na(Fs,n,e,a);return}if(typeof s.edgesLimit<"u"&&t+1>s.edgesLimit){na(Fs,n,e,a);return}if(r.push(n),Array.isArray(n))for(o=0;o<n.length;o++)aa(n[o],o,o,r,n,i,s);else{var u=Object.keys(n);for(o=0;o<u.length;o++){var l=u[o];aa(n[l],l,o,r,n,i,s)}}r.pop()}}function Cl(n){return n=typeof n<"u"?n:function(e,t){return t},function(e,t){if(bt.length>0)for(var r=0;r<bt.length;r++){var a=bt[r];if(a[1]===e&&a[0]===t){t=a[2],bt.splice(r,1);break}}return n.call(this,e,t)}}function Ds(n){const e=Hs(),t=zl(),r=n.extra??{},a=r.metadata;return n.extra={...r,runtime:{...e,...r?.runtime},metadata:{...t,...t.revision_id||n.revision_id?{revision_id:n.revision_id??t.revision_id}:{},...a}},n}const $l=n=>{const e=n?.toString()??Ne("TRACING_SAMPLING_RATE");if(e===void 0)return;const t=parseFloat(e);if(t<0||t>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${t}`);return t},jl=n=>{const t=n.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"};async function Nl(n){const e=[];for await(const t of n)e.push(t);return e}function ia(n){if(n!==void 0)return n.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const Ll=async n=>{if(n?.status===429){const e=parseInt(n.headers.get("retry-after")??"30",10)*1e3;if(e>0)return await new Promise(t=>setTimeout(t,e)),!0}return!1};function Us(n){return typeof n=="number"?Number(n.toFixed(4)):n}class Ml{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let t;const r=new Promise(i=>{t=i}),a=we(e.item,`Serializing run with id: ${e.item.id}`).length;return this.items.push({action:e.action,payload:e.item,itemPromiseResolve:t,itemPromise:r,size:a}),this.sizeBytes+=a,r}pop(e){if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const t=[];let r=0;for(;r+(this.peek()?.size??0)<e&&this.items.length>0;){const a=this.items.shift();a&&(t.push(a),r+=a.size,this.sizeBytes-=a.size)}if(t.length===0&&this.items.length>0){const a=this.items.shift();t.push(a),r+=a.size,this.sizeBytes-=a.size}return[t.map(a=>({action:a.action,item:a.payload})),()=>t.forEach(a=>a.itemPromiseResolve())]}}const Fl=20971520,Dl=2500;class Mt{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Ml}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:Ke("LANGSMITH_TRACING_BACKGROUND")==="false"}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:Ke("LANGSMITH_DEBUG")==="true"});const t=Mt.getDefaultClientConfig();if(this.tracingSampleRate=$l(e.tracingSamplingRate),this.apiUrl=ia(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=ia(e.apiKey??t.apiKey),this.webUrl=ia(e.webUrl??t.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.timeout_ms=e.timeout_ms??9e4,this.caller=new Fi({...e.callerOptions??{},debug:e.debug??this.debug}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.debug=e.debug??this.debug,this.batchIngestCaller=new Fi({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...e.callerOptions??{},onFailedResponseHook:Ll,debug:e.debug??this.debug}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode}static getDefaultClientConfig(){const e=Ne("API_KEY"),t=Ne("ENDPOINT")??"https://api.smith.langchain.com",r=Ne("HIDE_INPUTS")==="true",a=Ne("HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:a}}getHostUrl(){return this.webUrl?this.webUrl:jl(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.endsWith("/api/v1")?(this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("beta")?(this.webUrl="https://beta.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${Vs}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}async processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}async processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}async prepareRunCreateOrUpdateInputs(e){const t={...e};return t.inputs!==void 0&&(t.inputs=await this.processInputs(t.inputs)),t.outputs!==void 0&&(t.outputs=await this.processOutputs(t.outputs)),t}async _getResponse(e,t){const r=t?.toString()??"",a=`${this.apiUrl}${e}?${r}`,i=await this.caller.call(I(this.debug),a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(i,`Failed to fetch ${e}`),i}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,r){let a=Number(t.get("offset"))||0;const i=Number(t.get("limit"))||100;for(;;){t.set("offset",String(a)),t.set("limit",String(i));const s=`${this.apiUrl}${e}?${t}`,o=await this.caller.call(I(this.debug),s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await U(o,`Failed to fetch ${e}`);const u=r?r(await o.json()):await o.json();if(u.length===0||(yield u,u.length<i))break;a+=u.length}}async*_getCursorPaginatedList(e,t=null,r="POST",a="runs"){const i=t?{...t}:{};for(;;){const o=await(await this.caller.call(I(this.debug),`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(i)})).json();if(!o||!o[a])break;yield o[a];const u=o.cursors;if(!u||!u.next)break;i.cursor=u.next}}_shouldSample(){return this.tracingSampleRate===void 0?!0:Math.random()<this.tracingSampleRate}_filterForSampling(e,t=!1){if(this.tracingSampleRate===void 0)return e;if(t){const r=[];for(const a of e)this.filteredPostUuids.has(a.id)?this.filteredPostUuids.delete(a.id):r.push(a);return r}else{const r=[];for(const a of e){const i=a.trace_id??a.id;this.filteredPostUuids.has(i)||(a.id===i?this._shouldSample()?r.push(a):this.filteredPostUuids.add(i):r.push(a))}return r}}async _getBatchSizeLimitBytes(){const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??e.batch_ingest_config?.size_limit_bytes??Fl}async _getMultiPartSupport(){return(await this._ensureServerInfo()).instance_flags?.dataset_examples_multipart_enabled??!1}drainAutoBatchQueue(e){const t=[];for(;this.autoBatchQueue.items.length>0;){const[r,a]=this.autoBatchQueue.pop(e);if(!r.length){a();break}const i=this._processBatch(r,a).catch(console.error);t.push(i)}return Promise.all(t)}async _processBatch(e,t){if(!e.length){t();return}try{const r={runCreates:e.filter(i=>i.action==="create").map(i=>i.item),runUpdates:e.filter(i=>i.action==="update").map(i=>i.item)};(await this._ensureServerInfo())?.batch_ingest_config?.use_multipart_endpoint?await this.multipartIngestRuns(r):await this.batchIngestRuns(r)}finally{t()}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.action==="create"&&(e.item=Ds(e.item));const t=this.autoBatchQueue.push(e);if(this.manualFlushMode)return t;const r=await this._getBatchSizeLimitBytes();return this.autoBatchQueue.sizeBytes>r&&this.drainAutoBatchQueue(r),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue(r)},this.autoBatchAggregationDelayMs)),t}async _getServerInfo(){const e=await this.caller.call(I(this.debug),`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(Dl),...this.fetchOptions});await U(e,"get server info");const t=await e.json();return this.debug&&console.log(`
=== LangSmith Server Configuration ===
`+JSON.stringify(t,null,2)+`
`),t}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch(e){console.warn(`[WARNING]: LangSmith failed to fetch info on supported operations with status code ${e.status}. Falling back to batch operations and default limits.`)}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const e=await this._getBatchSizeLimitBytes();await this.drainAutoBatchQueue(e)}async createRun(e){if(!this._filterForSampling([e]).length)return;const t={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;const a=await this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&a.trace_id!==void 0&&a.dotted_order!==void 0){this.processRunOperation({action:"create",item:a}).catch(console.error);return}const i=Ds(a),s=await this.caller.call(I(this.debug),`${this.apiUrl}/runs`,{method:"POST",headers:t,body:we(i,`Creating run with id: ${i.id}`),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await U(s,"create run",!0)}async batchIngestRuns({runCreates:e,runUpdates:t}){if(e===void 0&&t===void 0)return;let r=await Promise.all(e?.map(o=>this.prepareRunCreateOrUpdateInputs(o))??[]),a=await Promise.all(t?.map(o=>this.prepareRunCreateOrUpdateInputs(o))??[]);if(r.length>0&&a.length>0){const o=r.reduce((l,c)=>(c.id&&(l[c.id]=c),l),{}),u=[];for(const l of a)l.id!==void 0&&o[l.id]?o[l.id]={...o[l.id],...l}:u.push(l);r=Object.values(o),a=u}const i={post:r,patch:a};if(!i.post.length&&!i.patch.length)return;const s={post:[],patch:[]};for(const o of["post","patch"]){const u=o,l=i[u].reverse();let c=l.pop();for(;c!==void 0;)s[u].push(c),c=l.pop()}if(s.post.length>0||s.patch.length>0){const o=s.post.map(u=>u.id).concat(s.patch.map(u=>u.id)).join(",");await this._postBatchIngestRuns(we(s,`Ingesting runs with ids: ${o}`))}}async _postBatchIngestRuns(e){const t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},r=await this.batchIngestCaller.call(I(this.debug),`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await U(r,"batch create run",!0)}async multipartIngestRuns({runCreates:e,runUpdates:t}){if(e===void 0&&t===void 0)return;const r={};let a=[];for(const c of e??[]){const h=await this.prepareRunCreateOrUpdateInputs(c);h.id!==void 0&&h.attachments!==void 0&&(r[h.id]=h.attachments),delete h.attachments,a.push(h)}let i=[];for(const c of t??[])i.push(await this.prepareRunCreateOrUpdateInputs(c));if(a.find(c=>c.trace_id===void 0||c.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(i.find(c=>c.trace_id===void 0||c.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(a.length>0&&i.length>0){const c=a.reduce((d,f)=>(f.id&&(d[f.id]=f),d),{}),h=[];for(const d of i)d.id!==void 0&&c[d.id]?c[d.id]={...c[d.id],...d}:h.push(d);a=Object.values(c),i=h}if(a.length===0&&i.length===0)return;const u=[],l=[];for(const[c,h]of[["post",a],["patch",i]])for(const d of h){const{inputs:f,outputs:p,events:m,attachments:g,...y}=d,_={inputs:f,outputs:p,events:m},b=we(y,`Serializing for multipart ingestion of run with id: ${y.id}`);l.push({name:`${c}.${y.id}`,payload:new Blob([b],{type:`application/json; length=${b.length}`})});for(const[P,E]of Object.entries(_)){if(E===void 0)continue;const k=we(E,`Serializing ${P} for multipart ingestion of run with id: ${y.id}`);l.push({name:`${c}.${y.id}.${P}`,payload:new Blob([k],{type:`application/json; length=${k.length}`})})}if(y.id!==void 0){const P=r[y.id];if(P){delete r[y.id];for(const[E,k]of Object.entries(P)){let M,S;if(Array.isArray(k)?[M,S]=k:(M=k.mimeType,S=k.data),E.includes(".")){console.warn(`Skipping attachment '${E}' for run ${y.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}l.push({name:`attachment.${y.id}.${E}`,payload:new Blob([S],{type:`${M}; length=${S.byteLength}`})})}}}u.push(`trace=${y.trace_id},id=${y.id}`)}await this._sendMultipartRequest(l,u.join("; "))}async _createNodeFetchBody(e,t){const r=[];for(const s of e)r.push(new Blob([`--${t}\r
`])),r.push(new Blob([`Content-Disposition: form-data; name="${s.name}"\r
`,`Content-Type: ${s.payload.type}\r
\r
`])),r.push(s.payload),r.push(new Blob([`\r
`]));return r.push(new Blob([`--${t}--\r
`])),await new Blob(r).arrayBuffer()}async _createMultipartStream(e,t){const r=new TextEncoder;return new ReadableStream({async start(i){const s=async o=>{typeof o=="string"?i.enqueue(r.encode(o)):i.enqueue(o)};for(const o of e){await s(`--${t}\r
`),await s(`Content-Disposition: form-data; name="${o.name}"\r
`),await s(`Content-Type: ${o.payload.type}\r
\r
`);const l=o.payload.stream().getReader();try{let c;for(;!(c=await l.read()).done;)i.enqueue(c.value)}finally{l.releaseLock()}await s(`\r
`)}await s(`--${t}--\r
`),i.close()}})}async _sendMultipartRequest(e,t){try{const r="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),a=await(el()?this._createNodeFetchBody(e,r):this._createMultipartStream(e,r)),i=await this.batchIngestCaller.call(I(this.debug),`${this.apiUrl}/runs/multipart`,{method:"POST",headers:{...this.headers,"Content-Type":`multipart/form-data; boundary=${r}`},body:a,duplex:"half",signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await U(i,"ingest multipart runs",!0)}catch(r){console.warn(`${r.message.trim()}

Context: ${t}`)}}async updateRun(e,t){F(e),t.inputs&&(t.inputs=await this.processInputs(t.inputs)),t.outputs&&(t.outputs=await this.processOutputs(t.outputs));const r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&r.trace_id!==void 0&&r.dotted_order!==void 0){if(t.end_time!==void 0&&r.parent_run_id===void 0&&this.blockOnRootRunFinalization&&!this.manualFlushMode){await this.processRunOperation({action:"update",item:r}).catch(console.error);return}else this.processRunOperation({action:"update",item:r}).catch(console.error);return}const a={...this.headers,"Content-Type":"application/json"},i=await this.caller.call(I(this.debug),`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:a,body:we(t,`Serializing payload to update run with id: ${e}`),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await U(i,"update run",!0)}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){F(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(t!==void 0){let a;t.session_id?a=t.session_id:r?.projectName?a=(await this.readProject({projectName:r?.projectName})).id:r?.projectId?a=r?.projectId:a=(await this.readProject({projectName:Ne("PROJECT")||"default"})).id;const i=await this._getTenantId();return`${this.getHostUrl()}/o/${i}/projects/p/${a}/r/${t.id}?poll=true`}else if(e!==void 0){const a=await this.readRun(e);if(!a.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${a.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await Nl(this.listRuns({id:e.child_run_ids})),r={},a={};t.sort((i,s)=>(i?.dotted_order??"").localeCompare(s?.dotted_order??""));for(const i of t){if(i.parent_run_id===null||i.parent_run_id===void 0)throw new Error(`Child run ${i.id} has no parent`);i.parent_run_id in r||(r[i.parent_run_id]=[]),r[i.parent_run_id].push(i),a[i.id]=i}e.child_runs=r[e.id]||[];for(const i in r)i!==e.id&&(a[i].child_runs=r[i]);return e}async*listRuns(e){const{projectId:t,projectName:r,parentRunId:a,traceId:i,referenceExampleId:s,startTime:o,executionOrder:u,isRoot:l,runType:c,error:h,id:d,query:f,filter:p,traceFilter:m,treeFilter:g,limit:y,select:_,order:b}=e;let P=[];if(t&&(P=Array.isArray(t)?t:[t]),r){const S=Array.isArray(r)?r:[r],$e=await Promise.all(S.map(Yt=>this.readProject({projectName:Yt}).then(Qt=>Qt.id)));P.push(...$e)}const E=["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],k={session:P.length?P:null,run_type:c,reference_example:s,query:f,filter:p,trace_filter:m,tree_filter:g,execution_order:u,parent_run:a,start_time:o?o.toISOString():null,error:h,id:d,limit:y,trace:i,select:_||E,is_root:l,order:b};let M=0;for await(const S of this._getCursorPaginatedList("/runs/query",k))if(y){if(M>=y)break;if(S.length+M>y){yield*S.slice(0,y-M);break}M+=S.length,yield*S}else yield*S}async*listGroupRuns(e){const{projectId:t,projectName:r,groupBy:a,filter:i,startTime:s,endTime:o,limit:u,offset:l}=e,h={session_id:t||(await this.readProject({projectName:r})).id,group_by:a,filter:i,start_time:s?s.toISOString():null,end_time:o?o.toISOString():null,limit:Number(u)||100};let d=Number(l)||0;const f="/runs/group",p=`${this.apiUrl}${f}`;for(;;){const m={...h,offset:d},g=Object.fromEntries(Object.entries(m).filter(([E,k])=>k!==void 0)),y=await this.caller.call(I(),p,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(g),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await U(y,`Failed to fetch ${f}`);const _=await y.json(),{groups:b,total:P}=_;if(b.length===0)break;for(const E of b)yield E;if(d+=b.length,d>=P)break}}async getRunStats({id:e,trace:t,parentRun:r,runType:a,projectNames:i,projectIds:s,referenceExampleIds:o,startTime:u,endTime:l,error:c,query:h,filter:d,traceFilter:f,treeFilter:p,isRoot:m,dataSourceType:g}){let y=s||[];i&&(y=[...s||[],...await Promise.all(i.map(k=>this.readProject({projectName:k}).then(M=>M.id)))]);const b=Object.fromEntries(Object.entries({id:e,trace:t,parent_run:r,run_type:a,session:y,reference_example:o,start_time:u,end_time:l,error:c,query:h,filter:d,trace_filter:f,tree_filter:p,is_root:m,data_source_type:g}).filter(([k,M])=>M!==void 0));return await(await this.caller.call(I(this.debug),`${this.apiUrl}/runs/stats`,{method:"POST",headers:this.headers,body:JSON.stringify(b),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async shareRun(e,{shareId:t}={}){const r={run_id:e,share_token:t||ue()};F(e);const i=await(await this.caller.call(I(this.debug),`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(i===null||!("share_token"in i))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${i.share_token}/r`}async unshareRun(e){F(e);const t=await this.caller.call(I(this.debug),`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await U(t,"unshare run",!0)}async readRunSharedLink(e){F(e);const r=await(await this.caller.call(I(this.debug),`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const r=new URLSearchParams({share_token:e});if(t!==void 0)for(const s of t)r.append("id",s);return F(e),await(await this.caller.call(I(this.debug),`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),F(e);const a=await(await this.caller.call(I(this.debug),`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const r={dataset_id:e};F(e);const i=await(await this.caller.call(I(this.debug),`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return i.url=`${this.getHostUrl()}/public/${i.share_token}/d`,i}async unshareDataset(e){F(e);const t=await this.caller.call(I(this.debug),`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await U(t,"unshare dataset",!0)}async readSharedDataset(e){return F(e),await(await this.caller.call(I(this.debug),`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async listSharedExamples(e,t){const r={};t?.exampleIds&&(r.id=t.exampleIds);const a=new URLSearchParams;Object.entries(r).forEach(([o,u])=>{Array.isArray(u)?u.forEach(l=>a.append(o,l)):a.append(o,u)});const i=await this.caller.call(I(this.debug),`${this.apiUrl}/public/${e}/examples?${a.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),s=await i.json();if(!i.ok)throw"detail"in s?new Error(`Failed to list shared examples.
Status: ${i.status}
Message: ${Array.isArray(s.detail)?s.detail.join(`
`):"Unspecified error"}`):new Error(`Failed to list shared examples: ${i.status} ${i.statusText}`);return s.map(o=>({...o,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:a=!1,projectExtra:i=null,referenceDatasetId:s=null}){const o=a?"?upsert=true":"",u=`${this.apiUrl}/sessions${o}`,l=i||{};r&&(l.metadata=r);const c={name:e,extra:l,description:t};s!==null&&(c.reference_dataset_id=s);const h=await this.caller.call(I(this.debug),u,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(h,"create project"),await h.json()}async updateProject(e,{name:t=null,description:r=null,metadata:a=null,projectExtra:i=null,endTime:s=null}){const o=`${this.apiUrl}/sessions/${e}`;let u=i;a&&(u={...u||{},metadata:a});const l={name:t,extra:u,description:r,end_time:s?new Date(s).toISOString():null},c=await this.caller.call(I(this.debug),o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(c,"update project"),await c.json()}async hasProject({projectId:e,projectName:t}){let r="/sessions";const a=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)F(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide projectName or projectId");const i=await this.caller.call(I(this.debug),`${this.apiUrl}${r}?${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{const s=await i.json();return i.ok?Array.isArray(s)?s.length>0:!0:!1}catch{return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let a="/sessions";const i=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)F(e),a+=`/${e}`;else if(t!==void 0)i.append("name",t);else throw new Error("Must provide projectName or projectId");r!==void 0&&i.append("include_stats",r.toString());const s=await this._get(a,i);let o;if(Array.isArray(s)){if(s.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);o=s[0]}else o=s;return o}async getProjectUrl({projectId:e,projectName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either projectName or projectId");const r=await this.readProject({projectId:e,projectName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");const r=await this.readDataset({datasetId:e,datasetName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/datasets/${r.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:a,referenceDatasetName:i,referenceFree:s,metadata:o}={}){const u=new URLSearchParams;if(e!==void 0)for(const l of e)u.append("id",l);if(t!==void 0&&u.append("name",t),r!==void 0&&u.append("name_contains",r),a!==void 0)u.append("reference_dataset",a);else if(i!==void 0){const l=await this.readDataset({datasetName:i});u.append("reference_dataset",l.id)}s!==void 0&&u.append("reference_free",s.toString()),o!==void 0&&u.append("metadata",JSON.stringify(o));for await(const l of this._getPaginated("/sessions",u))yield*l}async deleteProject({projectId:e,projectName:t}){let r;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:t})).id:r=e,F(r);const a=await this.caller.call(I(this.debug),`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await U(a,`delete session ${r} (${t})`,!0)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:a,description:i,dataType:s,name:o}){const u=`${this.apiUrl}/datasets/upload`,l=new FormData;l.append("file",e,t),r.forEach(d=>{l.append("input_keys",d)}),a.forEach(d=>{l.append("output_keys",d)}),i&&l.append("description",i),s&&l.append("data_type",s),o&&l.append("name",o);const c=await this.caller.call(I(this.debug),u,{method:"POST",headers:this.headers,body:l,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(c,"upload CSV"),await c.json()}async createDataset(e,{description:t,dataType:r,inputsSchema:a,outputsSchema:i,metadata:s}={}){const o={name:e,description:t,extra:s?{metadata:s}:void 0};r&&(o.data_type=r),a&&(o.inputs_schema_definition=a),i&&(o.outputs_schema_definition=i);const u=await this.caller.call(I(this.debug),`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(u,"create dataset"),await u.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets";const a=new URLSearchParams({limit:"1"});if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)F(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide datasetName or datasetId");const i=await this._get(r,a);let s;if(Array.isArray(i)){if(i.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);s=i[0]}else s=i;return s}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(r){if(r instanceof Error&&r.message.toLocaleLowerCase().includes("not found"))return!1;throw r}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:r,toVersion:a}){let i=e;if(i===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");if(i!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");i===void 0&&(i=(await this.readDataset({datasetName:t})).id);const s=new URLSearchParams({from_version:typeof r=="string"?r:r.toISOString(),to_version:typeof a=="string"?a:a.toISOString()});return await this._get(`/datasets/${i}/versions/diff`,s)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){const r="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide either datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:a,datasetNameContains:i,metadata:s}={}){const o="/datasets",u=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(r!==void 0)for(const l of r)u.append("id",l);a!==void 0&&u.append("name",a),i!==void 0&&u.append("name_contains",i),s!==void 0&&u.append("metadata",JSON.stringify(s));for await(const l of this._getPaginated(o,u))yield*l}async updateDataset(e){const{datasetId:t,datasetName:r,...a}=e;if(!t&&!r)throw new Error("Must provide either datasetName or datasetId");const i=t??(await this.readDataset({datasetName:r})).id;F(i);const s=await this.caller.call(I(this.debug),`${this.apiUrl}/datasets/${i}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(s,"update dataset"),await s.json()}async updateDatasetTag(e){const{datasetId:t,datasetName:r,asOf:a,tag:i}=e;if(!t&&!r)throw new Error("Must provide either datasetName or datasetId");const s=t??(await this.readDataset({datasetName:r})).id;F(s);const o=await this.caller.call(I(this.debug),`${this.apiUrl}/datasets/${s}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({as_of:typeof a=="string"?a:a.toISOString(),tag:i}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await U(o,"update dataset tags")}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",a=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(a=(await this.readDataset({datasetName:t})).id),a!==void 0)F(a),r+=`/${a}`;else throw new Error("Must provide datasetName or datasetId");const i=await this.caller.call(I(this.debug),this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await U(i,`delete ${r}`),await i.json()}async indexDataset({datasetId:e,datasetName:t,tag:r}){let a=e;if(!a&&!t)throw new Error("Must provide either datasetName or datasetId");if(a&&t)throw new Error("Must provide either datasetName or datasetId, not both");a||(a=(await this.readDataset({datasetName:t})).id),F(a);const i={tag:r},s=await this.caller.call(I(this.debug),`${this.apiUrl}/datasets/${a}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await U(s,"index dataset"),await s.json()}async similarExamples(e,t,r,{filter:a}={}){const i={limit:r,inputs:e};a!==void 0&&(i.filter=a),F(t);const s=await this.caller.call(I(this.debug),`${this.apiUrl}/datasets/${t}/search`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(s,"fetch similar examples"),(await s.json()).examples}async createExample(e,t,r){if(Bs(e)&&(t!==void 0||r!==void 0))throw new Error("Cannot provide outputs or options when using ExampleCreate object");let a=t?r?.datasetId:e.dataset_id;const i=t?r?.datasetName:e.dataset_name;if(a===void 0&&i===void 0)throw new Error("Must provide either datasetName or datasetId");if(a!==void 0&&i!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");a===void 0&&(a=(await this.readDataset({datasetName:i})).id);const s=(t?r?.createdAt:e.created_at)||new Date;let o;Bs(e)?o=e:o={inputs:e,outputs:t,created_at:s?.toISOString(),id:r?.exampleId,metadata:r?.metadata,split:r?.split,source_run_id:r?.sourceRunId,use_source_run_io:r?.useSourceRunIO,use_source_run_attachments:r?.useSourceRunAttachments,attachments:r?.attachments};const u=await this._uploadExamplesMultipart(a,[o]);return await this.readExample(u.example_ids?.[0]??ue())}async createExamples(e){if(Array.isArray(e)){if(e.length===0)return[];const _=e;let b=_[0].dataset_id;const P=_[0].dataset_name;if(b===void 0&&P===void 0)throw new Error("Must provide either datasetName or datasetId");if(b!==void 0&&P!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");b===void 0&&(b=(await this.readDataset({datasetName:P})).id);const E=await this._uploadExamplesMultipart(b,_);return await Promise.all(E.example_ids.map(M=>this.readExample(M)))}const{inputs:t,outputs:r,metadata:a,splits:i,sourceRunIds:s,useSourceRunIOs:o,useSourceRunAttachments:u,attachments:l,exampleIds:c,datasetId:h,datasetName:d}=e;if(t===void 0)throw new Error("Must provide inputs when using legacy parameters");let f=h;const p=d;if(f===void 0&&p===void 0)throw new Error("Must provide either datasetName or datasetId");if(f!==void 0&&p!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");f===void 0&&(f=(await this.readDataset({datasetName:p})).id);const m=t.map((_,b)=>({dataset_id:f,inputs:_,outputs:r?.[b],metadata:a?.[b],split:i?.[b],id:c?.[b],attachments:l?.[b],source_run_id:s?.[b],use_source_run_io:o?.[b],use_source_run_attachments:u?.[b]})),g=await this._uploadExamplesMultipart(f,m);return await Promise.all(g.example_ids.map(_=>this.readExample(_)))}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){const a=e.map(s=>Di(s)?Ui(s):s),i=Di(t)?Ui(t):t;return this.createExample({input:a},{output:i},r)}async readExample(e){F(e);const t=`/examples/${e}`,r=await this._get(t),{attachment_urls:a,...i}=r,s=i;return a&&(s.attachments=Object.entries(a).reduce((o,[u,l])=>(o[u.slice(11)]={presigned_url:l.presigned_url,mime_type:l.mime_type},o),{})),s}async*listExamples({datasetId:e,datasetName:t,exampleIds:r,asOf:a,splits:i,inlineS3Urls:s,metadata:o,limit:u,offset:l,filter:c,includeAttachments:h}={}){let d;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)d=e;else if(t!==void 0)d=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");const f=new URLSearchParams({dataset:d}),p=a?typeof a=="string"?a:a?.toISOString():void 0;p&&f.append("as_of",p);const m=s??!0;if(f.append("inline_s3_urls",m.toString()),r!==void 0)for(const y of r)f.append("id",y);if(i!==void 0)for(const y of i)f.append("splits",y);if(o!==void 0){const y=JSON.stringify(o);f.append("metadata",y)}u!==void 0&&f.append("limit",u.toString()),l!==void 0&&f.append("offset",l.toString()),c!==void 0&&f.append("filter",c),h===!0&&["attachment_urls","outputs","metadata"].forEach(y=>f.append("select",y));let g=0;for await(const y of this._getPaginated("/examples",f)){for(const _ of y){const{attachment_urls:b,...P}=_,E=P;b&&(E.attachments=Object.entries(b).reduce((k,[M,S])=>(k[M.slice(11)]={presigned_url:S.presigned_url,mime_type:S.mime_type||void 0},k),{})),yield E,g++}if(u!==void 0&&g>=u)break}}async deleteExample(e){F(e);const t=`/examples/${e}`,r=await this.caller.call(I(this.debug),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await U(r,`delete ${t}`),await r.json()}async updateExample(e,t){let r;t?r=e:r=e.id,F(r);let a;t?a={id:r,...t}:a=e;let i;return a.dataset_id!==void 0?i=a.dataset_id:i=(await this.readExample(r)).dataset_id,this._updateExamplesMultipart(i,[a])}async updateExamples(e){let t;return e[0].dataset_id===void 0?t=(await this.readExample(e[0].id)).dataset_id:t=e[0].dataset_id,this._updateExamplesMultipart(t,e)}async readDatasetVersion({datasetId:e,datasetName:t,asOf:r,tag:a}){let i;if(e?i=e:i=(await this.readDataset({datasetName:t})).id,F(i),r&&a||!r&&!a)throw new Error("Exactly one of asOf and tag must be specified.");const s=new URLSearchParams;r!==void 0&&s.append("as_of",typeof r=="string"?r:r.toISOString()),a!==void 0&&s.append("tag",a);const o=await this.caller.call(I(this.debug),`${this.apiUrl}/datasets/${i}/version?${s.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(o,"read dataset version"),await o.json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:r}){let a;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?a=(await this.readDataset({datasetName:t})).id:a=e,F(a);const i=new URLSearchParams,s=r?typeof r=="string"?r:r?.toISOString():void 0;return s&&i.append("as_of",s),await this._get(`/datasets/${a}/splits`,i)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:r,exampleIds:a,remove:i=!1}){let s;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?s=(await this.readDataset({datasetName:t})).id:s=e,F(s);const o={split_name:r,examples:a.map(l=>(F(l),l)),remove:i},u=await this.caller.call(I(this.debug),`${this.apiUrl}/datasets/${s}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await U(u,"update dataset splits",!0)}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:a,referenceExample:i}={loadChildRuns:!1}){Vi("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let s;if(typeof e=="string")s=await this.readRun(e,{loadChildRuns:a});else if(typeof e=="object"&&"id"in e)s=e;else throw new Error(`Invalid run type: ${typeof e}`);s.reference_example_id!==null&&s.reference_example_id!==void 0&&(i=await this.readExample(s.reference_example_id));const o=await t.evaluateRun(s,i),[u,l]=await this._logEvaluationFeedback(o,s,r);return l[0]}async createFeedback(e,t,{score:r,value:a,correction:i,comment:s,sourceInfo:o,feedbackSourceType:u="api",sourceRunId:l,feedbackId:c,feedbackConfig:h,projectId:d,comparativeExperimentId:f}){if(!e&&!d)throw new Error("One of runId or projectId must be provided");if(e&&d)throw new Error("Only one of runId or projectId can be provided");const p={type:u??"api",metadata:o??{}};l!==void 0&&p?.metadata!==void 0&&!p.metadata.__run&&(p.metadata.__run={run_id:l}),p?.metadata!==void 0&&p.metadata.__run?.run_id!==void 0&&F(p.metadata.__run.run_id);const m={id:c??ue(),run_id:e,key:t,score:Us(r),value:a,correction:i,comment:s,feedback_source:p,comparative_experiment_id:f,feedbackConfig:h,session_id:d},g=`${this.apiUrl}/feedback`,y=await this.caller.call(I(this.debug),g,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(m),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(y,"create feedback",!0),m}async updateFeedback(e,{score:t,value:r,correction:a,comment:i}){const s={};t!=null&&(s.score=Us(t)),r!=null&&(s.value=r),a!=null&&(s.correction=a),i!=null&&(s.comment=i),F(e);const o=await this.caller.call(I(this.debug),`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await U(o,"update feedback",!0)}async readFeedback(e){F(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){F(e);const t=`/feedback/${e}`,r=await this.caller.call(I(this.debug),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await U(r,`delete ${t}`),await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){const a=new URLSearchParams;if(e&&a.append("run",e.join(",")),t)for(const i of t)a.append("key",i);if(r)for(const i of r)a.append("source",i);for await(const i of this._getPaginated("/feedback",a))yield*i}async createPresignedFeedbackToken(e,t,{expiration:r,feedbackConfig:a}={}){const i={run_id:e,feedback_key:t,feedback_config:a};return r?typeof r=="string"?i.expires_at=r:(r?.hours||r?.minutes||r?.days)&&(i.expires_in=r):i.expires_in={hours:3},await(await this.caller.call(I(this.debug),`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:r,createdAt:a,description:i,metadata:s,id:o}){if(t.length===0)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:t[0]})).reference_dataset_id),!r==null)throw new Error("A reference dataset is required");const u={id:o,name:e,experiment_ids:t,reference_dataset_id:r,description:i,created_at:(a??new Date)?.toISOString(),extra:{}};return s&&(u.extra.metadata=s),await(await this.caller.call(I(this.debug),`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async*listPresignedFeedbackTokens(e){F(e);const t=new URLSearchParams({run_id:e});for await(const r of this._getPaginated("/feedback/tokens",t))yield*r}_selectEvalResults(e){let t;return"results"in e?t=e.results:Array.isArray(e)?t=e:t=[e],t}async _logEvaluationFeedback(e,t,r){const a=this._selectEvalResults(e),i=[];for(const s of a){let o=r||{};s.evaluatorInfo&&(o={...s.evaluatorInfo,...o});let u=null;s.targetRunId?u=s.targetRunId:t&&(u=t.id),i.push(await this.createFeedback(u,s.key,{score:s.score,value:s.value,comment:s.comment,correction:s.correction,sourceInfo:o,sourceRunId:s.sourceRunId,feedbackConfig:s.feedbackConfig,feedbackSourceType:"model"}))}return[a,i]}async logEvaluationFeedback(e,t,r){const[a]=await this._logEvaluationFeedback(e,t,r);return a}async*listAnnotationQueues(e={}){const{queueIds:t,name:r,nameContains:a,limit:i}=e,s=new URLSearchParams;t&&t.forEach((u,l)=>{F(u,`queueIds[${l}]`),s.append("ids",u)}),r&&s.append("name",r),a&&s.append("name_contains",a),s.append("limit",(i!==void 0?Math.min(i,100):100).toString());let o=0;for await(const u of this._getPaginated("/annotation-queues",s))if(yield*u,o++,i!==void 0&&o>=i)break}async createAnnotationQueue(e){const{name:t,description:r,queueId:a,rubricInstructions:i}=e,s={name:t,description:r,id:a||ue(),rubric_instructions:i},o=await this.caller.call(I(this.debug),`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(Object.entries(s).filter(([l,c])=>c!==void 0))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(o,"create annotation queue"),await o.json()}async readAnnotationQueue(e){const t=await this.caller.call(I(this.debug),`${this.apiUrl}/annotation-queues/${F(e,"queueId")}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(t,"read annotation queue"),await t.json()}async updateAnnotationQueue(e,t){const{name:r,description:a,rubricInstructions:i}=t,s=await this.caller.call(I(this.debug),`${this.apiUrl}/annotation-queues/${F(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({name:r,description:a,rubric_instructions:i}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await U(s,"update annotation queue")}async deleteAnnotationQueue(e){const t=await this.caller.call(I(this.debug),`${this.apiUrl}/annotation-queues/${F(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await U(t,"delete annotation queue")}async addRunsToAnnotationQueue(e,t){const r=await this.caller.call(I(this.debug),`${this.apiUrl}/annotation-queues/${F(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t.map((a,i)=>F(a,`runIds[${i}]`).toString())),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await U(r,"add runs to annotation queue")}async getRunFromAnnotationQueue(e,t){const r=`/annotation-queues/${F(e,"queueId")}/run`,a=await this.caller.call(I(this.debug),`${this.apiUrl}${r}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(a,"get run from annotation queue"),await a.json()}async deleteRunFromAnnotationQueue(e,t){const r=await this.caller.call(I(this.debug),`${this.apiUrl}/annotation-queues/${F(e,"queueId")}/runs/${F(t,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await U(r,"delete run from annotation queue")}async getSizeFromAnnotationQueue(e){const t=await this.caller.call(I(this.debug),`${this.apiUrl}/annotation-queues/${F(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(t,"get size from annotation queue"),await t.json()}async _currentTenantIsOwner(e){const t=await this._getSettings();return e=="-"||t.tenant_handle===e}async _ownerConflictError(e,t){const r=await this._getSettings();return new Error(`Cannot ${e} for another tenant.

      Current tenant: ${r.tenant_handle}

      Requested tenant: ${t}`)}async _getLatestCommitHash(e){const t=await this.caller.call(I(this.debug),`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await t.json();if(!t.ok){const a=typeof r.detail=="string"?r.detail:JSON.stringify(r.detail),i=new Error(`Error ${t.status}: ${t.statusText}
${a}`);throw i.statusCode=t.status,i}if(r.commits.length!==0)return r.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){const[r,a,i]=Je(e),s=await this.caller.call(I(this.debug),`${this.apiUrl}/likes/${r}/${a}`,{method:"POST",body:JSON.stringify({like:t}),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(s,`${t?"like":"unlike"} prompt`),await s.json()}async _getPromptUrl(e){const[t,r,a]=Je(e);if(await this._currentTenantIsOwner(t)){const i=await this._getSettings();return a!=="latest"?`${this.getHostUrl()}/prompts/${r}/${a.substring(0,8)}?organizationId=${i.id}`:`${this.getHostUrl()}/prompts/${r}?organizationId=${i.id}`}else return a!=="latest"?`${this.getHostUrl()}/hub/${t}/${r}/${a.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${r}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,r=>r.commits))yield*t}async*listPrompts(e){const t=new URLSearchParams;t.append("sort_field",e?.sortField??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!e?.isArchived).toString()),e?.isPublic!==void 0&&t.append("is_public",e.isPublic.toString()),e?.query&&t.append("query",e.query);for await(const r of this._getPaginated("/repos",t,a=>a.repos))yield*r}async getPrompt(e){const[t,r,a]=Je(e),i=await this.caller.call(I(this.debug),`${this.apiUrl}/repos/${t}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(i.status===404)return null;await U(i,"get prompt");const s=await i.json();return s.repo?s.repo:null}async createPrompt(e,t){const r=await this._getSettings();if(t?.isPublic&&!r.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle. 
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);const[a,i,s]=Je(e);if(!await this._currentTenantIsOwner(a))throw await this._ownerConflictError("create a prompt",a);const o={repo_handle:i,...t?.description&&{description:t.description},...t?.readme&&{readme:t.readme},...t?.tags&&{tags:t.tags},is_public:!!t?.isPublic},u=await this.caller.call(I(this.debug),`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await U(u,"create prompt");const{repo:l}=await u.json();return l}async createCommit(e,t,r){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[a,i,s]=Je(e),o=r?.parentCommitHash==="latest"||!r?.parentCommitHash?await this._getLatestCommitHash(`${a}/${i}`):r?.parentCommitHash,u={manifest:JSON.parse(JSON.stringify(t)),parent_commit:o},l=await this.caller.call(I(this.debug),`${this.apiUrl}/commits/${a}/${i}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await U(l,"create commit");const c=await l.json();return this._getPromptUrl(`${a}/${i}${c.commit_hash?`:${c.commit_hash}`:""}`)}async updateExamplesMultipart(e,t=[]){return this._updateExamplesMultipart(e,t)}async _updateExamplesMultipart(e,t=[]){if(!await this._getMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const r=new FormData;for(const o of t){const u=o.id,l={...o.metadata&&{metadata:o.metadata},...o.split&&{split:o.split}},c=we(l,`Serializing body for example with id: ${u}`),h=new Blob([c],{type:"application/json"});if(r.append(u,h),o.inputs){const d=we(o.inputs,`Serializing inputs for example with id: ${u}`),f=new Blob([d],{type:"application/json"});r.append(`${u}.inputs`,f)}if(o.outputs){const d=we(o.outputs,`Serializing outputs whle updating example with id: ${u}`),f=new Blob([d],{type:"application/json"});r.append(`${u}.outputs`,f)}if(o.attachments)for(const[d,f]of Object.entries(o.attachments)){let p,m;Array.isArray(f)?[p,m]=f:(p=f.mimeType,m=f.data);const g=new Blob([m],{type:`${p}; length=${m.byteLength}`});r.append(`${u}.attachment.${d}`,g)}if(o.attachments_operations){const d=we(o.attachments_operations,`Serializing attachments while updating example with id: ${u}`),f=new Blob([d],{type:"application/json"});r.append(`${u}.attachments_operations`,f)}}const a=e??t[0]?.dataset_id;return await(await this.caller.call(I(this.debug),`${this.apiUrl}/v1/platform/datasets/${a}/examples`,{method:"PATCH",headers:this.headers,body:r})).json()}async uploadExamplesMultipart(e,t=[]){return this._uploadExamplesMultipart(e,t)}async _uploadExamplesMultipart(e,t=[]){if(!await this._getMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const r=new FormData;for(const s of t){const o=(s.id??ue()).toString(),u={created_at:s.created_at,...s.metadata&&{metadata:s.metadata},...s.split&&{split:s.split},...s.source_run_id&&{source_run_id:s.source_run_id},...s.use_source_run_io&&{use_source_run_io:s.use_source_run_io},...s.use_source_run_attachments&&{use_source_run_attachments:s.use_source_run_attachments}},l=we(u,`Serializing body for uploaded example with id: ${o}`),c=new Blob([l],{type:"application/json"});if(r.append(o,c),s.inputs){const h=we(s.inputs,`Serializing inputs for uploaded example with id: ${o}`),d=new Blob([h],{type:"application/json"});r.append(`${o}.inputs`,d)}if(s.outputs){const h=we(s.outputs,`Serializing outputs for uploaded example with id: ${o}`),d=new Blob([h],{type:"application/json"});r.append(`${o}.outputs`,d)}if(s.attachments)for(const[h,d]of Object.entries(s.attachments)){let f,p;Array.isArray(d)?[f,p]=d:(f=d.mimeType,p=d.data);const m=new Blob([p],{type:`${f}; length=${p.byteLength}`});r.append(`${o}.attachment.${h}`,m)}}const a=await this.caller.call(I(this.debug),`${this.apiUrl}/v1/platform/datasets/${e}/examples`,{method:"POST",headers:this.headers,body:r});return await U(a,"upload examples"),await a.json()}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,a]=Je(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("update a prompt",r);const i={};if(t?.description!==void 0&&(i.description=t.description),t?.readme!==void 0&&(i.readme=t.readme),t?.tags!==void 0&&(i.tags=t.tags),t?.isPublic!==void 0&&(i.is_public=t.isPublic),t?.isArchived!==void 0&&(i.is_archived=t.isArchived),Object.keys(i).length===0)throw new Error("No valid update options provided");const s=await this.caller.call(I(this.debug),`${this.apiUrl}/repos/${r}/${a}`,{method:"PATCH",body:JSON.stringify(i),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await U(s,"update prompt"),s.json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[t,r,a]=Je(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);return await(await this.caller.call(I(this.debug),`${this.apiUrl}/repos/${t}/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async pullPromptCommit(e,t){const[r,a,i]=Je(e),s=await this.caller.call(I(this.debug),`${this.apiUrl}/commits/${r}/${a}/${i}${t?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await U(s,"pull prompt commit");const o=await s.json();return{owner:r,repo:a,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async _pullPrompt(e,t){const r=await this.pullPromptCommit(e,{includeModel:t?.includeModel});return JSON.stringify(r.manifest)}async pushPrompt(e,t){return await this.promptExists(e)?t&&Object.keys(t).some(a=>a!=="object")&&await this.updatePrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}):await this.createPrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}),t?.object?await this.createCommit(e,t?.object,{parentCommitHash:t?.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,t={}){const{sourceApiUrl:r=this.apiUrl,datasetName:a}=t,[i,s]=this.parseTokenOrUrl(e,r),o=new Mt({apiUrl:i,apiKey:"placeholder"}),u=await o.readSharedDataset(s),l=a||u.name;try{if(await this.hasDataset({datasetId:l})){console.log(`Dataset ${l} already exists in your tenant. Skipping.`);return}}catch{}const c=await o.listSharedExamples(s),h=await this.createDataset(l,{description:u.description,dataType:u.data_type||"kv",inputsSchema:u.inputs_schema_definition??void 0,outputsSchema:u.outputs_schema_definition??void 0});try{await this.createExamples({inputs:c.map(d=>d.inputs),outputs:c.flatMap(d=>d.outputs?[d.outputs]:[]),datasetId:h.id})}catch(d){throw console.error(`An error occurred while creating dataset ${l}. You should delete it manually.`),d}}parseTokenOrUrl(e,t,r=2,a="dataset"){try{return F(e),[t,e]}catch{}try{const s=new URL(e).pathname.split("/").filter(o=>o!=="");if(s.length>=r){const o=s[s.length-r];return[t,o]}else throw new Error(`Invalid public ${a} URL: ${e}`)}catch{throw new Error(`Invalid public ${a} URL or token: ${e}`)}}awaitPendingTraceBatches(){return this.manualFlushMode?(console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve()):Promise.all([...this.autoBatchQueue.items.map(({itemPromise:e})=>e),this.batchIngestCaller.queue.onIdle()])}}function Bs(n){return"dataset_id"in n||"dataset_name"in n}const Vs="0.3.29";var sa={};let qe;const Ul=()=>typeof window<"u"&&typeof window.document<"u",Bl=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Vl=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),qs=()=>typeof Deno<"u",ql=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!qs(),Hl=()=>qe||(Ul()?qe="browser":ql()?qe="node":Bl()?qe="webworker":Vl()?qe="jsdom":qs()?qe="deno":qe="other",qe);let oa;function Hs(){if(oa===void 0){const n=Hl(),e=Zl();oa={library:"langsmith",runtime:n,sdk:"langsmith-js",sdk_version:Vs,...e}}return oa}function zl(){const n=Gl()||{},e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[r,a]of Object.entries(n))(r.startsWith("LANGCHAIN_")||r.startsWith("LANGSMITH_"))&&typeof a=="string"&&!t.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=a:e[r]=a);return e}function Gl(){try{return typeof process<"u"&&sa?Object.entries(sa).reduce((n,[e,t])=>(n[e]=String(t),n),{}):void 0}catch{return}}function Ke(n){try{return typeof process<"u"?sa?.[n]:void 0}catch{return}}function Ne(n){return Ke(`LANGSMITH_${n}`)||Ke(`LANGCHAIN_${n}`)}let ua;function Zl(){if(ua!==void 0)return ua;const n=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(const t of n){const r=Ke(t);r!==void 0&&(e[t]=r)}return ua=e,e}const Wl=n=>!!["TRACING_V2","TRACING"].find(t=>Ne(t)==="true"),la=Symbol.for("lc:context_variables");function Jl(n){return n.replace(/[-:.]/g,"")}function Kl(n,e,t=1){const r=t.toFixed(0).slice(0,3).padStart(3,"0");return Jl(`${new Date(n).toISOString().slice(0,-1)}${r}Z`)+e}class Sr{constructor(e,t,r){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=t,this.project_name=r}static fromHeader(e){const t=e.split(",");let r={},a=[],i;for(const s of t){const[o,u]=s.split("="),l=decodeURIComponent(u);o==="langsmith-metadata"?r=JSON.parse(l):o==="langsmith-tags"?a=l.split(","):o==="langsmith-project"&&(i=l)}return new Sr(r,a,i)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),this.project_name&&e.push(`langsmith-project=${encodeURIComponent(this.project_name)}`),e.join(",")}}class ve{constructor(e){if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),zs(e)){Object.assign(this,{...e});return}const t=ve.getDefaultConfig(),{metadata:r,...a}=e,i=a.client??ve.getSharedClient(),s={...r,...a?.extra?.metadata};if(a.extra={...a.extra,metadata:s},Object.assign(this,{...t,...a,client:i}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.execution_order??(this.execution_order=1),this.child_execution_order??(this.child_execution_order=1),!this.dotted_order){const o=Kl(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+o:this.dotted_order=o}}static getDefaultConfig(){return{id:ue(),run_type:"chain",project_name:Ne("PROJECT")??Ke("LANGCHAIN_SESSION")??"default",child_runs:[],api_url:Ke("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:Ke("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return ve.sharedClient||(ve.sharedClient=new Mt),ve.sharedClient}createChild(e){const t=this.child_execution_order+1,r=new ve({...e,parent_run:this,project_name:this.project_name,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:t,child_execution_order:t});la in this&&(r[la]=this[la]);const a=Symbol.for("lc:child_config"),i=e.extra?.[a]??this.extra[a];if(Yl(i)){const u={...i},l=Xl(u.callbacks)?u.callbacks.copy?.():void 0;l&&(Object.assign(l,{_parentRunId:r.id}),l.handlers?.find(Gs)?.updateFromRunTree?.(r),u.callbacks=l),r.extra[a]=u}const s=new Set;let o=this;for(;o!=null&&!s.has(o.id);)s.add(o.id),o.child_execution_order=Math.max(o.child_execution_order,t),o=o.parent_run;return this.child_runs.push(r),r}async end(e,t,r=Date.now(),a){this.outputs=this.outputs??e,this.error=this.error??t,this.end_time=this.end_time??r,a&&Object.keys(a).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...a}}:{metadata:a})}_convertToCreate(e,t,r=!0){const a=e.extra??{};if(a.runtime||(a.runtime={}),t)for(const[u,l]of Object.entries(t))a.runtime[u]||(a.runtime[u]=l);let i,s;return r?(s=e.parent_run?.id,i=[]):(i=e.child_runs.map(u=>this._convertToCreate(u,t,r)),s=void 0),{id:e.id,name:e.name,start_time:e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:a,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:i,parent_run_id:s,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments}}async postRun(e=!0){try{const t=Hs(),r=await this._convertToCreate(this,t,!0);if(await this.client.createRun(r),!e){Vi("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const a of this.child_runs)await a.postRun(!1)}}catch(t){console.error(`Error in postRun for run ${this.id}:`,t)}}async patchRun(){try{const e={end_time:this.end_time,error:this.error,inputs:this.inputs,outputs:this.outputs,parent_run_id:this.parent_run?.id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments,session_name:this.project_name};await this.client.updateRun(this.id,e)}catch(e){console.error(`Error in patchRun for run ${this.id}`,e)}}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(e){this.events||(this.events=[]),typeof e=="string"?this.events.push({name:"event",time:new Date().toISOString(),message:e}):this.events.push({...e,time:e.time??new Date().toISOString()})}static fromRunnableConfig(e,t){const r=e?.callbacks;let a,i,s,o=Wl();if(r){const l=r?.getParentRunId?.()??"",c=r?.handlers?.find(h=>h?.name=="langchain_tracer");a=c?.getRun?.(l),i=c?.projectName,s=c?.client,o=o||!!c}return a?new ve({name:a.name,id:a.id,trace_id:a.trace_id,dotted_order:a.dotted_order,client:s,tracingEnabled:o,project_name:i,tags:[...new Set((a?.tags??[]).concat(e?.tags??[]))],extra:{metadata:{...a?.extra?.metadata,...e?.metadata}}}).createChild(t):new ve({...t,client:s,tracingEnabled:o,project_name:i})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,t){const r="get"in e&&typeof e.get=="function"?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,a=r["langsmith-trace"];if(!a||typeof a!="string")return;const i=a.trim(),s=i.split(".").map(l=>{const[c,h]=l.split("Z");return{strTime:c,time:Date.parse(c+"Z"),uuid:h}}),o=s[0].uuid,u={...t,name:t?.name??"parent",run_type:t?.run_type??"chain",start_time:t?.start_time??Date.now(),id:s.at(-1)?.uuid,trace_id:o,dotted_order:i};if(r.baggage&&typeof r.baggage=="string"){const l=Sr.fromHeader(r.baggage);u.metadata=l.metadata,u.tags=l.tags,u.project_name=l.project_name}return new ve(u)}toHeaders(e){const t={"langsmith-trace":this.dotted_order,baggage:new Sr(this.extra?.metadata,this.tags,this.project_name).toHeader()};if(e)for(const[r,a]of Object.entries(t))e.set(r,a);return t}}Object.defineProperty(ve,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});function zs(n){return n!==void 0&&typeof n.createChild=="function"&&typeof n.postRun=="function"}function Gs(n){return typeof n=="object"&&n!=null&&typeof n.name=="string"&&n.name==="langchain_tracer"}function Zs(n){return Array.isArray(n)&&n.some(e=>Gs(e))}function Xl(n){return typeof n=="object"&&n!=null&&Array.isArray(n.handlers)}function Yl(n){return n!==void 0&&typeof n.callbacks=="object"&&(Zs(n.callbacks?.handlers)||Zs(n.callbacks))}let Ql=class{getStore(){}run(e,t){return t()}};const ca=Symbol.for("ls:tracing_async_local_storage"),ec=new Ql;let tc=class{getInstance(){return globalThis[ca]??ec}initializeGlobalInstance(e){globalThis[ca]===void 0&&(globalThis[ca]=e)}};const rc=new tc;function nc(n=!1){const e=rc.getInstance().getStore();if(!n&&!zs(e))throw new Error(`Could not get the current run tree.

Please make sure you are calling this method within a traceable function and that tracing is enabled.`);return e}function da(n){return typeof n=="function"&&"langsmith:traceable"in n}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2022 Joachim Wester
 * MIT licensed
 */const ac=Object.prototype.hasOwnProperty;function ic(n,e){return ac.call(n,e)}function sc(n){if(Array.isArray(n)){const t=new Array(n.length);for(let r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(n);let e=[];for(let t in n)ic(n,t)&&e.push(t);return e}function _t(n){switch(typeof n){case"object":return JSON.parse(JSON.stringify(n));case"undefined":return null;default:return n}}function ha(n){let e=0;const t=n.length;let r;for(;e<t;){if(r=n.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function oc(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}function fa(n){if(n===void 0)return!0;if(n){if(Array.isArray(n)){for(let t=0,r=n.length;t<r;t++)if(fa(n[t]))return!0}else if(typeof n=="object"){const t=sc(n),r=t.length;for(var e=0;e<r;e++)if(fa(n[t[e]]))return!0}}return!1}function Ws(n,e){const t=[n];for(const r in e){const a=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof a<"u"&&t.push(`${r}: ${a}`)}return t.join(`
`)}class uc extends Error{constructor(e,t,r,a,i){super(Ws(e,{name:t,index:r,operation:a,tree:i})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.setPrototypeOf(this,new.target.prototype),this.message=Ws(e,{name:t,index:r,operation:a,tree:i})}}const Y=uc,wt={add:function(n,e,t){return n[e]=this.value,{newDocument:t}},remove:function(n,e,t){var r=n[e];return delete n[e],{newDocument:t,removed:r}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:function(n,e,t){let r=pa(t,this.path);r&&(r=_t(r));const a=Ft(t,{op:"remove",path:this.from}).removed;return Ft(t,{op:"add",path:this.path,value:a}),{newDocument:t,removed:r}},copy:function(n,e,t){const r=pa(t,this.from);return Ft(t,{op:"add",path:this.path,value:_t(r)}),{newDocument:t}},test:function(n,e,t){return{newDocument:t,test:Pr(n[e],this.value)}},_get:function(n,e,t){return this.value=n[e],{newDocument:t}}};var lc={add:function(n,e,t){return ha(e)?n.splice(e,0,this.value):n[e]=this.value,{newDocument:t,index:e}},remove:function(n,e,t){var r=n.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:wt.move,copy:wt.copy,test:wt.test,_get:wt._get};function pa(n,e){if(e=="")return n;var t={op:"_get",path:e};return Ft(n,t),t.value}function Ft(n,e,t=!1,r=!0,a=!0,i=0){if(t&&(typeof t=="function"?t(e,0,n,e.path):ma(e,0)),e.path===""){let s={newDocument:n};if(e.op==="add")return s.newDocument=e.value,s;if(e.op==="replace")return s.newDocument=e.value,s.removed=n,s;if(e.op==="move"||e.op==="copy")return s.newDocument=pa(n,e.from),e.op==="move"&&(s.removed=n),s;if(e.op==="test"){if(s.test=Pr(n,e.value),s.test===!1)throw new Y("Test operation failed","TEST_OPERATION_FAILED",i,e,n);return s.newDocument=n,s}else{if(e.op==="remove")return s.removed=n,s.newDocument=null,s;if(e.op==="_get")return e.value=n,s;if(t)throw new Y("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,e,n);return s}}else{r||(n=_t(n));const o=(e.path||"").split("/");let u=n,l=1,c=o.length,h,d,f;for(typeof t=="function"?f=t:f=ma;;){if(d=o[l],d&&d.indexOf("~")!=-1&&(d=oc(d)),a&&(d=="__proto__"||d=="prototype"&&l>0&&o[l-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&h===void 0&&(u[d]===void 0?h=o.slice(0,l).join("/"):l==c-1&&(h=e.path),h!==void 0&&f(e,0,n,h)),l++,Array.isArray(u)){if(d==="-")d=u.length;else{if(t&&!ha(d))throw new Y("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,e,n);ha(d)&&(d=~~d)}if(l>=c){if(t&&e.op==="add"&&d>u.length)throw new Y("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,e,n);const p=lc[e.op].call(e,u,d,n);if(p.test===!1)throw new Y("Test operation failed","TEST_OPERATION_FAILED",i,e,n);return p}}else if(l>=c){const p=wt[e.op].call(e,u,d,n);if(p.test===!1)throw new Y("Test operation failed","TEST_OPERATION_FAILED",i,e,n);return p}if(u=u[d],t&&l<c&&(!u||typeof u!="object"))throw new Y("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,e,n)}}}function Tr(n,e,t,r=!0,a=!0){if(t&&!Array.isArray(e))throw new Y("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(n=_t(n));const i=new Array(e.length);for(let s=0,o=e.length;s<o;s++)i[s]=Ft(n,e[s],t,!0,a,s),n=i[s].newDocument;return i.newDocument=n,i}function ma(n,e,t,r){if(typeof n!="object"||n===null||Array.isArray(n))throw new Y("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,n,t);if(wt[n.op]){if(typeof n.path!="string")throw new Y("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,n,t);if(n.path.indexOf("/")!==0&&n.path.length>0)throw new Y('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,n,t);if((n.op==="move"||n.op==="copy")&&typeof n.from!="string")throw new Y("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&n.value===void 0)throw new Y("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&fa(n.value))throw new Y("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,n,t);if(t){if(n.op=="add"){var a=n.path.split("/").length,i=r.split("/").length;if(a!==i+1&&a!==i)throw new Y("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,n,t)}else if(n.op==="replace"||n.op==="remove"||n.op==="_get"){if(n.path!==r)throw new Y("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,n,t)}else if(n.op==="move"||n.op==="copy"){var s={op:"_get",path:n.from,value:void 0},o=cc([s],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new Y("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,n,t)}}}else throw new Y("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,n,t)}function cc(n,e,t){try{if(!Array.isArray(n))throw new Y("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)Tr(_t(e),_t(n),t||!0);else{t=t||ma;for(var r=0;r<n.length;r++)t(n[r],r,e,void 0)}}catch(a){if(a instanceof Y)return a;throw a}}function Pr(n,e){if(n===e)return!0;if(n&&e&&typeof n=="object"&&typeof e=="object"){var t=Array.isArray(n),r=Array.isArray(e),a,i,s;if(t&&r){if(i=n.length,i!=e.length)return!1;for(a=i;a--!==0;)if(!Pr(n[a],e[a]))return!1;return!0}if(t!=r)return!1;var o=Object.keys(n);if(i=o.length,i!==Object.keys(e).length)return!1;for(a=i;a--!==0;)if(!e.hasOwnProperty(o[a]))return!1;for(a=i;a--!==0;)if(s=o[a],!Pr(n[s],e[s]))return!1;return!0}return n!==n&&e!==e}var dc={};const hc=()=>typeof window<"u"&&typeof window.document<"u",fc=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",pc=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),ga=()=>typeof Deno<"u",mc=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!ga(),gc=()=>{let n;return hc()?n="browser":mc()?n="node":fc()?n="webworker":pc()?n="jsdom":ga()?n="deno":n="other",n};let ya;async function yc(){return ya===void 0&&(ya={library:"langchain-js",runtime:gc()}),ya}function Xe(n){try{return typeof process<"u"?dc?.[n]:ga()?Deno?.env.get(n):void 0}catch{return}}class bc{}function _c(n){return"lc_prefer_streaming"in n&&n.lc_prefer_streaming}class Dt extends bc{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,ni(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:Xe("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return at.prototype.toJSON.call(this)}toJSONNotImplemented(){return at.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends Dt{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:ue()}),Object.assign(this,e)}}return new t}}const wc=n=>{const e=n;return e!==void 0&&typeof e.copy=="function"&&typeof e.name=="string"&&typeof e.awaitHandlers=="boolean"};function ba(n,e){return n&&!Array.isArray(n)&&typeof n=="object"?n:{[e]:n}}function vc(n){return n.replace(/[-:.]/g,"")}function Ec(n,e,t){const r=t.toFixed(0).slice(0,3).padStart(3,"0");return vc(`${new Date(n).toISOString().slice(0,-1)}${r}Z`)+e}function Ut(n){return typeof n._addRunToRunMap=="function"}class Bt extends Dt{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){const t=Ec(e.start_time,e.id,e.execution_order),r={...e};if(r.parent_run_id!==void 0){const a=this.runMap.get(r.parent_run_id);a&&(this._addChildRun(a,r),a.child_execution_order=Math.max(a.child_execution_order,r.child_execution_order),r.trace_id=a.trace_id,a.dotted_order!==void 0&&(r.dotted_order=[a.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;return this.runMap.set(r.id,r),r}async _endTrace(e){const t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await this.onRunUpdate?.(e)}_getExecutionOrder(e){const t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,r,a,i,s,o,u){const l=this._getExecutionOrder(a),c=Date.now(),h=o?{...i,metadata:o}:i,d={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{prompts:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:h??{},tags:s||[]};return this._addRunToRunMap(d)}async handleLLMStart(e,t,r,a,i,s,o,u){const l=this.runMap.get(r)??this._createRunForLLMStart(e,t,r,a,i,s,o,u);return await this.onRunCreate?.(l),await this.onLLMStart?.(l),l}_createRunForChatModelStart(e,t,r,a,i,s,o,u){const l=this._getExecutionOrder(a),c=Date.now(),h=o?{...i,metadata:o}:i,d={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{messages:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:h??{},tags:s||[]};return this._addRunToRunMap(d)}async handleChatModelStart(e,t,r,a,i,s,o,u){const l=this.runMap.get(r)??this._createRunForChatModelStart(e,t,r,a,i,s,o,u);return await this.onRunCreate?.(l),await this.onLLMStart?.(l),l}async handleLLMEnd(e,t,r,a,i){const s=this.runMap.get(t);if(!s||s?.run_type!=="llm")throw new Error("No LLM run to end.");return s.end_time=Date.now(),s.outputs=e,s.events.push({name:"end",time:new Date(s.end_time).toISOString()}),s.extra={...s.extra,...i},await this.onLLMEnd?.(s),await this._endTrace(s),s}async handleLLMError(e,t,r,a,i){const s=this.runMap.get(t);if(!s||s?.run_type!=="llm")throw new Error("No LLM run to end.");return s.end_time=Date.now(),s.error=this.stringifyError(e),s.events.push({name:"error",time:new Date(s.end_time).toISOString()}),s.extra={...s.extra,...i},await this.onLLMError?.(s),await this._endTrace(s),s}_createRunForChainStart(e,t,r,a,i,s,o,u){const l=this._getExecutionOrder(a),c=Date.now(),h={id:r,name:u??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:t,execution_order:l,child_execution_order:l,run_type:o??"chain",child_runs:[],extra:s?{metadata:s}:{},tags:i||[]};return this._addRunToRunMap(h)}async handleChainStart(e,t,r,a,i,s,o,u){const l=this.runMap.get(r)??this._createRunForChainStart(e,t,r,a,i,s,o,u);return await this.onRunCreate?.(l),await this.onChainStart?.(l),l}async handleChainEnd(e,t,r,a,i){const s=this.runMap.get(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.outputs=ba(e,"output"),s.events.push({name:"end",time:new Date(s.end_time).toISOString()}),i?.inputs!==void 0&&(s.inputs=ba(i.inputs,"input")),await this.onChainEnd?.(s),await this._endTrace(s),s}async handleChainError(e,t,r,a,i){const s=this.runMap.get(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.error=this.stringifyError(e),s.events.push({name:"error",time:new Date(s.end_time).toISOString()}),i?.inputs!==void 0&&(s.inputs=ba(i.inputs,"input")),await this.onChainError?.(s),await this._endTrace(s),s}_createRunForToolStart(e,t,r,a,i,s,o){const u=this._getExecutionOrder(a),l=Date.now(),c={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:t},execution_order:u,child_execution_order:u,run_type:"tool",child_runs:[],extra:s?{metadata:s}:{},tags:i||[]};return this._addRunToRunMap(c)}async handleToolStart(e,t,r,a,i,s,o){const u=this.runMap.get(r)??this._createRunForToolStart(e,t,r,a,i,s,o);return await this.onRunCreate?.(u),await this.onToolStart?.(u),u}async handleToolEnd(e,t){const r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onToolEnd?.(r),await this._endTrace(r),r}async handleToolError(e,t){const r=this.runMap.get(t);if(!r||r?.run_type!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onToolError?.(r),await this._endTrace(r),r}async handleAgentAction(e,t){const r=this.runMap.get(t);if(!r||r?.run_type!=="chain")return;const a=r;a.actions=a.actions||[],a.actions.push(e),a.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentAction?.(r)}async handleAgentEnd(e,t){const r=this.runMap.get(t);!r||r?.run_type!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentEnd?.(r))}_createRunForRetrieverStart(e,t,r,a,i,s,o){const u=this._getExecutionOrder(a),l=Date.now(),c={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:t},execution_order:u,child_execution_order:u,run_type:"retriever",child_runs:[],extra:s?{metadata:s}:{},tags:i||[]};return this._addRunToRunMap(c)}async handleRetrieverStart(e,t,r,a,i,s,o){const u=this.runMap.get(r)??this._createRunForRetrieverStart(e,t,r,a,i,s,o);return await this.onRunCreate?.(u),await this.onRetrieverStart?.(u),u}async handleRetrieverEnd(e,t){const r=this.runMap.get(t);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onRetrieverEnd?.(r),await this._endTrace(r),r}async handleRetrieverError(e,t){const r=this.runMap.get(t);if(!r||r?.run_type!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onRetrieverError?.(r),await this._endTrace(r),r}async handleText(e,t){const r=this.runMap.get(t);!r||r?.run_type!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await this.onText?.(r))}async handleLLMNewToken(e,t,r,a,i,s){const o=this.runMap.get(r);if(!o||o?.run_type!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:s?.chunk}}),await this.onLLMNewToken?.(o,e,{chunk:s?.chunk}),o}}var Ar={exports:{}};Ar.exports;var Js;function Oc(){return Js||(Js=1,function(n){const t=(i=0)=>s=>`\x1B[${38+i};5;${s}m`,r=(i=0)=>(s,o,u)=>`\x1B[${38+i};2;${s};${o};${u}m`;function a(){const i=new Map,s={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};s.color.gray=s.color.blackBright,s.bgColor.bgGray=s.bgColor.bgBlackBright,s.color.grey=s.color.blackBright,s.bgColor.bgGrey=s.bgColor.bgBlackBright;for(const[o,u]of Object.entries(s)){for(const[l,c]of Object.entries(u))s[l]={open:`\x1B[${c[0]}m`,close:`\x1B[${c[1]}m`},u[l]=s[l],i.set(c[0],c[1]);Object.defineProperty(s,o,{value:u,enumerable:!1})}return Object.defineProperty(s,"codes",{value:i,enumerable:!1}),s.color.close="\x1B[39m",s.bgColor.close="\x1B[49m",s.color.ansi256=t(),s.color.ansi16m=r(),s.bgColor.ansi256=t(10),s.bgColor.ansi16m=r(10),Object.defineProperties(s,{rgbToAnsi256:{value:(o,u,l)=>o===u&&u===l?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(u/255*5)+Math.round(l/255*5),enumerable:!1},hexToRgb:{value:o=>{const u=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!u)return[0,0,0];let{colorString:l}=u.groups;l.length===3&&(l=l.split("").map(h=>h+h).join(""));const c=Number.parseInt(l,16);return[c>>16&255,c>>8&255,c&255]},enumerable:!1},hexToAnsi256:{value:o=>s.rgbToAnsi256(...s.hexToRgb(o)),enumerable:!1}}),s}Object.defineProperty(n,"exports",{enumerable:!0,get:a})}(Ar)),Ar.exports}var xc=Oc(),Ks=be(xc);function ce(n,e){return`${n.open}${e}${n.close}`}function Se(n,e){try{return JSON.stringify(n,null,2)}catch{return e}}function Xs(n){return typeof n=="string"?n.trim():n==null?n:Se(n,n.toString())}function Ye(n){if(!n.end_time)return"";const e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}const{color:me}=Ks;class Ys extends Bt{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let r=e;for(;r.parent_run_id;){const a=this.runMap.get(r.parent_run_id);if(a)t.push(a),r=a;else break}return t}getBreadcrumbs(e){const r=[...this.getParents(e).reverse(),e].map((a,i,s)=>{const o=`${a.execution_order}:${a.run_type}:${a.name}`;return i===s.length-1?ce(Ks.bold,o):o}).join(" > ");return ce(me.grey,r)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${ce(me.green,"[chain/start]")} [${t}] Entering Chain run with input: ${Se(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${ce(me.cyan,"[chain/end]")} [${t}] [${Ye(e)}] Exiting Chain run with output: ${Se(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${ce(me.red,"[chain/error]")} [${t}] [${Ye(e)}] Chain run errored with error: ${Se(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(a=>a.trim())}:e.inputs;console.log(`${ce(me.green,"[llm/start]")} [${t}] Entering LLM run with input: ${Se(r,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${ce(me.cyan,"[llm/end]")} [${t}] [${Ye(e)}] Exiting LLM run with output: ${Se(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${ce(me.red,"[llm/error]")} [${t}] [${Ye(e)}] LLM run errored with error: ${Se(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${ce(me.green,"[tool/start]")} [${t}] Entering Tool run with input: "${Xs(e.inputs.input)}"`)}onToolEnd(e){const t=this.getBreadcrumbs(e);console.log(`${ce(me.cyan,"[tool/end]")} [${t}] [${Ye(e)}] Exiting Tool run with output: "${Xs(e.outputs?.output)}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${ce(me.red,"[tool/error]")} [${t}] [${Ye(e)}] Tool run errored with error: ${Se(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${ce(me.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${Se(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${ce(me.cyan,"[retriever/end]")} [${t}] [${Ye(e)}] Exiting Retriever run with output: ${Se(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${ce(me.red,"[retriever/error]")} [${t}] [${Ye(e)}] Retriever run errored with error: ${Se(e.error,"[error]")}`)}onAgentAction(e){const t=e,r=this.getBreadcrumbs(e);console.log(`${ce(me.blue,"[agent/action]")} [${r}] Agent selected action: ${Se(t.actions[t.actions.length-1],"[action]")}`)}}let _a;const Sc=()=>{if(_a===void 0){const n=Xe("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"?{blockOnRootRunFinalization:!0}:{};_a=new Mt(n)}return _a};class Vt extends Bt{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:r,client:a}=e;this.projectName=r??Xe("LANGCHAIN_PROJECT")??Xe("LANGCHAIN_SESSION"),this.exampleId=t,this.client=a??Sc();const i=Vt.getTraceableRunTree();i&&this.updateFromRunTree(i)}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await yc()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id,extra:e.extra,session_name:this.projectName};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}updateFromRunTree(e){let t=e;const r=new Set;for(;t.parent_run&&!(r.has(t.id)||(r.add(t.id),!t.parent_run));)t=t.parent_run;r.clear();const a=[t];for(;a.length>0;){const i=a.shift();!i||r.has(i.id)||(r.add(i.id),this.runMap.set(i.id,i),i.child_runs&&a.push(...i.child_runs))}this.client=e.client??this.client,this.projectName=e.project_name??this.projectName,this.exampleId=e.reference_example_id??this.exampleId}convertToRunTree(e){const t={},r=[];for(const[a,i]of this.runMap){const s=new ve({...i,child_runs:[],parent_run:void 0,client:this.client,project_name:this.projectName,reference_example_id:this.exampleId,tracingEnabled:!0});t[a]=s,r.push([a,i.dotted_order])}r.sort((a,i)=>!a[1]||!i[1]?0:a[1].localeCompare(i[1]));for(const[a]of r){const i=this.runMap.get(a),s=t[a];if(!(!i||!s)&&i.parent_run_id){const o=t[i.parent_run_id];o&&(o.child_runs.push(s),s.parent_run=o)}}return t[e]}static getTraceableRunTree(){try{return nc(!0)}catch{return}}}const Qs=Symbol.for("ls:tracing_async_local_storage"),Rr=Symbol.for("lc:context_variables"),Tc=n=>{globalThis[Qs]=n},qt=()=>globalThis[Qs];let Ht;function Pc(){const n="default"in Ve?Ve.default:Ve;return new n({autoStart:!0,concurrency:1})}function Ac(){return typeof Ht>"u"&&(Ht=Pc()),Ht}async function ee(n,e){if(e===!0){const t=qt();t!==void 0?await t.run(void 0,async()=>n()):await n()}else Ht=Ac(),Ht.add(async()=>{const t=qt();t!==void 0?await t.run(void 0,async()=>n()):await n()})}const Rc=n=>!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(t=>Xe(t)==="true");function eo(n){const e=qt();return e===void 0?void 0:e.getStore()?.[Rr]?.[n]}const Ic=Symbol("lc:configure_hooks"),kc=()=>eo(Ic)||[];class Cc{setHandler(e){return this.setHandlers([e])}}class Ir{constructor(e,t,r,a,i,s,o,u){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:u})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(t=>ee(async()=>{try{await t.handleText?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleCustomEvent(e,t,r,a,i){await Promise.all(this.handlers.map(s=>ee(async()=>{try{await s.handleCustomEvent?.(e,t,this.runId,this.tags,this.metadata)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleCustomEvent: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}}class $c extends Ir{getChild(e){const t=new ge(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>ee(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw r}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>ee(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${r}`),t.raiseError)throw e}},t.awaitHandlers)))}}class to extends Ir{async handleLLMNewToken(e,t,r,a,i,s){await Promise.all(this.handlers.map(o=>ee(async()=>{if(!o.ignoreLLM)try{await o.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,s)}catch(u){if((o.raiseError?console.error:console.warn)(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${u}`),o.raiseError)throw u}},o.awaitHandlers)))}async handleLLMError(e,t,r,a,i){await Promise.all(this.handlers.map(s=>ee(async()=>{if(!s.ignoreLLM)try{await s.handleLLMError?.(e,this.runId,this._parentRunId,this.tags,i)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleLLMError: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}async handleLLMEnd(e,t,r,a,i){await Promise.all(this.handlers.map(s=>ee(async()=>{if(!s.ignoreLLM)try{await s.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags,i)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleLLMEnd: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}}class jc extends Ir{getChild(e){const t=new ge(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,a,i){await Promise.all(this.handlers.map(s=>ee(async()=>{if(!s.ignoreChain)try{await s.handleChainError?.(e,this.runId,this._parentRunId,this.tags,i)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleChainError: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}async handleChainEnd(e,t,r,a,i){await Promise.all(this.handlers.map(s=>ee(async()=>{if(!s.ignoreChain)try{await s.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,i)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleChainEnd: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>ee(async()=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>ee(async()=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}}class Nc extends Ir{getChild(e){const t=new ge(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>ee(async()=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>ee(async()=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${r}`),t.raiseError)throw r}},t.awaitHandlers)))}}class ge extends Cc{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,a=void 0,i=void 0,s=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(l,c)=>{const h=c===0&&r?r:ue();return await Promise.all(this.handlers.map(d=>{if(!d.ignoreLLM)return Ut(d)&&d._createRunForLLMStart(e,[l],h,this._parentRunId,i,this.tags,this.metadata,u),ee(async()=>{try{await d.handleLLMStart?.(e,[l],h,this._parentRunId,i,this.tags,this.metadata,u)}catch(f){if((d.raiseError?console.error:console.warn)(`Error in handler ${d.constructor.name}, handleLLMStart: ${f}`),d.raiseError)throw f}},d.awaitHandlers)})),new to(h,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,a=void 0,i=void 0,s=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(l,c)=>{const h=c===0&&r?r:ue();return await Promise.all(this.handlers.map(d=>{if(!d.ignoreLLM)return Ut(d)&&d._createRunForChatModelStart(e,[l],h,this._parentRunId,i,this.tags,this.metadata,u),ee(async()=>{try{if(d.handleChatModelStart)await d.handleChatModelStart?.(e,[l],h,this._parentRunId,i,this.tags,this.metadata,u);else if(d.handleLLMStart){const f=zr(l);await d.handleLLMStart?.(e,[f],h,this._parentRunId,i,this.tags,this.metadata,u)}}catch(f){if((d.raiseError?console.error:console.warn)(`Error in handler ${d.constructor.name}, handleLLMStart: ${f}`),d.raiseError)throw f}},d.awaitHandlers)})),new to(h,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=ue(),a=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreChain)return Ut(u)&&u._createRunForChainStart(e,t,r,this._parentRunId,this.tags,this.metadata,a,o),ee(async()=>{try{await u.handleChainStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,a,o)}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleChainStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new jc(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=ue(),a=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreAgent)return Ut(u)&&u._createRunForToolStart(e,t,r,this._parentRunId,this.tags,this.metadata,o),ee(async()=>{try{await u.handleToolStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o)}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleToolStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new Nc(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=ue(),a=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreRetriever)return Ut(u)&&u._createRunForRetrieverStart(e,t,r,this._parentRunId,this.tags,this.metadata,o),ee(async()=>{try{await u.handleRetrieverStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o)}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new $c(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,r,a,i){await Promise.all(this.handlers.map(s=>ee(async()=>{if(!s.ignoreCustomEvent)try{await s.handleCustomEvent?.(e,t,r,this.tags,this.metadata)}catch(o){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleCustomEvent: ${o}`),s.raiseError)throw o}},s.awaitHandlers)))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const r=new ge(this._parentRunId);for(const a of this.handlers){const i=this.inheritableHandlers.includes(a);r.addHandler(a,i)}for(const a of this.tags){const i=this.inheritableTags.includes(a);r.addTags([a],i)}for(const a of Object.keys(this.metadata)){const i=Object.keys(this.inheritableMetadata).includes(a);r.addMetadata({[a]:this.metadata[a]},i)}for(const a of e)r.handlers.filter(i=>i.name==="console_callback_handler").some(i=>i.name===a.name)||r.addHandler(a,t);return r}static fromHandlers(e){class t extends Dt{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:ue()}),Object.assign(this,e)}}const r=new this;return r.addHandler(new t),r}static configure(e,t,r,a,i,s,o){return this._configureSync(e,t,r,a,i,s,o)}static _configureSync(e,t,r,a,i,s,o){let u;(e||t)&&(Array.isArray(e)||!e?(u=new ge,u.setHandlers(e?.map(kr)??[],!0)):u=e,u=u.copy(Array.isArray(t)?t.map(kr):t?.handlers,!1));const l=Xe("LANGCHAIN_VERBOSE")==="true"||o?.verbose,c=Vt.getTraceableRunTree()?.tracingEnabled||Rc(),h=c||(Xe("LANGCHAIN_TRACING")??!1);if(l||h){if(u||(u=new ge),l&&!u.handlers.some(d=>d.name===Ys.prototype.name)){const d=new Ys;u.addHandler(d,!0)}if(h&&!u.handlers.some(d=>d.name==="langchain_tracer")&&c){const d=new Vt;u.addHandler(d,!0),u._parentRunId=Vt.getTraceableRunTree()?.id??u._parentRunId}}for(const{contextVar:d,inheritable:f=!0,handlerClass:p,envVar:m}of kc()){const g=m&&Xe(m)==="true"&&p;let y;const _=d!==void 0?eo(d):void 0;_&&wc(_)?y=_:g&&(y=new p({})),y!==void 0&&(u||(u=new ge),u.handlers.some(b=>b.name===y.name)||u.addHandler(y,f))}return(r||a)&&u&&(u.addTags(r??[]),u.addTags(a??[],!1)),(i||s)&&u&&(u.addMetadata(i??{}),u.addMetadata(s??{},!1)),u}}function kr(n){return"name"in n?n:Dt.fromMethods(n)}class Lc{getStore(){}run(e,t){return t()}enterWith(e){}}const Mc=new Lc,ro=Symbol.for("lc:child_config");class Fc{getInstance(){return qt()??Mc}getRunnableConfig(){return this.getInstance().getStore()?.extra?.[ro]}runWithConfig(e,t,r){const a=ge._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata),i=this.getInstance(),s=i.getStore(),o=a?.getParentRunId(),u=a?.handlers?.find(c=>c?.name==="langchain_tracer");let l;return u&&o?l=u.convertToRunTree(o):r||(l=new ve({name:"<runnable_lambda>",tracingEnabled:!1})),l&&(l.extra={...l.extra,[ro]:e}),s!==void 0&&s[Rr]!==void 0&&(l===void 0&&(l={}),l[Rr]=s[Rr]),i.run(l,t)}initializeGlobalInstance(e){qt()===void 0&&Tc(e)}}const Qe=new Fc,wa=25;async function Ae(n){return ge._configureSync(n?.callbacks,void 0,n?.tags,void 0,n?.metadata)}function no(...n){const e={};for(const t of n.filter(r=>!!r))for(const r of Object.keys(t))if(r==="metadata")e[r]={...e[r],...t[r]};else if(r==="tags"){const a=e[r]??[];e[r]=[...new Set(a.concat(t[r]??[]))]}else if(r==="configurable")e[r]={...e[r],...t[r]};else if(r==="timeout")e.timeout===void 0?e.timeout=t.timeout:t.timeout!==void 0&&(e.timeout=Math.min(e.timeout,t.timeout));else if(r==="signal")e.signal===void 0?e.signal=t.signal:t.signal!==void 0&&("any"in AbortSignal?e.signal=AbortSignal.any([e.signal,t.signal]):e.signal=t.signal);else if(r==="callbacks"){const a=e.callbacks,i=t.callbacks;if(Array.isArray(i))if(!a)e.callbacks=i;else if(Array.isArray(a))e.callbacks=a.concat(i);else{const s=a.copy();for(const o of i)s.addHandler(kr(o),!0);e.callbacks=s}else if(i)if(!a)e.callbacks=i;else if(Array.isArray(a)){const s=i.copy();for(const o of a)s.addHandler(kr(o),!0);e.callbacks=s}else e.callbacks=new ge(i._parentRunId,{handlers:a.handlers.concat(i.handlers),inheritableHandlers:a.inheritableHandlers.concat(i.inheritableHandlers),tags:Array.from(new Set(a.tags.concat(i.tags))),inheritableTags:Array.from(new Set(a.inheritableTags.concat(i.inheritableTags))),metadata:{...a.metadata,...i.metadata}})}else{const a=r;e[a]=t[a]??e[a]}return e}const Dc=new Set(["string","number","boolean"]);function J(n){const e=Qe.getRunnableConfig();let t={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(e){const{runId:r,runName:a,...i}=e;t=Object.entries(i).reduce((s,[o,u])=>(u!==void 0&&(s[o]=u),s),t)}if(n&&(t=Object.entries(n).reduce((r,[a,i])=>(i!==void 0&&(r[a]=i),r),t)),t?.configurable)for(const r of Object.keys(t.configurable))Dc.has(typeof t.configurable[r])&&!t.metadata?.[r]&&(t.metadata||(t.metadata={}),t.metadata[r]=t.configurable[r]);if(t.timeout!==void 0){if(t.timeout<=0)throw new Error("Timeout must be a positive number");const r=AbortSignal.timeout(t.timeout);t.signal!==void 0?"any"in AbortSignal&&(t.signal=AbortSignal.any([t.signal,r])):t.signal=r,delete t.timeout}return t}function oe(n={},{callbacks:e,maxConcurrency:t,recursionLimit:r,runName:a,configurable:i,runId:s}={}){const o=J(n);return e!==void 0&&(delete o.runName,o.callbacks=e),r!==void 0&&(o.recursionLimit=r),t!==void 0&&(o.maxConcurrency=t),a!==void 0&&(o.runName=a),i!==void 0&&(o.configurable={...o.configurable,...i}),s!==void 0&&delete o.runId,o}function vt(n){return n?{configurable:n.configurable,recursionLimit:n.recursionLimit,callbacks:n.callbacks,tags:n.tags,metadata:n.metadata,maxConcurrency:n.maxConcurrency,timeout:n.timeout,signal:n.signal}:void 0}async function et(n,e){if(e===void 0)return n;let t;return Promise.race([n.catch(r=>{if(!e?.aborted)throw r}),new Promise((r,a)=>{t=()=>{a(new Error("Aborted"))},e.addEventListener("abort",t),e.aborted&&a(new Error("Aborted"))})]).finally(()=>e.removeEventListener("abort",t))}class Ee extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(e){const t=e.getReader();return new Ee({start(r){return a();function a(){return t.read().then(({done:i,value:s})=>{if(i){r.close();return}return r.enqueue(s),a()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new Ee({async pull(t){const{value:r,done:a}=await e.next();a&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}}function ao(n,e=2){const t=Array.from({length:e},()=>[]);return t.map(async function*(a){for(;;)if(a.length===0){const i=await n.next();for(const s of t)s.push(i)}else{if(a[0].done)return;yield a.shift().value}})}function Le(n,e){if(Array.isArray(n)&&Array.isArray(e))return n.concat(e);if(typeof n=="string"&&typeof e=="string")return n+e;if(typeof n=="number"&&typeof e=="number")return n+e;if("concat"in n&&typeof n.concat=="function")return n.concat(e);if(typeof n=="object"&&typeof e=="object"){const t={...n};for(const[r,a]of Object.entries(e))r in t&&!Array.isArray(t[r])?t[r]=Le(t[r],a):t[r]=a;return t}else throw new Error(`Cannot concat ${typeof n} and ${typeof e}`)}class Et{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.signal=e.signal??this.config?.signal,this.setup=new Promise((t,r)=>{Qe.runWithConfig(vt(e.config),async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,r):this.firstResult.then(a=>t(void 0),r)},!0)})}async next(...e){return this.signal?.throwIfAborted(),this.firstResultUsed?Qe.runWithConfig(vt(this.config),this.signal?async()=>et(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}}async function Uc(n,e,t,r,...a){const i=new Et({generator:e,startSetup:t,signal:r}),s=await i.setup;return{output:n(i,s,...a),setup:s}}class tt{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),r=Tr({},t);return new zt({ops:t,state:r[r.length-1].newDocument})}}class zt extends tt{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),r=Tr(this.state,e.ops);return new zt({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){const t=Tr({},e.ops);return new zt({ops:e.ops,state:t[t.length-1].newDocument})}}const Bc=n=>n.name==="log_stream_tracer";async function io(n,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:t}=n;if(["retriever","llm","prompt"].includes(n.run_type))return t;if(!(Object.keys(t).length===1&&t?.input===""))return t.input}async function so(n,e){const{outputs:t}=n;return e==="original"||["retriever","llm","prompt"].includes(n.run_type)?t:t!==void 0&&Object.keys(t).length===1&&t?.output!==void 0?t.output:t}function Vc(n){return n!==void 0&&n.message!==void 0}class oo extends Bt{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Ee.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(a=>this.includeTags?.includes(a))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(a=>!this.excludeTags?.includes(a))),r}async*tapOutputIterable(e,t){for await(const r of t){if(e!==this.rootId){const a=this.keyMapByRunId[e];a&&await this.writer.write(new tt({ops:[{op:"add",path:`/logs/${a}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new tt({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await io(e,this._schemaFormat)),await this.writer.write(new tt({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(t===void 0)return;const r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await io(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await so(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const a=new tt({ops:r});await this.writer.write(a)}finally{if(e.id===this.rootId){const t=new tt({ops:[{op:"replace",path:"/final_output",value:await so(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){const a=this.keyMapByRunId[e.id];if(a===void 0)return;const i=e.inputs.messages!==void 0;let s;i?Vc(r?.chunk)?s=r?.chunk:s=new ar({id:`run-${e.id}`,content:t}):s=t;const o=new tt({ops:[{op:"add",path:`/logs/${a}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${a}/streamed_output/-`,value:s}]});await this.writer.write(o)}}const uo="__run";class st{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new st({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}function Cr({name:n,serialized:e}){return n!==void 0?n:e?.name!==void 0?e.name:e?.id!==void 0&&Array.isArray(e?.id)?e.id[e.id.length-1]:"Unnamed"}const qc=n=>n.name==="event_stream_tracer";class Hc extends Bt{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Ee.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const t=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(r=r||t.find(a=>this.includeTags?.includes(a))!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(r=r&&t.every(a=>!this.excludeTags?.includes(a))),r}async*tapOutputIterable(e,t){const r=await t.next();if(r.done)return;const a=this.runInfoMap.get(e);if(a===void 0){yield r.value;return}function i(o,u){return o==="llm"&&typeof u=="string"?new st({text:u}):u}let s=this.tappedPromises.get(e);if(s===void 0){let o;s=new Promise(u=>{o=u}),this.tappedPromises.set(e,s);try{const u={event:`on_${a.runType}_stream`,run_id:e,name:a.name,tags:a.tags,metadata:a.metadata,data:{}};await this.send({...u,data:{chunk:i(a.runType,r.value)}},a),yield r.value;for await(const l of t)a.runType!=="tool"&&a.runType!=="retriever"&&await this.send({...u,data:{chunk:i(a.runType,l)}},a),yield l}finally{o()}}else{yield r.value;for await(const o of t)yield o}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){const r=this.tappedPromises.get(e.run_id);r!==void 0?r.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){const t=Cr(e),r=e.inputs.messages!==void 0?"chat_model":"llm",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,a);const i=`on_${r}_start`;await this.send({event:i,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onLLMNewToken(e,t,r){const a=this.runInfoMap.get(e.id);let i,s;if(a===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(this.runInfoMap.size!==1){if(a.runType==="chat_model")s="on_chat_model_stream",r?.chunk===void 0?i=new ar({content:t,id:`run-${e.id}`}):i=r.chunk.message;else if(a.runType==="llm")s="on_llm_stream",r?.chunk===void 0?i=new st({text:t}):i=r.chunk;else throw new Error(`Unexpected run type ${a.runType}`);await this.send({event:s,data:{chunk:i},run_id:e.id,name:a.name,tags:a.tags,metadata:a.metadata},a)}}async onLLMEnd(e){const t=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let r;if(t===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const a=e.outputs?.generations;let i;if(t.runType==="chat_model"){for(const s of a??[]){if(i!==void 0)break;i=s[0]?.message}r="on_chat_model_end"}else if(t.runType==="llm")i={generations:a?.map(s=>s.map(o=>({text:o.text,generationInfo:o.generationInfo}))),llmOutput:e.outputs?.llmOutput??{}},r="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);await this.sendEndEvent({event:r,data:{output:i,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){const t=Cr(e),r=e.run_type??"chain",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type};let i={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(i={},a.inputs={}):e.inputs.input!==void 0?(i.input=e.inputs.input,a.inputs=e.inputs.input):(i.input=e.inputs,a.inputs=e.inputs),this.runInfoMap.set(e.id,a),await this.send({event:`on_${r}_start`,data:i,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onChainEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const r=`on_${e.run_type}_end`,a=e.inputs??t.inputs??{},s={output:e.outputs?.output??e.outputs,input:a};a.input&&Object.keys(a).length===1&&(s.input=a.input,t.inputs=a.input),await this.sendEndEvent({event:r,data:s,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){const t=Cr(e),r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},r)}async onToolEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(t.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const r=e.outputs?.output===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){const t=Cr(e),a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,a),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onRetrieverEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,r){const a=this.runInfoMap.get(r);if(a===void 0)throw new Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:a.tags,metadata:a.metadata,data:t},a)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}}const zc=[400,401,402,403,404,405,406,407,409],Gc=n=>{if(n.message.startsWith("Cancel")||n.message.startsWith("AbortError")||n.name==="AbortError"||n?.code==="ECONNABORTED")throw n;const e=n?.response?.status??n?.status;if(e&&zc.includes(+e))throw n;if(n?.error?.code==="insufficient_quota"){const t=new Error(n?.message);throw t.name="InsufficientQuotaError",t}};class va{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??Gc;const t="default"in Ve?Ve.default:Ve;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>hr(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,i)=>{e.signal?.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}class lo extends Bt{constructor({config:e,onStart:t,onEnd:r,onError:a}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=a}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}}function Ea(n){return n?n.lc_runnable:!1}class Zc{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0;const a=e.tags??[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(t)),this.includeTags!==void 0&&(r=r||a.some(i=>this.includeTags?.includes(i))),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(r=r&&a.every(i=>!this.excludeTags?.includes(i))),r}}const Wc=Symbol("Let zodToJsonSchema decide on which parser to use"),Jc={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},Kc=n=>({...Jc,...n}),Xc=n=>{const e=Kc(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([r,a])=>[a._def,{def:a._def,path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}};function co(n,e,t,r){r?.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function W(n,e,t,r,a){n[e]=t,co(n,e,r,a)}function Yc(){return{}}function Qc(n,e){const t={type:"array"};return n.type?._def&&n.type?._def?.typeName!==v.ZodAny&&(t.items=G(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&W(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&W(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(W(t,"minItems",n.exactLength.value,n.exactLength.message,e),W(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}function ed(n,e){const t={type:"integer",format:"int64"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?W(t,"minimum",r.value,r.message,e):W(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),W(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?W(t,"maximum",r.value,r.message,e):W(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),W(t,"maximum",r.value,r.message,e));break;case"multipleOf":W(t,"multipleOf",r.value,r.message,e);break}return t}function td(){return{type:"boolean"}}function ho(n,e){return G(n.type._def,e)}const rd=(n,e)=>G(n.innerType._def,e);function fo(n,e,t){const r=t??e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((a,i)=>fo(n,e,a))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return nd(n,e)}}const nd=(n,e)=>{const t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(const r of n.checks)switch(r.kind){case"min":W(t,"minimum",r.value,r.message,e);break;case"max":W(t,"maximum",r.value,r.message,e);break}return t};function ad(n,e){return{...G(n.innerType._def,e),default:n.defaultValue()}}function id(n,e){return e.effectStrategy==="input"?G(n.schema._def,e):{}}function sd(n){return{type:"string",enum:Array.from(n.values)}}const od=n=>"type"in n&&n.type==="string"?!1:"allOf"in n;function ud(n,e){const t=[G(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),G(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(i=>!!i);let r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const a=[];return t.forEach(i=>{if(od(i))a.push(...i.allOf),i.unevaluatedProperties===void 0&&(r=void 0);else{let s=i;if("additionalProperties"in i&&i.additionalProperties===!1){const{additionalProperties:o,...u}=i;s=u}else r=void 0;a.push(s)}}),a.length?{allOf:a,...r}:void 0}function ld(n,e){const t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}let Oa;const Re={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Oa===void 0&&(Oa=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Oa),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function po(n,e){const t={type:"string"};if(n.checks)for(const r of n.checks)switch(r.kind){case"min":W(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,r.value):r.value,r.message,e);break;case"max":W(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,r.value):r.value,r.message,e);break;case"email":switch(e.emailStrategy){case"format:email":Ie(t,"email",r.message,e);break;case"format:idn-email":Ie(t,"idn-email",r.message,e);break;case"pattern:zod":de(t,Re.email,r.message,e);break}break;case"url":Ie(t,"uri",r.message,e);break;case"uuid":Ie(t,"uuid",r.message,e);break;case"regex":de(t,r.regex,r.message,e);break;case"cuid":de(t,Re.cuid,r.message,e);break;case"cuid2":de(t,Re.cuid2,r.message,e);break;case"startsWith":de(t,RegExp(`^${xa(r.value,e)}`),r.message,e);break;case"endsWith":de(t,RegExp(`${xa(r.value,e)}$`),r.message,e);break;case"datetime":Ie(t,"date-time",r.message,e);break;case"date":Ie(t,"date",r.message,e);break;case"time":Ie(t,"time",r.message,e);break;case"duration":Ie(t,"duration",r.message,e);break;case"length":W(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,r.value):r.value,r.message,e),W(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,r.value):r.value,r.message,e);break;case"includes":{de(t,RegExp(xa(r.value,e)),r.message,e);break}case"ip":{r.version!=="v6"&&Ie(t,"ipv4",r.message,e),r.version!=="v4"&&Ie(t,"ipv6",r.message,e);break}case"base64url":de(t,Re.base64url,r.message,e);break;case"jwt":de(t,Re.jwt,r.message,e);break;case"cidr":{r.version!=="v6"&&de(t,Re.ipv4Cidr,r.message,e),r.version!=="v4"&&de(t,Re.ipv6Cidr,r.message,e);break}case"emoji":de(t,Re.emoji(),r.message,e);break;case"ulid":{de(t,Re.ulid,r.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{Ie(t,"binary",r.message,e);break}case"contentEncoding:base64":{W(t,"contentEncoding","base64",r.message,e);break}case"pattern:zod":{de(t,Re.base64,r.message,e);break}}break}case"nanoid":de(t,Re.nanoid,r.message,e)}return t}function xa(n,e){return e.patternStrategy==="escape"?dd(n):n}const cd=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function dd(n){let e="";for(let t=0;t<n.length;t++)cd.has(n[t])||(e+="\\"),e+=n[t];return e}function Ie(n,e,t,r){n.format||n.anyOf?.some(a=>a.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&r.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&r.errorMessages&&{errorMessage:{format:t}}})):W(n,"format",e,t,r)}function de(n,e,t,r){n.pattern||n.allOf?.some(a=>a.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&r.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:mo(e,r),...t&&r.errorMessages&&{errorMessage:{pattern:t}}})):W(n,"pattern",mo(e,r),t,r)}function mo(n,e){if(!e.applyRegexFlags||!n.flags)return n.source;const t={i:n.flags.includes("i"),m:n.flags.includes("m"),s:n.flags.includes("s")},r=t.i?n.source.toLowerCase():n.source;let a="",i=!1,s=!1,o=!1;for(let u=0;u<r.length;u++){if(i){a+=r[u],i=!1;continue}if(t.i){if(s){if(r[u].match(/[a-z]/)){o?(a+=r[u],a+=`${r[u-2]}-${r[u]}`.toUpperCase(),o=!1):r[u+1]==="-"&&r[u+2]?.match(/[a-z]/)?(a+=r[u],o=!0):a+=`${r[u]}${r[u].toUpperCase()}`;continue}}else if(r[u].match(/[a-z]/)){a+=`[${r[u]}${r[u].toUpperCase()}]`;continue}}if(t.m){if(r[u]==="^"){a+=`(^|(?<=[\r
]))`;continue}else if(r[u]==="$"){a+=`($|(?=[\r
]))`;continue}}if(t.s&&r[u]==="."){a+=s?`${r[u]}\r
`:`[${r[u]}\r
]`;continue}a+=r[u],r[u]==="\\"?i=!0:s&&r[u]==="]"?s=!1:!s&&r[u]==="["&&(s=!0)}try{new RegExp(a)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return a}function go(n,e){if(e.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),e.target==="openApi3"&&n.keyType?._def.typeName===v.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((r,a)=>({...r,[a]:G(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",a]})??{}}),{}),additionalProperties:e.rejectedAdditionalProperties};const t={type:"object",additionalProperties:G(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??e.allowedAdditionalProperties};if(e.target==="openApi3")return t;if(n.keyType?._def.typeName===v.ZodString&&n.keyType._def.checks?.length){const{type:r,...a}=po(n.keyType._def,e);return{...t,propertyNames:a}}else{if(n.keyType?._def.typeName===v.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};if(n.keyType?._def.typeName===v.ZodBranded&&n.keyType._def.type._def.typeName===v.ZodString&&n.keyType._def.type._def.checks?.length){const{type:r,...a}=ho(n.keyType._def,e);return{...t,propertyNames:a}}}return t}function hd(n,e){if(e.mapStrategy==="record")return go(n,e);const t=G(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=G(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,r],minItems:2,maxItems:2}}}function fd(n){const e=n.values,r=Object.keys(n.values).filter(i=>typeof e[e[i]]!="number").map(i=>e[i]),a=Array.from(new Set(r.map(i=>typeof i)));return{type:a.length===1?a[0]==="string"?"string":"number":["string","number"],enum:r}}function pd(){return{not:{}}}function md(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const $r={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function gd(n,e){if(e.target==="openApi3")return yo(n,e);const t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(r=>r._def.typeName in $r&&(!r._def.checks||!r._def.checks.length))){const r=t.reduce((a,i)=>{const s=$r[i._def.typeName];return s&&!a.includes(s)?[...a,s]:a},[]);return{type:r.length>1?r:r[0]}}else if(t.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){const r=t.reduce((a,i)=>{const s=typeof i._def.value;switch(s){case"string":case"number":case"boolean":return[...a,s];case"bigint":return[...a,"integer"];case"object":if(i._def.value===null)return[...a,"null"];case"symbol":case"undefined":case"function":default:return a}},[]);if(r.length===t.length){const a=r.filter((i,s,o)=>o.indexOf(i)===s);return{type:a.length>1?a:a[0],enum:t.reduce((i,s)=>i.includes(s._def.value)?i:[...i,s._def.value],[])}}}else if(t.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((r,a)=>[...r,...a._def.values.filter(i=>!r.includes(i))],[])};return yo(n,e)}const yo=(n,e)=>{const t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((r,a)=>G(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${a}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return t.length?{anyOf:t}:void 0};function yd(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"?{type:$r[n.innerType._def.typeName],nullable:!0}:{type:[$r[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const r=G(n.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const t=G(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function bd(n,e){const t={type:"number"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"int":t.type="integer",co(t,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?W(t,"minimum",r.value,r.message,e):W(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),W(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?W(t,"maximum",r.value,r.message,e):W(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),W(t,"maximum",r.value,r.message,e));break;case"multipleOf":W(t,"multipleOf",r.value,r.message,e);break}return t}function _d(n,e){const t=e.target==="openAi",r={type:"object",properties:{}},a=[],i=n.shape();for(const o in i){let u=i[o];if(u===void 0||u._def===void 0)continue;let l=vd(u);l&&t&&(u instanceof Be&&(u=u._def.innerType),u.isNullable()||(u=u.nullable()),l=!1);const c=G(u._def,{...e,currentPath:[...e.currentPath,"properties",o],propertyPath:[...e.currentPath,"properties",o]});c!==void 0&&(r.properties[o]=c,l||a.push(o))}a.length&&(r.required=a);const s=wd(n,e);return s!==void 0&&(r.additionalProperties=s),r}function wd(n,e){if(n.catchall._def.typeName!=="ZodNever")return G(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]});switch(n.unknownKeys){case"passthrough":return e.allowedAdditionalProperties;case"strict":return e.rejectedAdditionalProperties;case"strip":return e.removeAdditionalStrategy==="strict"?e.allowedAdditionalProperties:e.rejectedAdditionalProperties}}function vd(n){try{return n.isOptional()}catch{return!0}}const Ed=(n,e)=>{if(e.currentPath.toString()===e.propertyPath?.toString())return G(n.innerType._def,e);const t=G(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}},Od=(n,e)=>{if(e.pipeStrategy==="input")return G(n.in._def,e);if(e.pipeStrategy==="output")return G(n.out._def,e);const t=G(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=G(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,r].filter(a=>a!==void 0)}};function xd(n,e){return G(n.type._def,e)}function Sd(n,e){const r={type:"array",uniqueItems:!0,items:G(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&W(r,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&W(r,"maxItems",n.maxSize.value,n.maxSize.message,e),r}function Td(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,r)=>G(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[]),additionalItems:G(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,r)=>G(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[])}}function Pd(){return{not:{}}}function Ad(){return{}}const Rd=(n,e)=>G(n.innerType._def,e),Id=(n,e,t)=>{switch(e){case v.ZodString:return po(n,t);case v.ZodNumber:return bd(n,t);case v.ZodObject:return _d(n,t);case v.ZodBigInt:return ed(n,t);case v.ZodBoolean:return td();case v.ZodDate:return fo(n,t);case v.ZodUndefined:return Pd();case v.ZodNull:return md(t);case v.ZodArray:return Qc(n,t);case v.ZodUnion:case v.ZodDiscriminatedUnion:return gd(n,t);case v.ZodIntersection:return ud(n,t);case v.ZodTuple:return Td(n,t);case v.ZodRecord:return go(n,t);case v.ZodLiteral:return ld(n,t);case v.ZodEnum:return sd(n);case v.ZodNativeEnum:return fd(n);case v.ZodNullable:return yd(n,t);case v.ZodOptional:return Ed(n,t);case v.ZodMap:return hd(n,t);case v.ZodSet:return Sd(n,t);case v.ZodLazy:return()=>n.getter()._def;case v.ZodPromise:return xd(n,t);case v.ZodNaN:case v.ZodNever:return pd();case v.ZodEffects:return id(n,t);case v.ZodAny:return Yc();case v.ZodUnknown:return Ad();case v.ZodDefault:return ad(n,t);case v.ZodBranded:return ho(n,t);case v.ZodReadonly:return Rd(n,t);case v.ZodCatch:return rd(n,t);case v.ZodPipeline:return Od(n,t);case v.ZodFunction:case v.ZodVoid:case v.ZodSymbol:return;default:return(r=>{})()}};function G(n,e,t=!1){const r=e.seen.get(n);if(e.override){const o=e.override?.(n,e,r,t);if(o!==Wc)return o}if(r&&!t){const o=kd(r,e);if(o!==void 0)return o}const a={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,a);const i=Id(n,n.typeName,e),s=typeof i=="function"?G(i(),e):i;if(s&&$d(n,e,s),e.postProcess){const o=e.postProcess(s,n,e);return a.jsonSchema=s,o}return a.jsonSchema=s,s}const kd=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"relative":return{$ref:Cd(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((t,r)=>e.currentPath[r]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},Cd=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},$d=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t),jd=(n,e)=>{const t=Xc(e),r=void 0,a=e?.name,i=G(n._def,t,!1)??{},s=a===void 0?r?{...i,[t.definitionPath]:r}:i:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,a].join("/"),[t.definitionPath]:{...r,[a]:i}};return t.target==="jsonSchema7"?s.$schema="http://json-schema.org/draft-07/schema#":(t.target==="jsonSchema2019-09"||t.target==="openAi")&&(s.$schema="https://json-schema.org/draft/2019-09/schema#"),t.target==="openAi"&&("anyOf"in s||"oneOf"in s||"allOf"in s||"type"in s&&Array.isArray(s.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),s};function Sa(n){return n.replace(/[^a-zA-Z-_0-9]/g,"_")}const Nd=["*","_","`"];function Ld(n){let e="";for(const[t,r]of Object.entries(n))e+=`	classDef ${t} ${r};
`;return e}function Md(n,e,t){const{firstNode:r,lastNode:a,nodeColors:i,withStyles:s=!0,curveStyle:o="linear",wrapLabelNWords:u=9}=t??{};let l=s?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(s){const f="default",p={[f]:"{0}({1})"};r!==void 0&&(p[r]="{0}([{1}]):::first"),a!==void 0&&(p[a]="{0}([{1}]):::last");for(const[m,g]of Object.entries(n)){const y=g.name.split(":").pop()??"";let b=Nd.some(E=>y.startsWith(E)&&y.endsWith(E))?`<p>${y}</p>`:y;Object.keys(g.metadata??{}).length&&(b+=`<hr/><small><em>${Object.entries(g.metadata??{}).map(([E,k])=>`${E} = ${k}`).join(`
`)}</em></small>`);const P=(p[m]??p[f]).replace("{0}",Sa(m)).replace("{1}",b);l+=`	${P}
`}}const c={};for(const f of e){const p=f.source.split(":"),m=f.target.split(":"),g=p.filter((y,_)=>y===m[_]).join(":");c[g]||(c[g]=[]),c[g].push(f)}const h=new Set;function d(f,p){const m=f.length===1&&f[0].source===f[0].target;if(p&&!m){const g=p.split(":").pop();if(h.has(g))throw new Error(`Found duplicate subgraph '${g}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);h.add(g),l+=`	subgraph ${g}
`}for(const g of f){const{source:y,target:_,data:b,conditional:P}=g;let E="";if(b!==void 0){let k=b;const M=k.split(" ");M.length>u&&(k=Array.from({length:Math.ceil(M.length/u)},(S,$e)=>M.slice($e*u,($e+1)*u).join(" ")).join("&nbsp;<br>&nbsp;")),E=P?` -. &nbsp;${k}&nbsp; .-> `:` -- &nbsp;${k}&nbsp; --> `}else E=P?" -.-> ":" --> ";l+=`	${Sa(y)}${E}${Sa(_)};
`}for(const g in c)g.startsWith(`${p}:`)&&g!==p&&d(c[g],g);p&&!m&&(l+=`	end
`)}d(c[""]??[],"");for(const f in c)!f.includes(":")&&f!==""&&d(c[f],f);return s&&(l+=Ld(i??{})),l}async function Fd(n,e){let{backgroundColor:t="white"}=e??{};const r=btoa(n);t!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(t)||(t=`!${t}`));const a=`https://mermaid.ink/img/${r}?bgColor=${t}`,i=await fetch(a);if(!i.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${i.status}`,`Status text: ${i.statusText}`].join(`
`));return await i.blob()}function Dd(n,e){if(n!==void 0&&!jt(n))return n;if(Ea(e))try{let t=e.getName();return t=t.startsWith("Runnable")?t.slice(8):t,t}catch{return e.getName()}else return e.name??"UnknownSchema"}function Ud(n){return Ea(n.data)?{type:"runnable",data:{id:n.data.lc_id,name:n.data.getName()}}:{type:"schema",data:{...jd(n.data.schema),title:n.data.name}}}class jr{constructor(e){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.nodes=e?.nodes??this.nodes,this.edges=e?.edges??this.edges}toJSON(){const e={};return Object.values(this.nodes).forEach((t,r)=>{e[t.id]=jt(t.id)?r:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...Ud(t)})),edges:this.edges.map(t=>{const r={source:e[t.source],target:e[t.target]};return typeof t.data<"u"&&(r.data=t.data),typeof t.conditional<"u"&&(r.conditional=t.conditional),r})}}addNode(e,t,r){if(t!==void 0&&this.nodes[t]!==void 0)throw new Error(`Node with id ${t} already exists`);const a=t??ue(),i={id:a,data:e,name:Dd(t,e),metadata:r};return this.nodes[a]=i,i}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,r,a){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[t.id]===void 0)throw new Error(`Target node ${t.id} not in graph`);const i={source:e.id,target:t.id,data:r,conditional:a};return this.edges.push(i),i}firstNode(){return bo(this)}lastNode(){return _o(this)}extend(e,t=""){let r=t;Object.values(e.nodes).map(l=>l.id).every(jt)&&(r="");const i=l=>r?`${r}:${l}`:l;Object.entries(e.nodes).forEach(([l,c])=>{this.nodes[i(l)]={...c,id:i(l)}});const s=e.edges.map(l=>({...l,source:i(l.source),target:i(l.target)}));this.edges=[...this.edges,...s];const o=e.firstNode(),u=e.lastNode();return[o?{id:i(o.id),data:o.data}:void 0,u?{id:i(u.id),data:u.data}:void 0]}trimFirstNode(){const e=this.firstNode();e&&bo(this,[e.id])&&this.removeNode(e)}trimLastNode(){const e=this.lastNode();e&&_o(this,[e.id])&&this.removeNode(e)}reid(){const e=Object.fromEntries(Object.values(this.nodes).map(a=>[a.id,a.name])),t=new Map;Object.values(e).forEach(a=>{t.set(a,(t.get(a)||0)+1)});const r=a=>{const i=e[a];return jt(a)&&t.get(i)===1?i:a};return new jr({nodes:Object.fromEntries(Object.entries(this.nodes).map(([a,i])=>[r(a),{...i,id:r(a)}])),edges:this.edges.map(a=>({...a,source:r(a.source),target:r(a.target)}))})}drawMermaid(e){const{withStyles:t,curveStyle:r,nodeColors:a={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:i}=e??{},s=this.reid(),o=s.firstNode(),u=s.lastNode();return Md(s.nodes,s.edges,{firstNode:o?.id,lastNode:u?.id,withStyles:t,curveStyle:r,nodeColors:a,wrapLabelNWords:i})}async drawMermaidPng(e){const t=this.drawMermaid(e);return Fd(t,{backgroundColor:e?.backgroundColor})}}function bo(n,e=[]){const t=new Set(n.edges.filter(a=>!e.includes(a.source)).map(a=>a.target)),r=[];for(const a of Object.values(n.nodes))!e.includes(a.id)&&!t.has(a.id)&&r.push(a);return r.length===1?r[0]:void 0}function _o(n,e=[]){const t=new Set(n.edges.filter(a=>!e.includes(a.target)).map(a=>a.source)),r=[];for(const a of Object.values(n.nodes))!e.includes(a.id)&&!t.has(a.id)&&r.push(a);return r.length===1?r[0]:void 0}function Bd(n){const e=new TextEncoder,t=new ReadableStream({async start(r){for await(const a of n)r.enqueue(e.encode(`event: data
data: ${JSON.stringify(a)}

`));r.enqueue(e.encode(`event: end

`)),r.close()}});return Ee.fromReadableStream(t)}function wo(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.iterator]=="function"&&typeof n.next=="function"}const Vd=n=>n!=null&&typeof n=="object"&&"next"in n&&typeof n.next=="function";function Ta(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.asyncIterator]=="function"}function*vo(n,e){for(;;){const{value:t,done:r}=Qe.runWithConfig(vt(n),e.next.bind(e),!0);if(r)break;yield t}}async function*Pa(n,e){const t=e[Symbol.asyncIterator]();for(;;){const{value:r,done:a}=await Qe.runWithConfig(vt(n),t.next.bind(e),!0);if(a)break;yield r}}function re(n,e){return n&&!Array.isArray(n)&&!(n instanceof Date)&&typeof n=="object"?n:{[e]:n}}class ne extends at{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new ot({bound:this,kwargs:e,config:{}})}map(){return new Nr({bound:this})}withRetry(e){return new Eo({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new ot({bound:this,config:e,kwargs:{}})}withFallbacks(e){const t=Array.isArray(e)?e:e.fallbacks;return new Hd({runnable:this,fallbacks:t})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(J);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const r=Object.fromEntries(Object.entries(e).filter(([a])=>a!=="runId"));return Array.from({length:t},(a,i)=>J(i===0?e:r))}return Array.from({length:t},()=>J(e))}async batch(e,t,r){const a=this._getOptionsList(t??{},e.length),i=a[0]?.maxConcurrency??r?.maxConcurrency,s=new va({maxConcurrency:i,onFailedAttempt:u=>{throw u}}),o=e.map((u,l)=>s.call(async()=>{try{return await this.invoke(u,a[l])}catch(c){if(r?.returnExceptions)return c;throw c}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const r=J(t),a=new Et({generator:this._streamIterator(e,r),config:r});return await a.setup,Ee.fromAsyncGenerator(a)}_separateRunnableConfigFromCallOptions(e){let t;e===void 0?t=J(e):t=J({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,delete r.timeout,delete r.signal,[t,r]}async _callWithConfig(e,t,r){const a=J(r),s=await(await Ae(a))?.handleChainStart(this.toJSON(),re(t,"input"),a.runId,a?.runType,void 0,void 0,a?.runName??this.getName());delete a.runId;let o;try{const u=e.call(this,t,a,s);o=await et(u,r?.signal)}catch(u){throw await s?.handleChainError(u),u}return await s?.handleChainEnd(re(o,"output")),o}async _batchWithConfig(e,t,r,a){const i=this._getOptionsList(r??{},t.length),s=await Promise.all(i.map(Ae)),o=await Promise.all(s.map(async(l,c)=>{const h=await l?.handleChainStart(this.toJSON(),re(t[c],"input"),i[c].runId,i[c].runType,void 0,void 0,i[c].runName??this.getName());return delete i[c].runId,h}));let u;try{const l=e.call(this,t,i,o,a);u=await et(l,i?.[0]?.signal)}catch(l){throw await Promise.all(o.map(c=>c?.handleChainError(l))),l}return await Promise.all(o.map(l=>l?.handleChainEnd(re(u,"output")))),u}async*_transformStreamWithConfig(e,t,r){let a,i=!0,s,o=!0;const u=J(r),l=await Ae(u);async function*c(){for await(const d of e){if(i)if(a===void 0)a=d;else try{a=Le(a,d)}catch{a=void 0,i=!1}yield d}}let h;try{const d=await Uc(t.bind(this),c(),async()=>l?.handleChainStart(this.toJSON(),{input:""},u.runId,u.runType,void 0,void 0,u.runName??this.getName()),r?.signal,u);delete u.runId,h=d.setup;const f=h?.handlers.find(qc);let p=d.output;f!==void 0&&h!==void 0&&(p=f.tapOutputIterable(h.runId,p));const m=h?.handlers.find(Bc);m!==void 0&&h!==void 0&&(p=m.tapOutputIterable(h.runId,p));for await(const g of p)if(yield g,o)if(s===void 0)s=g;else try{s=Le(s,g)}catch{s=void 0,o=!1}}catch(d){throw await h?.handleChainError(d,void 0,void 0,void 0,{inputs:re(a,"input")}),d}await h?.handleChainEnd(s??{},void 0,void 0,void 0,{inputs:re(a,"input")})}getGraph(e){const t=new jr,r=t.addNode({name:`${this.getName()}Input`,schema:Si()}),a=t.addNode(this),i=t.addNode({name:`${this.getName()}Output`,schema:Si()});return t.addEdge(r,a),t.addEdge(a,i),t}pipe(e){return new ut({first:this,last:lt(e)})}pick(e){return this.pipe(new Gd(e))}assign(e){return this.pipe(new zd(new Gt({steps:e})))}async*transform(e,t){let r;for await(const a of e)r===void 0?r=a:r=Le(r,a);yield*this._streamIterator(r,J(t))}async*streamLog(e,t,r){const a=new oo({...r,autoClose:!1,_schemaFormat:"original"}),i=J(t);yield*this._streamLog(e,a,i)}async*_streamLog(e,t,r){const{callbacks:a}=r;if(a===void 0)r.callbacks=[t];else if(Array.isArray(a))r.callbacks=a.concat([t]);else{const u=a.copy();u.addHandler(t,!0),r.callbacks=u}const i=this.stream(e,r);async function s(){try{const u=await i;for await(const l of u){const c=new tt({ops:[{op:"add",path:"/streamed_output/-",value:l}]});await t.writer.write(c)}}finally{await t.writer.close()}}const o=s();try{for await(const u of t)yield u}finally{await o}}streamEvents(e,t,r){let a;if(t.version==="v1")a=this._streamEventsV1(e,t,r);else if(t.version==="v2")a=this._streamEventsV2(e,t,r);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return t.encoding==="text/event-stream"?Bd(a):Ee.fromAsyncGenerator(a)}async*_streamEventsV2(e,t,r){const a=new Hc({...r,autoClose:!1}),i=J(t),s=i.runId??ue();i.runId=s;const o=i.callbacks;if(o===void 0)i.callbacks=[a];else if(Array.isArray(o))i.callbacks=o.concat(a);else{const p=o.copy();p.addHandler(a,!0),i.callbacks=p}const u=new AbortController,l=this;async function c(){try{let p;t?.signal?"any"in AbortSignal?p=AbortSignal.any([u.signal,t.signal]):(p=t.signal,t.signal.addEventListener("abort",()=>{u.abort()},{once:!0})):p=u.signal;const m=await l.stream(e,{...i,signal:p}),g=a.tapOutputIterable(s,m);for await(const y of g)if(u.signal.aborted)break}finally{await a.finish()}}const h=c();let d=!1,f;try{for await(const p of a){if(!d){p.data.input=e,d=!0,f=p.run_id,yield p;continue}p.run_id===f&&p.event.endsWith("_end")&&p.data?.input&&delete p.data.input,yield p}}finally{u.abort(),await h}}async*_streamEventsV1(e,t,r){let a,i=!1;const s=J(t),o=s.tags??[],u=s.metadata??{},l=s.runName??this.getName(),c=new oo({...r,autoClose:!1,_schemaFormat:"streaming_events"}),h=new Zc({...r}),d=this._streamLog(e,c,s);for await(const p of d){if(a?a=a.concat(p):a=zt.fromRunLogPatch(p),a.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!i){i=!0;const _={...a.state},b={run_id:_.id,event:`on_${_.type}_start`,name:l,tags:o,metadata:u,data:{input:e}};h.includeEvent(b,_.type)&&(yield b)}const m=p.ops.filter(_=>_.path.startsWith("/logs/")).map(_=>_.path.split("/")[2]),g=[...new Set(m)];for(const _ of g){let b,P={};const E=a.state.logs[_];if(E.end_time===void 0?E.streamed_output.length>0?b="stream":b="start":b="end",b==="start")E.inputs!==void 0&&(P.input=E.inputs);else if(b==="end")E.inputs!==void 0&&(P.input=E.inputs),P.output=E.final_output;else if(b==="stream"){const k=E.streamed_output.length;if(k!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${k} instead. Encountered in: "${E.name}"`);P={chunk:E.streamed_output[0]},E.streamed_output=[]}yield{event:`on_${E.type}_${b}`,name:E.name,run_id:E.id,tags:E.tags,metadata:E.metadata,data:P}}const{state:y}=a;if(y.streamed_output.length>0){const _=y.streamed_output.length;if(_!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${_} instead. Encountered in: "${y.name}"`);const b={chunk:y.streamed_output[0]};y.streamed_output=[];const P={event:`on_${y.type}_stream`,run_id:y.id,tags:o,metadata:u,name:l,data:b};h.includeEvent(P,y.type)&&(yield P)}}const f=a?.state;if(f!==void 0){const p={event:`on_${f.type}_end`,name:l,run_id:f.id,tags:o,metadata:u,data:{output:f.final_output}};h.includeEvent(p,f.type)&&(yield p)}}static isRunnable(e){return Ea(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new ot({bound:this,config:{},configFactories:[a=>({callbacks:[new lo({config:a,onStart:e,onEnd:t,onError:r})]})]})}asTool(e){return Zd(this,e)}}class ot extends ne{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=no(this.config,...e);return no(t,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new Eo({bound:this.bound,kwargs:this.kwargs,config:this.config,maxAttemptNumber:e?.stopAfterAttempt,...e})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(J(t),this.kwargs))}async batch(e,t,r){const a=Array.isArray(t)?await Promise.all(t.map(async i=>this._mergeConfig(J(i),this.kwargs))):await this._mergeConfig(J(t),this.kwargs);return this.bound.batch(e,a,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(J(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(J(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(J(t),this.kwargs))}streamEvents(e,t,r){const a=this,i=async function*(){yield*a.bound.streamEvents(e,{...await a._mergeConfig(J(t),a.kwargs),version:t.version},r)};return Ee.fromAsyncGenerator(i())}static isRunnableBinding(e){return e.bound&&ne.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new ot({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new lo({config:a,onStart:e,onEnd:t,onError:r})]})]})}}class Nr extends ne{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new Nr({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _invoke(e,t,r){return this.bound.batch(e,oe(t,{callbacks:r?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new Nr({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}}class Eo extends ot{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){const a=e>1?`retry:attempt:${e}`:void 0;return oe(t,{callbacks:r?.getChild(a)})}async _invoke(e,t,r){return hr(a=>super.invoke(e,this._patchConfigForRetry(a,t,r)),{onFailedAttempt:a=>this.onFailedAttempt(a,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,r,a){const i={};try{await hr(async s=>{const o=e.map((d,f)=>f).filter(d=>i[d.toString()]===void 0||i[d.toString()]instanceof Error),u=o.map(d=>e[d]),l=o.map(d=>this._patchConfigForRetry(s,t?.[d],r?.[d])),c=await super.batch(u,l,{...a,returnExceptions:!0});let h;for(let d=0;d<c.length;d+=1){const f=c[d],p=o[d];f instanceof Error&&h===void 0&&(h=f,h.input=u[d]),i[p.toString()]=f}if(h)throw h;return c},{onFailedAttempt:s=>this.onFailedAttempt(s,s.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(s){if(a?.returnExceptions!==!0)throw s}return Object.keys(i).sort((s,o)=>parseInt(s,10)-parseInt(o,10)).map(s=>i[parseInt(s,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}}class ut extends ne{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitSequenceTags",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name,this.omitSequenceTags=e.omitSequenceTags??this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const r=J(t),i=await(await Ae(r))?.handleChainStart(this.toJSON(),re(e,"input"),r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;let s=e,o;try{const u=[this.first,...this.middle];for(let l=0;l<u.length;l+=1){const h=u[l].invoke(s,oe(r,{callbacks:i?.getChild(this.omitSequenceTags?void 0:`seq:step:${l+1}`)}));s=await et(h,t?.signal)}if(t?.signal?.aborted)throw new Error("Aborted");o=await this.last.invoke(s,oe(r,{callbacks:i?.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(u){throw await i?.handleChainError(u),u}return await i?.handleChainEnd(re(o,"output")),o}async batch(e,t,r){const a=this._getOptionsList(t??{},e.length),i=await Promise.all(a.map(Ae)),s=await Promise.all(i.map(async(u,l)=>{const c=await u?.handleChainStart(this.toJSON(),re(e[l],"input"),a[l].runId,void 0,void 0,void 0,a[l].runName);return delete a[l].runId,c}));let o=e;try{for(let u=0;u<this.steps.length;u+=1){const c=this.steps[u].batch(o,s.map((h,d)=>{const f=h?.getChild(this.omitSequenceTags?void 0:`seq:step:${u+1}`);return oe(a[d],{callbacks:f})}),r);o=await et(c,a[0]?.signal)}}catch(u){throw await Promise.all(s.map(l=>l?.handleChainError(u))),u}return await Promise.all(s.map(u=>u?.handleChainEnd(re(o,"output")))),o}async*_streamIterator(e,t){const r=await Ae(t),{runId:a,...i}=t??{},s=await r?.handleChainStart(this.toJSON(),re(e,"input"),a,void 0,void 0,void 0,i?.runName),o=[this.first,...this.middle,this.last];let u=!0,l;async function*c(){yield e}try{let h=o[0].transform(c(),oe(i,{callbacks:s?.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let d=1;d<o.length;d+=1)h=await o[d].transform(h,oe(i,{callbacks:s?.getChild(this.omitSequenceTags?void 0:`seq:step:${d+1}`)}));for await(const d of h)if(t?.signal?.throwIfAborted(),yield d,u)if(l===void 0)l=d;else try{l=Le(l,d)}catch{l=void 0,u=!1}}catch(h){throw await s?.handleChainError(h),h}await s?.handleChainEnd(re(l,"output"))}getGraph(e){const t=new jr;let r=null;return this.steps.forEach((a,i)=>{const s=a.getGraph(e);i!==0&&s.trimFirstNode(),i!==this.steps.length-1&&s.trimLastNode(),t.extend(s);const o=s.firstNode();if(!o)throw new Error(`Runnable ${a} has no first node`);r&&t.addEdge(r,o),r=s.lastNode()}),t}pipe(e){return ut.isRunnableSequence(e)?new ut({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new ut({first:this.first,middle:[...this.middle,this.last],last:lt(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&ne.isRunnable(e)}static from([e,...t],r){let a={};return typeof r=="string"?a.name=r:r!==void 0&&(a=r),new ut({...a,first:lt(e),middle:t.slice(0,-1).map(lt),last:lt(t[t.length-1])})}}class Gt extends ne{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,r]of Object.entries(e.steps))this.steps[t]=lt(r)}static from(e){return new Gt({steps:e})}async invoke(e,t){const r=J(t),i=await(await Ae(r))?.handleChainStart(this.toJSON(),{input:e},r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;const s={};try{const o=Object.entries(this.steps).map(async([u,l])=>{s[u]=await l.invoke(e,oe(r,{callbacks:i?.getChild(`map:key:${u}`)}))});await et(Promise.all(o),t?.signal)}catch(o){throw await i?.handleChainError(o),o}return await i?.handleChainEnd(s),s}async*_transform(e,t,r){const a={...this.steps},i=ao(e,Object.keys(a).length),s=new Map(Object.entries(a).map(([o,u],l)=>{const c=u.transform(i[l],oe(r,{callbacks:t?.getChild(`map:key:${o}`)}));return[o,c.next().then(h=>({key:o,gen:c,result:h}))]}));for(;s.size;){const o=Promise.race(s.values()),{key:u,result:l,gen:c}=await et(o,r?.signal);s.delete(u),l.done||(yield{[u]:l.value},s.set(u,c.next().then(h=>({key:u,gen:c,result:h}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const a=J(t),i=new Et({generator:this.transform(r(),a),config:a});return await i.setup,Ee.fromAsyncGenerator(i)}}class Aa extends ne{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!da(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){const[r]=this._getOptionsList(t??{},1),a=await Ae(r),i=this.func(oe(r,{callbacks:a}),e);return et(i,r?.signal)}async*_streamIterator(e,t){const[r]=this._getOptionsList(t??{},1),a=await this.invoke(e,t);if(Ta(a)){for await(const i of a)r?.signal?.throwIfAborted(),yield i;return}if(Vd(a)){for(;;){r?.signal?.throwIfAborted();const i=a.next();if(i.done)break;yield i.value}return}yield a}static from(e){return new Aa({func:e})}}function qd(n){if(da(n))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}class Lr extends ne{static lc_name(){return"RunnableLambda"}constructor(e){if(da(e.func))return Aa.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),qd(e.func),this.func=e.func}static from(e){return new Lr({func:e})}async _invoke(e,t,r){return new Promise((a,i)=>{const s=oe(t,{callbacks:r?.getChild(),recursionLimit:(t?.recursionLimit??wa)-1});Qe.runWithConfig(vt(s),async()=>{try{let o=await this.func(e,{...s});if(o&&ne.isRunnable(o)){if(t?.recursionLimit===0)throw new Error("Recursion limit reached.");o=await o.invoke(e,{...s,recursionLimit:(s.recursionLimit??wa)-1})}else if(Ta(o)){let u;for await(const l of Pa(s,o))if(t?.signal?.throwIfAborted(),u===void 0)u=l;else try{u=Le(u,l)}catch{u=l}o=u}else if(wo(o)){let u;for(const l of vo(s,o))if(t?.signal?.throwIfAborted(),u===void 0)u=l;else try{u=Le(u,l)}catch{u=l}o=u}a(o)}catch(o){i(o)}})})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async*_transform(e,t,r){let a;for await(const o of e)if(a===void 0)a=o;else try{a=Le(a,o)}catch{a=o}const i=oe(r,{callbacks:t?.getChild(),recursionLimit:(r?.recursionLimit??wa)-1}),s=await new Promise((o,u)=>{Qe.runWithConfig(vt(i),async()=>{try{const l=await this.func(a,{...i,config:i});o(l)}catch(l){u(l)}})});if(s&&ne.isRunnable(s)){if(r?.recursionLimit===0)throw new Error("Recursion limit reached.");const o=await s.stream(a,i);for await(const u of o)yield u}else if(Ta(s))for await(const o of Pa(i,s))r?.signal?.throwIfAborted(),yield o;else if(wo(s))for(const o of vo(i,s))r?.signal?.throwIfAborted(),yield o;else yield s}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const a=J(t),i=new Et({generator:this.transform(r(),a),config:a});return await i.setup,Ee.fromAsyncGenerator(i)}}class Hd extends ne{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const r=J(t),a=await Ae(r),{runId:i,...s}=r,o=await a?.handleChainStart(this.toJSON(),re(e,"input"),i,void 0,void 0,void 0,s?.runName),u=oe(s,{callbacks:o?.getChild()});return await Qe.runWithConfig(u,async()=>{let c;for(const h of this.runnables()){r?.signal?.throwIfAborted();try{const d=await h.invoke(e,u);return await o?.handleChainEnd(re(d,"output")),d}catch(d){c===void 0&&(c=d)}}throw c===void 0?new Error("No error stored at end of fallback."):(await o?.handleChainError(c),c)})}async*_streamIterator(e,t){const r=J(t),a=await Ae(r),{runId:i,...s}=r,o=await a?.handleChainStart(this.toJSON(),re(e,"input"),i,void 0,void 0,void 0,s?.runName);let u,l;for(const h of this.runnables()){r?.signal?.throwIfAborted();const d=oe(s,{callbacks:o?.getChild()});try{const f=await h.stream(e,d);l=Pa(d,f);break}catch(f){u===void 0&&(u=f)}}if(l===void 0){const h=u??new Error("No error stored at end of fallback.");throw await o?.handleChainError(h),h}let c;try{for await(const h of l){yield h;try{c=c===void 0?c:Le(c,h)}catch{c=void 0}}}catch(h){throw await o?.handleChainError(h),h}await o?.handleChainEnd(re(c,"output"))}async batch(e,t,r){if(r?.returnExceptions)throw new Error("Not implemented.");const a=this._getOptionsList(t??{},e.length),i=await Promise.all(a.map(u=>Ae(u))),s=await Promise.all(i.map(async(u,l)=>{const c=await u?.handleChainStart(this.toJSON(),re(e[l],"input"),a[l].runId,void 0,void 0,void 0,a[l].runName);return delete a[l].runId,c}));let o;for(const u of this.runnables()){a[0].signal?.throwIfAborted();try{const l=await u.batch(e,s.map((c,h)=>oe(a[h],{callbacks:c?.getChild()})),r);return await Promise.all(s.map((c,h)=>c?.handleChainEnd(re(l[h],"output")))),l}catch(l){o===void 0&&(o=l)}}throw o?(await Promise.all(s.map(u=>u?.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}}function lt(n){if(typeof n=="function")return new Lr({func:n});if(ne.isRunnable(n))return n;if(!Array.isArray(n)&&typeof n=="object"){const e={};for(const[t,r]of Object.entries(n))e[t]=lt(r);return new Gt({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}class zd extends ne{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof Gt&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){const a=this.mapper.getStepsKeys(),[i,s]=ao(e),o=this.mapper.transform(s,oe(r,{callbacks:t?.getChild()})),u=o.next();for await(const l of i){if(typeof l!="object"||Array.isArray(l))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof l}`);const c=Object.fromEntries(Object.entries(l).filter(([h])=>!a.includes(h)));Object.keys(c).length>0&&(yield c)}yield(await u).value;for await(const l of o)yield l}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const a=J(t),i=new Et({generator:this.transform(r(),a),config:a});return await i.setup,Ee.fromAsyncGenerator(i)}}class Gd extends ne{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}const a=J(t),i=new Et({generator:this.transform(r(),a),config:a});return await i.setup,Ee.fromAsyncGenerator(i)}}class Oo extends ot{constructor(e){const t=ut.from([Lr.from(async r=>{let a;if(si(r))try{a=await this.schema.parseAsync(r.args)}catch{throw new iu("Received tool input did not match expected schema",JSON.stringify(r.args))}else a=r;return a}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:t,config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}}function Zd(n,e){const t=e.name??n.getName(),r=e.description??e.schema?.description;return e.schema.constructor===Ue?new Oo({name:t,description:r,schema:Nu({input:ju()}).transform(a=>a.input),bound:n}):new Oo({name:t,description:r,schema:e.schema,bound:n})}/*
 * [js-sha1]{@link https://github.com/emn178/js-sha1}
 *
 * @version 0.6.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2014-2017
 * @license MIT
 */var Wd=typeof window=="object"?window:{},B="0123456789abcdef".split(""),Jd=[-2147483648,8388608,32768,128],ke=[24,16,8,0],ae=[];function Ce(n){n?(ae[0]=ae[16]=ae[1]=ae[2]=ae[3]=ae[4]=ae[5]=ae[6]=ae[7]=ae[8]=ae[9]=ae[10]=ae[11]=ae[12]=ae[13]=ae[14]=ae[15]=0,this.blocks=ae):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Ce.prototype.update=function(n){if(!this.finalized){var e=typeof n!="string";e&&n.constructor===Wd.ArrayBuffer&&(n=new Uint8Array(n));for(var t,r=0,a,i=n.length||0,s=this.blocks;r<i;){if(this.hashed&&(this.hashed=!1,s[0]=this.block,s[16]=s[1]=s[2]=s[3]=s[4]=s[5]=s[6]=s[7]=s[8]=s[9]=s[10]=s[11]=s[12]=s[13]=s[14]=s[15]=0),e)for(a=this.start;r<i&&a<64;++r)s[a>>2]|=n[r]<<ke[a++&3];else for(a=this.start;r<i&&a<64;++r)t=n.charCodeAt(r),t<128?s[a>>2]|=t<<ke[a++&3]:t<2048?(s[a>>2]|=(192|t>>6)<<ke[a++&3],s[a>>2]|=(128|t&63)<<ke[a++&3]):t<55296||t>=57344?(s[a>>2]|=(224|t>>12)<<ke[a++&3],s[a>>2]|=(128|t>>6&63)<<ke[a++&3],s[a>>2]|=(128|t&63)<<ke[a++&3]):(t=65536+((t&1023)<<10|n.charCodeAt(++r)&1023),s[a>>2]|=(240|t>>18)<<ke[a++&3],s[a>>2]|=(128|t>>12&63)<<ke[a++&3],s[a>>2]|=(128|t>>6&63)<<ke[a++&3],s[a>>2]|=(128|t&63)<<ke[a++&3]);this.lastByteIndex=a,this.bytes+=a-this.start,a>=64?(this.block=s[16],this.start=a-64,this.hash(),this.hashed=!0):this.start=a}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},Ce.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var n=this.blocks,e=this.lastByteIndex;n[16]=this.block,n[e>>2]|=Jd[e&3],this.block=n[16],e>=56&&(this.hashed||this.hash(),n[0]=this.block,n[16]=n[1]=n[2]=n[3]=n[4]=n[5]=n[6]=n[7]=n[8]=n[9]=n[10]=n[11]=n[12]=n[13]=n[14]=n[15]=0),n[14]=this.hBytes<<3|this.bytes>>>29,n[15]=this.bytes<<3,this.hash()}},Ce.prototype.hash=function(){var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4,i,s,o,u=this.blocks;for(s=16;s<80;++s)o=u[s-3]^u[s-8]^u[s-14]^u[s-16],u[s]=o<<1|o>>>31;for(s=0;s<20;s+=5)i=e&t|~e&r,o=n<<5|n>>>27,a=o+i+a+1518500249+u[s]<<0,e=e<<30|e>>>2,i=n&e|~n&t,o=a<<5|a>>>27,r=o+i+r+1518500249+u[s+1]<<0,n=n<<30|n>>>2,i=a&n|~a&e,o=r<<5|r>>>27,t=o+i+t+1518500249+u[s+2]<<0,a=a<<30|a>>>2,i=r&a|~r&n,o=t<<5|t>>>27,e=o+i+e+1518500249+u[s+3]<<0,r=r<<30|r>>>2,i=t&r|~t&a,o=e<<5|e>>>27,n=o+i+n+1518500249+u[s+4]<<0,t=t<<30|t>>>2;for(;s<40;s+=5)i=e^t^r,o=n<<5|n>>>27,a=o+i+a+1859775393+u[s]<<0,e=e<<30|e>>>2,i=n^e^t,o=a<<5|a>>>27,r=o+i+r+1859775393+u[s+1]<<0,n=n<<30|n>>>2,i=a^n^e,o=r<<5|r>>>27,t=o+i+t+1859775393+u[s+2]<<0,a=a<<30|a>>>2,i=r^a^n,o=t<<5|t>>>27,e=o+i+e+1859775393+u[s+3]<<0,r=r<<30|r>>>2,i=t^r^a,o=e<<5|e>>>27,n=o+i+n+1859775393+u[s+4]<<0,t=t<<30|t>>>2;for(;s<60;s+=5)i=e&t|e&r|t&r,o=n<<5|n>>>27,a=o+i+a-1894007588+u[s]<<0,e=e<<30|e>>>2,i=n&e|n&t|e&t,o=a<<5|a>>>27,r=o+i+r-1894007588+u[s+1]<<0,n=n<<30|n>>>2,i=a&n|a&e|n&e,o=r<<5|r>>>27,t=o+i+t-1894007588+u[s+2]<<0,a=a<<30|a>>>2,i=r&a|r&n|a&n,o=t<<5|t>>>27,e=o+i+e-1894007588+u[s+3]<<0,r=r<<30|r>>>2,i=t&r|t&a|r&a,o=e<<5|e>>>27,n=o+i+n-1894007588+u[s+4]<<0,t=t<<30|t>>>2;for(;s<80;s+=5)i=e^t^r,o=n<<5|n>>>27,a=o+i+a-899497514+u[s]<<0,e=e<<30|e>>>2,i=n^e^t,o=a<<5|a>>>27,r=o+i+r-899497514+u[s+1]<<0,n=n<<30|n>>>2,i=a^n^e,o=r<<5|r>>>27,t=o+i+t-899497514+u[s+2]<<0,a=a<<30|a>>>2,i=r^a^n,o=t<<5|t>>>27,e=o+i+e-899497514+u[s+3]<<0,r=r<<30|r>>>2,i=t^r^a,o=e<<5|e>>>27,n=o+i+n-899497514+u[s+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+n<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+r<<0,this.h4=this.h4+a<<0},Ce.prototype.hex=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return B[n>>28&15]+B[n>>24&15]+B[n>>20&15]+B[n>>16&15]+B[n>>12&15]+B[n>>8&15]+B[n>>4&15]+B[n&15]+B[e>>28&15]+B[e>>24&15]+B[e>>20&15]+B[e>>16&15]+B[e>>12&15]+B[e>>8&15]+B[e>>4&15]+B[e&15]+B[t>>28&15]+B[t>>24&15]+B[t>>20&15]+B[t>>16&15]+B[t>>12&15]+B[t>>8&15]+B[t>>4&15]+B[t&15]+B[r>>28&15]+B[r>>24&15]+B[r>>20&15]+B[r>>16&15]+B[r>>12&15]+B[r>>8&15]+B[r>>4&15]+B[r&15]+B[a>>28&15]+B[a>>24&15]+B[a>>20&15]+B[a>>16&15]+B[a>>12&15]+B[a>>8&15]+B[a>>4&15]+B[a&15]},Ce.prototype.toString=Ce.prototype.hex,Ce.prototype.digest=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return[n>>24&255,n>>16&255,n>>8&255,n&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,r>>24&255,r>>16&255,r>>8&255,r&255,a>>24&255,a>>16&255,a>>8&255,a&255]},Ce.prototype.array=Ce.prototype.digest,Ce.prototype.arrayBuffer=function(){this.finalize();var n=new ArrayBuffer(20),e=new DataView(n);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),n};const Kd=n=>new Ce(!0).update(n).hex(),xo=(...n)=>Kd(n.join("_"));class Xd{}const Yd=new Map;class Ra extends Xd{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(xo(e,t))??null)}async update(e,t,r){this.cache.set(xo(e,t),r)}static global(){return new Ra(Yd)}}class Ia extends at{}class So extends Ia{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new At(this.value)]}}class To extends Ia{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return zr(this.messages)}toChatMessages(){return this.messages}}class Qd extends Ia{static lc_name(){return"ImagePromptValue"}constructor(e){"imageUrl"in e||(e={imageUrl:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"imageUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.imageUrl=e.imageUrl}toString(){return this.imageUrl.url}toChatMessages(){return[new At({content:[{type:"image_url",image_url:{detail:this.imageUrl.detail,url:this.imageUrl.url}}]})]}}var Zt={},Po;function eh(){if(Po)return Zt;Po=1,Zt.byteLength=o,Zt.toByteArray=l,Zt.fromByteArray=d;for(var n=[],e=[],t=typeof Uint8Array<"u"?Uint8Array:Array,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0,i=r.length;a<i;++a)n[a]=r[a],e[r.charCodeAt(a)]=a;e[45]=62,e[95]=63;function s(f){var p=f.length;if(p%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var m=f.indexOf("=");m===-1&&(m=p);var g=m===p?0:4-m%4;return[m,g]}function o(f){var p=s(f),m=p[0],g=p[1];return(m+g)*3/4-g}function u(f,p,m){return(p+m)*3/4-m}function l(f){var p,m=s(f),g=m[0],y=m[1],_=new t(u(f,g,y)),b=0,P=y>0?g-4:g,E;for(E=0;E<P;E+=4)p=e[f.charCodeAt(E)]<<18|e[f.charCodeAt(E+1)]<<12|e[f.charCodeAt(E+2)]<<6|e[f.charCodeAt(E+3)],_[b++]=p>>16&255,_[b++]=p>>8&255,_[b++]=p&255;return y===2&&(p=e[f.charCodeAt(E)]<<2|e[f.charCodeAt(E+1)]>>4,_[b++]=p&255),y===1&&(p=e[f.charCodeAt(E)]<<10|e[f.charCodeAt(E+1)]<<4|e[f.charCodeAt(E+2)]>>2,_[b++]=p>>8&255,_[b++]=p&255),_}function c(f){return n[f>>18&63]+n[f>>12&63]+n[f>>6&63]+n[f&63]}function h(f,p,m){for(var g,y=[],_=p;_<m;_+=3)g=(f[_]<<16&16711680)+(f[_+1]<<8&65280)+(f[_+2]&255),y.push(c(g));return y.join("")}function d(f){for(var p,m=f.length,g=m%3,y=[],_=16383,b=0,P=m-g;b<P;b+=_)y.push(h(f,b,b+_>P?P:b+_));return g===1?(p=f[m-1],y.push(n[p>>2]+n[p<<4&63]+"==")):g===2&&(p=(f[m-2]<<8)+f[m-1],y.push(n[p>>10]+n[p>>4&63]+n[p<<2&63]+"=")),y.join("")}return Zt}var th=eh(),rh=be(th),nh=Object.defineProperty,ah=(n,e,t)=>e in n?nh(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,ih=(n,e,t)=>(ah(n,e+"",t),t);function sh(n,e){let t=Array.from({length:n.length},(r,a)=>({start:a,end:a+1}));for(;t.length>1;){let r=null;for(let a=0;a<t.length-1;a++){const i=n.slice(t[a].start,t[a+1].end),s=e.get(i.join(","));s!=null&&(r==null||s<r[0])&&(r=[s,a])}if(r!=null){const a=r[1];t[a]={start:t[a].start,end:t[a+1].end},t.splice(a+1,1)}else break}return t}function oh(n,e){return n.length===1?[e.get(n.join(","))]:sh(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}function uh(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var ka=class{constructor(n,e){rt(this,"specialTokens");rt(this,"inverseSpecialTokens");rt(this,"patStr");rt(this,"textEncoder",new TextEncoder);rt(this,"textDecoder",new TextDecoder("utf-8"));rt(this,"rankMap",new Map);rt(this,"textMap",new Map);this.patStr=n.pat_str;const t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((r,a)=>{const[i,s,...o]=a.split(" "),u=Number.parseInt(s,10);return o.forEach((l,c)=>r[l]=u+c),r},{});for(const[r,a]of Object.entries(t)){const i=rh.toByteArray(r);this.rankMap.set(i.join(","),a),this.textMap.set(a,i)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((r,[a,i])=>(r[i]=this.textEncoder.encode(a),r),{})}encode(n,e=[],t="all"){const r=new RegExp(this.patStr,"ug"),a=ka.specialTokenRegex(Object.keys(this.specialTokens)),i=[],s=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(t==="all"?Object.keys(this.specialTokens).filter(l=>!s.has(l)):t);if(o.size>0){const l=ka.specialTokenRegex([...o]),c=n.match(l);if(c!=null)throw new Error(`The text contains a special token that is not allowed: ${c[0]}`)}let u=0;for(;;){let l=null,c=u;for(;a.lastIndex=c,l=a.exec(n),!(l==null||s.has(l[0]));)c=l.index+1;const h=l?.index??n.length;for(const f of n.substring(u,h).matchAll(r)){const p=this.textEncoder.encode(f[0]),m=this.rankMap.get(p.join(","));if(m!=null){i.push(m);continue}i.push(...oh(p,this.rankMap))}if(l==null)break;let d=this.specialTokens[l[0]];i.push(d),u=l.index+l[0].length}return i}decode(n){const e=[];let t=0;for(let i=0;i<n.length;++i){const s=n[i],o=this.textMap.get(s)??this.inverseSpecialTokens[s];o!=null&&(e.push(o),t+=o.length)}const r=new Uint8Array(t);let a=0;for(const i of e)r.set(i,a),a+=i.length;return this.textDecoder.decode(r)}},Ao=ka;ih(Ao,"specialTokenRegex",n=>new RegExp(n.map(e=>uh(e)).join("|"),"g"));function lh(n){switch(n){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"gpt-4o-search-preview":case"gpt-4o-search-preview-2025-03-11":case"gpt-4o-mini-search-preview":case"gpt-4o-mini-search-preview-2025-03-11":case"gpt-4o-audio-preview":case"gpt-4o-audio-preview-2024-12-17":case"gpt-4o-audio-preview-2024-10-01":case"gpt-4o-mini-audio-preview":case"gpt-4o-mini-audio-preview-2024-12-17":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-mini-2024-09-12":case"o1-preview":case"o1-preview-2024-09-12":case"o1-pro":case"o1-pro-2025-03-19":case"o3":case"o3-2025-04-16":case"o3-mini":case"o3-mini-2025-01-31":case"o4-mini":case"o4-mini-2025-04-16":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":case"gpt-4o-realtime-preview-2024-12-17":case"gpt-4o-mini-realtime-preview":case"gpt-4o-mini-realtime-preview-2024-12-17":case"gpt-4.1":case"gpt-4.1-2025-04-14":case"gpt-4.1-mini":case"gpt-4.1-mini-2025-04-14":case"gpt-4.1-nano":case"gpt-4.1-nano-2025-04-14":case"gpt-4.5-preview":case"gpt-4.5-preview-2025-02-27":return"o200k_base";default:throw new Error("Unknown model")}}const Mr={},ch=new va({});async function dh(n){return n in Mr||(Mr[n]=ch.fetch(`https://tiktoken.pages.dev/js/${n}.json`).then(e=>e.json()).then(e=>new Ao(e)).catch(e=>{throw delete Mr[n],e})),await Mr[n]}async function hh(n){return dh(lh(n))}const fh=n=>n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n.startsWith("gpt-4o")?"gpt-4o":n,ph=()=>!1;class mh extends ne{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??ph(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class gh extends mh{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){const{cache:a,...i}=r;super({callbacks:e??t,...i}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof a=="object"?this.cache=a:a?this.cache=Ra.global():this.cache=void 0,this.caller=new va(r??{})}async getNumTokens(e){if(typeof e!="string")return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await hh("modelName"in this?fh(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}if(this._encoding)try{t=this._encoding.encode(e).length}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return t}static _convertInputToPromptValue(e){return typeof e=="string"?new So(e):Array.isArray(e)?new To(e.map(sr)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){const r={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()};return Object.entries(r).filter(([s,o])=>o!==void 0).map(([s,o])=>`${s}:${JSON.stringify(o)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}var se=typeof globalThis<"u"&&globalThis||typeof self<"u"&&self||typeof global<"u"&&global||{},he={searchParams:"URLSearchParams"in se,iterable:"Symbol"in se&&"iterator"in Symbol,blob:"FileReader"in se&&"Blob"in se&&function(){try{return new Blob,!0}catch{return!1}}(),formData:"FormData"in se,arrayBuffer:"ArrayBuffer"in se};function yh(n){return n&&DataView.prototype.isPrototypeOf(n)}if(he.arrayBuffer)var bh=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],_h=ArrayBuffer.isView||function(n){return n&&bh.indexOf(Object.prototype.toString.call(n))>-1};function Ot(n){if(typeof n!="string"&&(n=String(n)),/[^a-z0-9\-#$%&'*+.^_`|~!]/i.test(n)||n==="")throw new TypeError('Invalid character in header field name: "'+n+'"');return n.toLowerCase()}function Ca(n){return typeof n!="string"&&(n=String(n)),n}function $a(n){var e={next:function(){var t=n.shift();return{done:t===void 0,value:t}}};return he.iterable&&(e[Symbol.iterator]=function(){return e}),e}function te(n){this.map={},n instanceof te?n.forEach(function(e,t){this.append(t,e)},this):Array.isArray(n)?n.forEach(function(e){if(e.length!=2)throw new TypeError("Headers constructor: expected name/value pair to be length 2, found"+e.length);this.append(e[0],e[1])},this):n&&Object.getOwnPropertyNames(n).forEach(function(e){this.append(e,n[e])},this)}te.prototype.append=function(n,e){n=Ot(n),e=Ca(e);var t=this.map[n];this.map[n]=t?t+", "+e:e},te.prototype.delete=function(n){delete this.map[Ot(n)]},te.prototype.get=function(n){return n=Ot(n),this.has(n)?this.map[n]:null},te.prototype.has=function(n){return this.map.hasOwnProperty(Ot(n))},te.prototype.set=function(n,e){this.map[Ot(n)]=Ca(e)},te.prototype.forEach=function(n,e){for(var t in this.map)this.map.hasOwnProperty(t)&&n.call(e,this.map[t],t,this)},te.prototype.keys=function(){var n=[];return this.forEach(function(e,t){n.push(t)}),$a(n)},te.prototype.values=function(){var n=[];return this.forEach(function(e){n.push(e)}),$a(n)},te.prototype.entries=function(){var n=[];return this.forEach(function(e,t){n.push([t,e])}),$a(n)},he.iterable&&(te.prototype[Symbol.iterator]=te.prototype.entries);function ja(n){if(!n._noBody){if(n.bodyUsed)return Promise.reject(new TypeError("Already read"));n.bodyUsed=!0}}function Ro(n){return new Promise(function(e,t){n.onload=function(){e(n.result)},n.onerror=function(){t(n.error)}})}function wh(n){var e=new FileReader,t=Ro(e);return e.readAsArrayBuffer(n),t}function vh(n){var e=new FileReader,t=Ro(e),r=/charset=([A-Za-z0-9_-]+)/.exec(n.type),a=r?r[1]:"utf-8";return e.readAsText(n,a),t}function Eh(n){for(var e=new Uint8Array(n),t=new Array(e.length),r=0;r<e.length;r++)t[r]=String.fromCharCode(e[r]);return t.join("")}function Io(n){if(n.slice)return n.slice(0);var e=new Uint8Array(n.byteLength);return e.set(new Uint8Array(n)),e.buffer}function ko(){return this.bodyUsed=!1,this._initBody=function(n){this.bodyUsed=this.bodyUsed,this._bodyInit=n,n?typeof n=="string"?this._bodyText=n:he.blob&&Blob.prototype.isPrototypeOf(n)?this._bodyBlob=n:he.formData&&FormData.prototype.isPrototypeOf(n)?this._bodyFormData=n:he.searchParams&&URLSearchParams.prototype.isPrototypeOf(n)?this._bodyText=n.toString():he.arrayBuffer&&he.blob&&yh(n)?(this._bodyArrayBuffer=Io(n.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):he.arrayBuffer&&(ArrayBuffer.prototype.isPrototypeOf(n)||_h(n))?this._bodyArrayBuffer=Io(n):this._bodyText=n=Object.prototype.toString.call(n):(this._noBody=!0,this._bodyText=""),this.headers.get("content-type")||(typeof n=="string"?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):he.searchParams&&URLSearchParams.prototype.isPrototypeOf(n)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},he.blob&&(this.blob=function(){var n=ja(this);if(n)return n;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))}),this.arrayBuffer=function(){if(this._bodyArrayBuffer){var n=ja(this);return n||(ArrayBuffer.isView(this._bodyArrayBuffer)?Promise.resolve(this._bodyArrayBuffer.buffer.slice(this._bodyArrayBuffer.byteOffset,this._bodyArrayBuffer.byteOffset+this._bodyArrayBuffer.byteLength)):Promise.resolve(this._bodyArrayBuffer))}else{if(he.blob)return this.blob().then(wh);throw new Error("could not read as ArrayBuffer")}},this.text=function(){var n=ja(this);if(n)return n;if(this._bodyBlob)return vh(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(Eh(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},he.formData&&(this.formData=function(){return this.text().then(Sh)}),this.json=function(){return this.text().then(JSON.parse)},this}var Oh=["CONNECT","DELETE","GET","HEAD","OPTIONS","PATCH","POST","PUT","TRACE"];function xh(n){var e=n.toUpperCase();return Oh.indexOf(e)>-1?e:n}function ct(n,e){if(!(this instanceof ct))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');e=e||{};var t=e.body;if(n instanceof ct){if(n.bodyUsed)throw new TypeError("Already read");this.url=n.url,this.credentials=n.credentials,e.headers||(this.headers=new te(n.headers)),this.method=n.method,this.mode=n.mode,this.signal=n.signal,!t&&n._bodyInit!=null&&(t=n._bodyInit,n.bodyUsed=!0)}else this.url=String(n);if(this.credentials=e.credentials||this.credentials||"same-origin",(e.headers||!this.headers)&&(this.headers=new te(e.headers)),this.method=xh(e.method||this.method||"GET"),this.mode=e.mode||this.mode||null,this.signal=e.signal||this.signal||function(){if("AbortController"in se){var i=new AbortController;return i.signal}}(),this.referrer=null,(this.method==="GET"||this.method==="HEAD")&&t)throw new TypeError("Body not allowed for GET or HEAD requests");if(this._initBody(t),(this.method==="GET"||this.method==="HEAD")&&(e.cache==="no-store"||e.cache==="no-cache")){var r=/([?&])_=[^&]*/;if(r.test(this.url))this.url=this.url.replace(r,"$1_="+new Date().getTime());else{var a=/\?/;this.url+=(a.test(this.url)?"&":"?")+"_="+new Date().getTime()}}}ct.prototype.clone=function(){return new ct(this,{body:this._bodyInit})};function Sh(n){var e=new FormData;return n.trim().split("&").forEach(function(t){if(t){var r=t.split("="),a=r.shift().replace(/\+/g," "),i=r.join("=").replace(/\+/g," ");e.append(decodeURIComponent(a),decodeURIComponent(i))}}),e}function Th(n){var e=new te,t=n.replace(/\r?\n[\t ]+/g," ");return t.split("\r").map(function(r){return r.indexOf(`
`)===0?r.substr(1,r.length):r}).forEach(function(r){var a=r.split(":"),i=a.shift().trim();if(i){var s=a.join(":").trim();try{e.append(i,s)}catch(o){console.warn("Response "+o.message)}}}),e}ko.call(ct.prototype);function Me(n,e){if(!(this instanceof Me))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');if(e||(e={}),this.type="default",this.status=e.status===void 0?200:e.status,this.status<200||this.status>599)throw new RangeError("Failed to construct 'Response': The status provided (0) is outside the range [200, 599].");this.ok=this.status>=200&&this.status<300,this.statusText=e.statusText===void 0?"":""+e.statusText,this.headers=new te(e.headers),this.url=e.url||"",this._initBody(n)}ko.call(Me.prototype),Me.prototype.clone=function(){return new Me(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new te(this.headers),url:this.url})},Me.error=function(){var n=new Me(null,{status:200,statusText:""});return n.ok=!1,n.status=0,n.type="error",n};var Ph=[301,302,303,307,308];Me.redirect=function(n,e){if(Ph.indexOf(e)===-1)throw new RangeError("Invalid status code");return new Me(null,{status:e,headers:{location:n}})};var dt=se.DOMException;try{new dt}catch{dt=function(e,t){this.message=e,this.name=t;var r=Error(e);this.stack=r.stack},dt.prototype=Object.create(Error.prototype),dt.prototype.constructor=dt}function Co(n,e){return new Promise(function(t,r){var a=new ct(n,e);if(a.signal&&a.signal.aborted)return r(new dt("Aborted","AbortError"));var i=new XMLHttpRequest;function s(){i.abort()}i.onload=function(){var l={statusText:i.statusText,headers:Th(i.getAllResponseHeaders()||"")};a.url.indexOf("file://")===0&&(i.status<200||i.status>599)?l.status=200:l.status=i.status,l.url="responseURL"in i?i.responseURL:l.headers.get("X-Request-URL");var c="response"in i?i.response:i.responseText;setTimeout(function(){t(new Me(c,l))},0)},i.onerror=function(){setTimeout(function(){r(new TypeError("Network request failed"))},0)},i.ontimeout=function(){setTimeout(function(){r(new TypeError("Network request timed out"))},0)},i.onabort=function(){setTimeout(function(){r(new dt("Aborted","AbortError"))},0)};function o(l){try{return l===""&&se.location.href?se.location.href:l}catch{return l}}if(i.open(a.method,o(a.url),!0),a.credentials==="include"?i.withCredentials=!0:a.credentials==="omit"&&(i.withCredentials=!1),"responseType"in i&&(he.blob?i.responseType="blob":he.arrayBuffer&&(i.responseType="arraybuffer")),e&&typeof e.headers=="object"&&!(e.headers instanceof te||se.Headers&&e.headers instanceof se.Headers)){var u=[];Object.getOwnPropertyNames(e.headers).forEach(function(l){u.push(Ot(l)),i.setRequestHeader(l,Ca(e.headers[l]))}),a.headers.forEach(function(l,c){u.indexOf(c)===-1&&i.setRequestHeader(c,l)})}else a.headers.forEach(function(l,c){i.setRequestHeader(c,l)});a.signal&&(a.signal.addEventListener("abort",s),i.onreadystatechange=function(){i.readyState===4&&a.signal.removeEventListener("abort",s)}),i.send(typeof a._bodyInit>"u"?null:a._bodyInit)})}Co.polyfill=!0,se.fetch||(se.fetch=Co,se.Headers=te,se.Request=ct,se.Response=Me);const $o="11434",jo=`http://127.0.0.1:${$o}`,Ah="0.5.15";var Rh=Object.defineProperty,Ih=(n,e,t)=>e in n?Rh(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Na=(n,e,t)=>(Ih(n,typeof e!="symbol"?e+"":e,t),t);class La extends Error{constructor(e,t){super(e),this.error=e,this.status_code=t,this.name="ResponseError",Error.captureStackTrace&&Error.captureStackTrace(this,La)}}class kh{constructor(e,t,r){Na(this,"abortController"),Na(this,"itr"),Na(this,"doneCallback"),this.abortController=e,this.itr=t,this.doneCallback=r}abort(){this.abortController.abort()}async*[Symbol.asyncIterator](){for await(const e of this.itr){if("error"in e)throw new Error(e.error);if(yield e,e.done||e.status==="success"){this.doneCallback();return}}throw new Error("Did not receive done or success response in stream.")}}const Ma=async n=>{if(n.ok)return;let e=`Error ${n.status}: ${n.statusText}`,t=null;if(n.headers.get("content-type")?.includes("application/json"))try{t=await n.json(),e=t.error||e}catch{console.log("Failed to parse error response as JSON")}else try{console.log("Getting text from response"),e=await n.text()||e}catch{console.log("Failed to get text from error response")}throw new La(e,n.status)};function Ch(){if(typeof window<"u"&&window.navigator){const n=navigator;return"userAgentData"in n&&n.userAgentData?.platform?`${n.userAgentData.platform.toLowerCase()} Browser/${navigator.userAgent};`:navigator.platform?`${navigator.platform.toLowerCase()} Browser/${navigator.userAgent};`:`unknown Browser/${navigator.userAgent};`}else if(typeof process<"u")return`${process.arch} ${process.platform} Node.js/${process.version}`;return""}function $h(n){if(n instanceof Headers){const e={};return n.forEach((t,r)=>{e[r]=t}),e}else return Array.isArray(n)?Object.fromEntries(n):n||{}}const Fa=async(n,e,t={})=>{const r={"Content-Type":"application/json",Accept:"application/json","User-Agent":`ollama-js/${Ah} (${Ch()})`};t.headers=$h(t.headers);const a=Object.fromEntries(Object.entries(t.headers).filter(([i])=>!Object.keys(r).some(s=>s.toLowerCase()===i.toLowerCase())));return t.headers={...r,...a},n(e,t)},No=async(n,e,t)=>{const r=await Fa(n,e,{headers:t?.headers});return await Ma(r),r},xt=async(n,e,t,r)=>{const i=(o=>o!==null&&typeof o=="object"&&!Array.isArray(o))(t)?JSON.stringify(t):t,s=await Fa(n,e,{method:"POST",body:i,signal:r?.signal,headers:r?.headers});return await Ma(s),s},jh=async(n,e,t,r)=>{const a=await Fa(n,e,{method:"DELETE",body:JSON.stringify(t),headers:r?.headers});return await Ma(a),a},Nh=async function*(n){const e=new TextDecoder("utf-8");let t="";const r=n.getReader();for(;;){const{done:a,value:i}=await r.read();if(a)break;t+=e.decode(i);const s=t.split(`
`);t=s.pop()??"";for(const o of s)try{yield JSON.parse(o)}catch{console.warn("invalid json: ",o)}}for(const a of t.split(`
`).filter(i=>i!==""))try{yield JSON.parse(a)}catch{console.warn("invalid json: ",a)}},Lh=n=>{if(!n)return jo;let e=n.includes("://");n.startsWith(":")&&(n=`http://127.0.0.1${n}`,e=!0),e||(n=`http://${n}`);const t=new URL(n);let r=t.port;r||(e?r=t.protocol==="https:"?"443":"80":r=$o);let a="";t.username&&(a=t.username,t.password&&(a+=`:${t.password}`),a+="@");let i=`${t.protocol}//${a}${t.hostname}:${r}${t.pathname}`;return i.endsWith("/")&&(i=i.slice(0,-1)),i};var Mh=Object.defineProperty,Fh=(n,e,t)=>e in n?Mh(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Da=(n,e,t)=>(Fh(n,typeof e!="symbol"?e+"":e,t),t);let Lo=class{constructor(e){Da(this,"config"),Da(this,"fetch"),Da(this,"ongoingStreamedRequests",[]),this.config={host:"",headers:e?.headers},e?.proxy||(this.config.host=Lh(e?.host??jo)),this.fetch=e?.fetch??fetch}abort(){for(const e of this.ongoingStreamedRequests)e.abort();this.ongoingStreamedRequests.length=0}async processStreamableRequest(e,t){t.stream=t.stream??!1;const r=`${this.config.host}/api/${e}`;if(t.stream){const i=new AbortController,s=await xt(this.fetch,r,t,{signal:i.signal,headers:this.config.headers});if(!s.body)throw new Error("Missing body");const o=Nh(s.body),u=new kh(i,o,()=>{const l=this.ongoingStreamedRequests.indexOf(u);l>-1&&this.ongoingStreamedRequests.splice(l,1)});return this.ongoingStreamedRequests.push(u),u}return await(await xt(this.fetch,r,t,{headers:this.config.headers})).json()}async encodeImage(e){if(typeof e!="string"){const t=new Uint8Array(e);let r="";const a=t.byteLength;for(let i=0;i<a;i++)r+=String.fromCharCode(t[i]);return btoa(r)}return e}async generate(e){return e.images&&(e.images=await Promise.all(e.images.map(this.encodeImage.bind(this)))),this.processStreamableRequest("generate",e)}async chat(e){if(e.messages)for(const t of e.messages)t.images&&(t.images=await Promise.all(t.images.map(this.encodeImage.bind(this))));return this.processStreamableRequest("chat",e)}async create(e){return this.processStreamableRequest("create",{...e})}async pull(e){return this.processStreamableRequest("pull",{name:e.model,stream:e.stream,insecure:e.insecure})}async push(e){return this.processStreamableRequest("push",{name:e.model,stream:e.stream,insecure:e.insecure})}async delete(e){return await jh(this.fetch,`${this.config.host}/api/delete`,{name:e.model},{headers:this.config.headers}),{status:"success"}}async copy(e){return await xt(this.fetch,`${this.config.host}/api/copy`,{...e},{headers:this.config.headers}),{status:"success"}}async list(){return await(await No(this.fetch,`${this.config.host}/api/tags`,{headers:this.config.headers})).json()}async show(e){return await(await xt(this.fetch,`${this.config.host}/api/show`,{...e},{headers:this.config.headers})).json()}async embed(e){return await(await xt(this.fetch,`${this.config.host}/api/embed`,{...e},{headers:this.config.headers})).json()}async embeddings(e){return await(await xt(this.fetch,`${this.config.host}/api/embeddings`,{...e},{headers:this.config.headers})).json()}async ps(){return await(await No(this.fetch,`${this.config.host}/api/ps`,{headers:this.config.headers})).json()}};new Lo;class St extends gh{constructor({concurrency:e,...t}){super(e?{maxConcurrency:e,...t}:t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","llms",this._llmType()]})}async invoke(e,t){const r=St._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t?.callbacks)).generations[0][0].text}async*_streamResponseChunks(e,t,r){throw new Error("Not implemented.")}_separateRunnableConfigFromCallOptionsCompat(e){const[t,r]=super._separateRunnableConfigFromCallOptions(e);return r.signal=t.signal,[t,r]}async*_streamIterator(e,t){if(this._streamResponseChunks===St.prototype._streamResponseChunks)yield this.invoke(e,t);else{const r=St._convertInputToPromptValue(e),[a,i]=this._separateRunnableConfigFromCallOptionsCompat(t),s=await ge.configure(a.callbacks,this.callbacks,a.tags,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),o={options:i,invocation_params:this?.invocationParams(i),batch_size:1},u=await s?.handleLLMStart(this.toJSON(),[r.toString()],a.runId,void 0,o,void 0,void 0,a.runName);let l=new st({text:""});try{for await(const c of this._streamResponseChunks(r.toString(),i,u?.[0]))l?l=l.concat(c):l=c,typeof c.text=="string"&&(yield c.text)}catch(c){throw await Promise.all((u??[]).map(h=>h?.handleLLMError(c))),c}await Promise.all((u??[]).map(c=>c?.handleLLMEnd({generations:[[l]]})))}}async generatePrompt(e,t,r){const a=e.map(i=>i.toString());return this.generate(a,t,r)}invocationParams(e){return{}}_flattenLLMResult(e){const t=[];for(let r=0;r<e.generations.length;r+=1){const a=e.generations[r];if(r===0)t.push({generations:[a],llmOutput:e.llmOutput});else{const i=e.llmOutput?{...e.llmOutput,tokenUsage:{}}:void 0;t.push({generations:[a],llmOutput:i})}}return t}async _generateUncached(e,t,r,a){let i;if(a!==void 0&&a.length===e.length)i=a;else{const l=await ge.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),c={options:t,invocation_params:this?.invocationParams(t),batch_size:e.length};i=await l?.handleLLMStart(this.toJSON(),e,r.runId,void 0,c,void 0,void 0,r?.runName)}const s=!!i?.[0].handlers.find(_c);let o;if(s&&e.length===1&&this._streamResponseChunks!==St.prototype._streamResponseChunks)try{const l=await this._streamResponseChunks(e[0],t,i?.[0]);let c;for await(const h of l)c===void 0?c=h:c=Le(c,h);if(c===void 0)throw new Error("Received empty response from chat model call.");o={generations:[[c]],llmOutput:{}},await i?.[0].handleLLMEnd(o)}catch(l){throw await i?.[0].handleLLMError(l),l}else{try{o=await this._generate(e,t,i?.[0])}catch(c){throw await Promise.all((i??[]).map(h=>h?.handleLLMError(c))),c}const l=this._flattenLLMResult(o);await Promise.all((i??[]).map((c,h)=>c?.handleLLMEnd(l[h])))}const u=i?.map(l=>l.runId)||void 0;return Object.defineProperty(o,uo,{value:u?{runIds:u}:void 0,configurable:!0}),o}async _generateCached({prompts:e,cache:t,llmStringKey:r,parsedOptions:a,handledOptions:i,runId:s}){const o=await ge.configure(i.callbacks,this.callbacks,i.tags,this.tags,i.metadata,this.metadata,{verbose:this.verbose}),u={options:a,invocation_params:this?.invocationParams(a),batch_size:e.length},l=await o?.handleLLMStart(this.toJSON(),e,s,void 0,u,void 0,void 0,i?.runName),c=[],d=(await Promise.allSettled(e.map(async(m,g)=>{const y=await t.lookup(m,r);return y==null&&c.push(g),y}))).map((m,g)=>({result:m,runManager:l?.[g]})).filter(({result:m})=>m.status==="fulfilled"&&m.value!=null||m.status==="rejected"),f=[];await Promise.all(d.map(async({result:m,runManager:g},y)=>{if(m.status==="fulfilled"){const _=m.value;return f[y]=_.map(b=>(b.generationInfo={...b.generationInfo,tokenUsage:{}},b)),_.length&&await g?.handleLLMNewToken(_[0].text),g?.handleLLMEnd({generations:[_]},void 0,void 0,void 0,{cached:!0})}else return await g?.handleLLMError(m.reason,void 0,void 0,void 0,{cached:!0}),Promise.reject(m.reason)}));const p={generations:f,missingPromptIndices:c,startedRunManagers:l};return Object.defineProperty(p,uo,{value:l?{runIds:l?.map(m=>m.runId)}:void 0,configurable:!0}),p}async generate(e,t,r){if(!Array.isArray(e))throw new Error("Argument 'prompts' is expected to be a string[]");let a;Array.isArray(t)?a={stop:t}:a=t;const[i,s]=this._separateRunnableConfigFromCallOptionsCompat(a);if(i.callbacks=i.callbacks??r,!this.cache)return this._generateUncached(e,s,i);const{cache:o}=this,u=this._getSerializedCacheKeyParametersForCall(s),{generations:l,missingPromptIndices:c,startedRunManagers:h}=await this._generateCached({prompts:e,cache:o,llmStringKey:u,parsedOptions:s,handledOptions:i,runId:i.runId});let d={};if(c.length>0){const f=await this._generateUncached(c.map(p=>e[p]),s,i,h!==void 0?c.map(p=>h?.[p]):void 0);await Promise.all(f.generations.map(async(p,m)=>{const g=c[m];return l[g]=p,o.update(e[g],u,p)})),d=f.llmOutput??{}}return{generations:l,llmOutput:d}}async call(e,t,r){const{generations:a}=await this.generate([e],t,r);return a[0][0].text}async predict(e,t,r){return this.call(e,t,r)}async predictMessages(e,t,r){const a=zr(e),i=await this.call(a,t,r);return new nr(i)}_identifyingParams(){return{}}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}_modelType(){return"base_llm"}}class Dh extends St{async _generate(e,t,r){return{generations:await Promise.all(e.map((i,s)=>this._call(i,{...t,promptIndex:s},r).then(o=>[{text:o}])))}}}class Uh extends Dh{static lc_name(){return"Ollama"}constructor(e){super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"llama3"}),Object.defineProperty(this,"baseUrl",{enumerable:!0,configurable:!0,writable:!0,value:"http://localhost:11434"}),Object.defineProperty(this,"keepAlive",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"embeddingOnly",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"f16KV",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logitsAll",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lowVram",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mainGpu",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostat",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostatEta",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostatTau",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numBatch",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numCtx",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numGpu",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numKeep",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numPredict",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numThread",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"penalizeNewline",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"repeatLastN",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"repeatPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tfsZ",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"typicalP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useMLock",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useMMap",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"vocabOnly",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"format",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.model=e?.model??this.model,this.baseUrl=e?.baseUrl?.endsWith("/")?e?.baseUrl.slice(0,-1):e?.baseUrl??this.baseUrl,this.client=new Lo({host:this.baseUrl,headers:e?.headers}),this.keepAlive=e?.keepAlive,this.embeddingOnly=e?.embeddingOnly,this.f16KV=e?.f16Kv,this.frequencyPenalty=e?.frequencyPenalty,this.logitsAll=e?.logitsAll,this.lowVram=e?.lowVram,this.mainGpu=e?.mainGpu,this.mirostat=e?.mirostat,this.mirostatEta=e?.mirostatEta,this.mirostatTau=e?.mirostatTau,this.numBatch=e?.numBatch,this.numCtx=e?.numCtx,this.numGpu=e?.numGpu,this.numKeep=e?.numKeep,this.numPredict=e?.numPredict,this.numThread=e?.numThread,this.penalizeNewline=e?.penalizeNewline,this.presencePenalty=e?.presencePenalty,this.repeatLastN=e?.repeatLastN,this.repeatPenalty=e?.repeatPenalty,this.temperature=e?.temperature,this.stop=e?.stop,this.tfsZ=e?.tfsZ,this.topK=e?.topK,this.topP=e?.topP,this.typicalP=e?.typicalP,this.useMLock=e?.useMlock,this.useMMap=e?.useMmap,this.vocabOnly=e?.vocabOnly,this.format=e?.format}_llmType(){return"ollama"}invocationParams(e){return{model:this.model,format:this.format,keep_alive:this.keepAlive,images:e?.images,options:{embedding_only:this.embeddingOnly,f16_kv:this.f16KV,frequency_penalty:this.frequencyPenalty,logits_all:this.logitsAll,low_vram:this.lowVram,main_gpu:this.mainGpu,mirostat:this.mirostat,mirostat_eta:this.mirostatEta,mirostat_tau:this.mirostatTau,num_batch:this.numBatch,num_ctx:this.numCtx,num_gpu:this.numGpu,num_keep:this.numKeep,num_predict:this.numPredict,num_thread:this.numThread,penalize_newline:this.penalizeNewline,presence_penalty:this.presencePenalty,repeat_last_n:this.repeatLastN,repeat_penalty:this.repeatPenalty,temperature:this.temperature,stop:e?.stop??this.stop,tfs_z:this.tfsZ,top_k:this.topK,top_p:this.topP,typical_p:this.typicalP,use_mlock:this.useMLock,use_mmap:this.useMMap,vocab_only:this.vocabOnly}}}async*_streamResponseChunks(e,t,r){const a=await this.caller.call(async()=>this.client.generate({...this.invocationParams(t),prompt:e,stream:!0}));for await(const i of a){if(t.signal?.aborted)throw new Error("This operation was aborted");i.done?yield new st({text:"",generationInfo:{model:i.model,total_duration:i.total_duration,load_duration:i.load_duration,prompt_eval_count:i.prompt_eval_count,prompt_eval_duration:i.prompt_eval_duration,eval_count:i.eval_count,eval_duration:i.eval_duration}}):(yield new st({text:i.response,generationInfo:{...i,response:void 0}}),await r?.handleLLMNewToken(i.response??""))}}async _call(e,t,r){const a=[];for await(const i of this._streamResponseChunks(e,t,r))a.push(i.text);return a.join("")}}class Ua extends ne{get lc_attributes(){return{partialVariables:void 0}}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts",this._getPromptType()]}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partialVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){const t=this.partialVariables??{},r={};for(const[i,s]of Object.entries(t))typeof s=="string"?r[i]=s:r[i]=await s();return{...r,...e}}async invoke(e,t){const r={...this.metadata,...t?.metadata},a=[...this.tags??[],...t?.tags??[]];return this._callWithConfig(i=>this.formatPromptValue(i),e,{...t,tags:a,metadata:r,runType:"prompt"})}serialize(){throw new Error("Use .toJSON() instead")}static async deserialize(e){switch(e._type){case"prompt":{const{PromptTemplate:t}=await Promise.resolve().then(function(){return Uo});return t.deserialize(e)}case void 0:{const{PromptTemplate:t}=await Promise.resolve().then(function(){return Uo});return t.deserialize({...e,_type:"prompt"})}case"few_shot":{const{FewShotPromptTemplate:t}=await Promise.resolve().then(function(){return mf});return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}}class Fr extends Ua{async formatPromptValue(e){const t=await this.format(e);return new So(t)}}/*!
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */var Bh=Object.prototype.toString,Tt=Array.isArray||function(e){return Bh.call(e)==="[object Array]"};function Ba(n){return typeof n=="function"}function Vh(n){return Tt(n)?"array":typeof n}function Va(n){return n.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function Mo(n,e){return n!=null&&typeof n=="object"&&e in n}function qh(n,e){return n!=null&&typeof n!="object"&&n.hasOwnProperty&&n.hasOwnProperty(e)}var Hh=RegExp.prototype.test;function zh(n,e){return Hh.call(n,e)}var Gh=/\S/;function Zh(n){return!zh(Gh,n)}var Wh={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function Jh(n){return String(n).replace(/[&<>"'`=\/]/g,function(t){return Wh[t]})}var Kh=/\s*/,Xh=/\s+/,Fo=/\s*=/,Yh=/\s*\}/,Qh=/#|\^|\/|>|\{|&|=|!/;function ef(n,e){if(!n)return[];var t=!1,r=[],a=[],i=[],s=!1,o=!1,u="",l=0;function c(){if(s&&!o)for(;i.length;)delete a[i.pop()];else i=[];s=!1,o=!1}var h,d,f;function p(S){if(typeof S=="string"&&(S=S.split(Xh,2)),!Tt(S)||S.length!==2)throw new Error("Invalid tags: "+S);h=new RegExp(Va(S[0])+"\\s*"),d=new RegExp("\\s*"+Va(S[1])),f=new RegExp("\\s*"+Va("}"+S[1]))}p(e||ye.tags);for(var m=new Wt(n),g,y,_,b,P,E;!m.eos();){if(g=m.pos,_=m.scanUntil(h),_)for(var k=0,M=_.length;k<M;++k)b=_.charAt(k),Zh(b)?(i.push(a.length),u+=b):(o=!0,t=!0,u+=" "),a.push(["text",b,g,g+1]),g+=1,b===`
`&&(c(),u="",l=0,t=!1);if(!m.scan(h))break;if(s=!0,y=m.scan(Qh)||"name",m.scan(Kh),y==="="?(_=m.scanUntil(Fo),m.scan(Fo),m.scanUntil(d)):y==="{"?(_=m.scanUntil(f),m.scan(Yh),m.scanUntil(d),y="&"):_=m.scanUntil(d),!m.scan(d))throw new Error("Unclosed tag at "+m.pos);if(y==">"?P=[y,_,g,m.pos,u,l,t]:P=[y,_,g,m.pos],l++,a.push(P),y==="#"||y==="^")r.push(P);else if(y==="/"){if(E=r.pop(),!E)throw new Error('Unopened section "'+_+'" at '+g);if(E[1]!==_)throw new Error('Unclosed section "'+E[1]+'" at '+g)}else y==="name"||y==="{"||y==="&"?o=!0:y==="="&&p(_)}if(c(),E=r.pop(),E)throw new Error('Unclosed section "'+E[1]+'" at '+m.pos);return rf(tf(a))}function tf(n){for(var e=[],t,r,a=0,i=n.length;a<i;++a)t=n[a],t&&(t[0]==="text"&&r&&r[0]==="text"?(r[1]+=t[1],r[3]=t[3]):(e.push(t),r=t));return e}function rf(n){for(var e=[],t=e,r=[],a,i,s=0,o=n.length;s<o;++s)switch(a=n[s],a[0]){case"#":case"^":t.push(a),r.push(a),t=a[4]=[];break;case"/":i=r.pop(),i[5]=a[2],t=r.length>0?r[r.length-1][4]:e;break;default:t.push(a)}return e}function Wt(n){this.string=n,this.tail=n,this.pos=0}Wt.prototype.eos=function(){return this.tail===""},Wt.prototype.scan=function(e){var t=this.tail.match(e);if(!t||t.index!==0)return"";var r=t[0];return this.tail=this.tail.substring(r.length),this.pos+=r.length,r},Wt.prototype.scanUntil=function(e){var t=this.tail.search(e),r;switch(t){case-1:r=this.tail,this.tail="";break;case 0:r="";break;default:r=this.tail.substring(0,t),this.tail=this.tail.substring(t)}return this.pos+=r.length,r};function Pt(n,e){this.view=n,this.cache={".":this.view},this.parent=e}Pt.prototype.push=function(e){return new Pt(e,this)},Pt.prototype.lookup=function(e){var t=this.cache,r;if(t.hasOwnProperty(e))r=t[e];else{for(var a=this,i,s,o,u=!1;a;){if(e.indexOf(".")>0)for(i=a.view,s=e.split("."),o=0;i!=null&&o<s.length;)o===s.length-1&&(u=Mo(i,s[o])||qh(i,s[o])),i=i[s[o++]];else i=a.view[e],u=Mo(a.view,e);if(u){r=i;break}a=a.parent}t[e]=r}return Ba(r)&&(r=r.call(this.view)),r};function fe(){this.templateCache={_cache:{},set:function(e,t){this._cache[e]=t},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}fe.prototype.clearCache=function(){typeof this.templateCache<"u"&&this.templateCache.clear()},fe.prototype.parse=function(e,t){var r=this.templateCache,a=e+":"+(t||ye.tags).join(":"),i=typeof r<"u",s=i?r.get(a):void 0;return s==null&&(s=ef(e,t),i&&r.set(a,s)),s},fe.prototype.render=function(e,t,r,a){var i=this.getConfigTags(a),s=this.parse(e,i),o=t instanceof Pt?t:new Pt(t,void 0);return this.renderTokens(s,o,r,e,a)},fe.prototype.renderTokens=function(e,t,r,a,i){for(var s="",o,u,l,c=0,h=e.length;c<h;++c)l=void 0,o=e[c],u=o[0],u==="#"?l=this.renderSection(o,t,r,a,i):u==="^"?l=this.renderInverted(o,t,r,a,i):u===">"?l=this.renderPartial(o,t,r,i):u==="&"?l=this.unescapedValue(o,t):u==="name"?l=this.escapedValue(o,t,i):u==="text"&&(l=this.rawValue(o)),l!==void 0&&(s+=l);return s},fe.prototype.renderSection=function(e,t,r,a,i){var s=this,o="",u=t.lookup(e[1]);function l(d){return s.render(d,t,r,i)}if(u){if(Tt(u))for(var c=0,h=u.length;c<h;++c)o+=this.renderTokens(e[4],t.push(u[c]),r,a,i);else if(typeof u=="object"||typeof u=="string"||typeof u=="number")o+=this.renderTokens(e[4],t.push(u),r,a,i);else if(Ba(u)){if(typeof a!="string")throw new Error("Cannot use higher-order sections without the original template");u=u.call(t.view,a.slice(e[3],e[5]),l),u!=null&&(o+=u)}else o+=this.renderTokens(e[4],t,r,a,i);return o}},fe.prototype.renderInverted=function(e,t,r,a,i){var s=t.lookup(e[1]);if(!s||Tt(s)&&s.length===0)return this.renderTokens(e[4],t,r,a,i)},fe.prototype.indentPartial=function(e,t,r){for(var a=t.replace(/[^ \t]/g,""),i=e.split(`
`),s=0;s<i.length;s++)i[s].length&&(s>0||!r)&&(i[s]=a+i[s]);return i.join(`
`)},fe.prototype.renderPartial=function(e,t,r,a){if(r){var i=this.getConfigTags(a),s=Ba(r)?r(e[1]):r[e[1]];if(s!=null){var o=e[6],u=e[5],l=e[4],c=s;u==0&&l&&(c=this.indentPartial(s,l,o));var h=this.parse(c,i);return this.renderTokens(h,t,r,c,a)}}},fe.prototype.unescapedValue=function(e,t){var r=t.lookup(e[1]);if(r!=null)return r},fe.prototype.escapedValue=function(e,t,r){var a=this.getConfigEscape(r)||ye.escape,i=t.lookup(e[1]);if(i!=null)return typeof i=="number"&&a===ye.escape?String(i):a(i)},fe.prototype.rawValue=function(e){return e[1]},fe.prototype.getConfigTags=function(e){return Tt(e)?e:e&&typeof e=="object"?e.tags:void 0},fe.prototype.getConfigEscape=function(e){if(e&&typeof e=="object"&&!Tt(e))return e.escape};var ye={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(n){Jt.templateCache=n},get templateCache(){return Jt.templateCache}},Jt=new fe;ye.clearCache=function(){return Jt.clearCache()},ye.parse=function(e,t){return Jt.parse(e,t)},ye.render=function(e,t,r,a){if(typeof e!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+Vh(e)+'" was given as the first argument for mustache#render(template, view, partials)');return Jt.render(e,t,r,a)},ye.escape=Jh,ye.Scanner=Wt,ye.Context=Pt,ye.Writer=fe;function Do(){ye.escape=n=>n}const Dr=n=>{const e=n.split(""),t=[],r=(i,s)=>{for(let o=s;o<e.length;o+=1)if(i.includes(e[o]))return o;return-1};let a=0;for(;a<e.length;)if(e[a]==="{"&&a+1<e.length&&e[a+1]==="{")t.push({type:"literal",text:"{"}),a+=2;else if(e[a]==="}"&&a+1<e.length&&e[a+1]==="}")t.push({type:"literal",text:"}"}),a+=2;else if(e[a]==="{"){const i=r("}",a);if(i<0)throw new Error("Unclosed '{' in template.");t.push({type:"variable",name:e.slice(a+1,i).join("")}),a=i+1}else{if(e[a]==="}")throw new Error("Single '}' in template.");{const i=r("{}",a),s=(i<0?e.slice(a):e.slice(a,i)).join("");t.push({type:"literal",text:s}),a=i<0?e.length:i}}return t},nf=n=>n.map(e=>e[0]==="name"?{type:"variable",name:e[1].includes(".")?e[1].split(".")[0]:e[1]}:["#","&","^",">"].includes(e[0])?{type:"variable",name:e[1]}:{type:"literal",text:e[1]}),qa=n=>{Do();const e=ye.parse(n);return nf(e)},Ha={"f-string":(n,e)=>Dr(n).reduce((t,r)=>{if(r.type==="variable"){if(r.name in e){const a=typeof e[r.name]=="string"?e[r.name]:JSON.stringify(e[r.name]);return t+a}throw new Error(`(f-string) Missing value for input ${r.name}`)}return t+r.text},""),mustache:(n,e)=>(Do(),ye.render(n,e))},af={"f-string":Dr,mustache:qa},He=(n,e,t)=>{try{return Ha[e](n,t)}catch(r){throw qr(r,"INVALID_PROMPT_INPUT")}},za=(n,e)=>af[e](n),Ga=(n,e,t)=>{if(!(e in Ha)){const r=Object.keys(Ha);throw new Error(`Invalid template format. Got \`${e}\`;
                         should be one of ${r}`)}try{const r=t.reduce((a,i)=>(a[i]="foo",a),{});Array.isArray(n)?n.forEach(a=>{if(a.type==="text")He(a.text,e,r);else if(a.type==="image_url")if(typeof a.image_url=="string")He(a.image_url,e,r);else{const i=a.image_url.url;He(i,e,r)}else throw new Error(`Invalid message template received. ${JSON.stringify(a,null,2)}`)}):He(n,e,r)}catch(r){throw new Error(`Invalid prompt schema: ${r.message}`)}};class Oe extends Fr{static lc_name(){return"PromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"additionalContentFields",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e.templateFormat==="mustache"&&e.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){if(this.templateFormat==="mustache")throw new Error("Mustache templates cannot be validated.");let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),Ga(this.template,this.templateFormat,t)}}_getPromptType(){return"prompt"}async format(e){const t=await this.mergePartialAndUserVariables(e);return He(this.template,this.templateFormat,t)}static fromExamples(e,t,r,a=`

`,i=""){const s=[i,...e,t].join(a);return new Oe({inputVariables:r,template:s})}static fromTemplate(e,t){const{templateFormat:r="f-string",...a}=t??{},i=new Set;return za(e,r).forEach(s=>{s.type==="variable"&&i.add(s.name)}),new Oe({inputVariables:[...i],templateFormat:r,template:e,...a})}async partial(e){const t=this.inputVariables.filter(i=>!(i in e)),r={...this.partialVariables??{},...e},a={...this,inputVariables:t,partialVariables:r};return new Oe(a)}serialize(){if(this.outputParser!==void 0)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(e){if(!e.template)throw new Error("Prompt template must have a template");return new Oe({inputVariables:e.input_variables,template:e.template,templateFormat:e.template_format})}}var Uo=Object.freeze({__proto__:null,PromptTemplate:Oe});class Kt extends Ua{static lc_name(){return"ImagePromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","image"]}),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"additionalContentFields",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.template=e.template,this.templateFormat=e.templateFormat??this.templateFormat,this.validateTemplate=e.validateTemplate??this.validateTemplate,this.additionalContentFields=e.additionalContentFields,this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),Ga([{type:"image_url",image_url:this.template}],this.templateFormat,t)}}_getPromptType(){return"prompt"}async partial(e){const t=this.inputVariables.filter(i=>!(i in e)),r={...this.partialVariables??{},...e},a={...this,inputVariables:t,partialVariables:r};return new Kt(a)}async format(e){const t={};for(const[s,o]of Object.entries(this.template))typeof o=="string"?t[s]=He(o,this.templateFormat,e):t[s]=o;const r=e.url||t.url,a=e.detail||t.detail;if(!r)throw new Error("Must provide either an image URL.");if(typeof r!="string")throw new Error("url must be a string.");const i={url:r};return a&&(i.detail=a),i}async formatPromptValue(e){const t=await this.format(e);return new Qd(t)}}class Bo extends ne{static lc_name(){return"DictPromptTemplate"}constructor(e){const t=e.templateFormat??"f-string",r=Za(e.template,t);super({inputVariables:r,...e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","dict"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.template=e.template,this.templateFormat=t,this.inputVariables=r}async format(e){return Wa(this.template,e,this.templateFormat)}async invoke(e){return await this._callWithConfig(this.format.bind(this),e,{runType:"prompt"})}}function Za(n,e){const t=[];for(const r of Object.values(n))if(typeof r=="string")za(r,e).forEach(a=>{a.type==="variable"&&t.push(a.name)});else if(Array.isArray(r))for(const a of r)typeof a=="string"?za(a,e).forEach(i=>{i.type==="variable"&&t.push(i.name)}):typeof a=="object"&&t.push(...Za(a,e));else typeof r=="object"&&r!==null&&t.push(...Za(r,e));return Array.from(new Set(t))}function Wa(n,e,t){const r={};for(const[a,i]of Object.entries(n))if(typeof i=="string")r[a]=He(i,t,e);else if(Array.isArray(i)){const s=[];for(const o of i)typeof o=="string"?s.push(He(o,t,e)):typeof o=="object"&&s.push(Wa(o,e,t));r[a]=s}else typeof i=="object"&&i!==null?r[a]=Wa(i,e,t):r[a]=i;return r}class Ja extends ne{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}async invoke(e,t){return this._callWithConfig(r=>this.formatMessages(r),e,{...t,runType:"prompt"})}}class Vo extends Ja{static lc_name(){return"MessagesPlaceholder"}constructor(e){typeof e=="string"&&(e={variableName:e}),super(e),Object.defineProperty(this,"variableName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"optional",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.variableName=e.variableName,this.optional=e.optional??!1}get inputVariables(){return[this.variableName]}async formatMessages(e){const t=e[this.variableName];if(this.optional&&!t)return[];if(!t){const a=new Error(`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: undefined`);throw a.name="InputFormatError",a}let r;try{Array.isArray(t)?r=t.map(sr):r=[sr(t)]}catch(a){const i=typeof t=="string"?t:JSON.stringify(t,null,2),s=new Error([`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages or coerceable values as input.`,`Received value: ${i}`,`Additional message: ${a.message}`].join(`

`));throw s.name="InputFormatError",s.lc_error_code=a.lc_error_code,s}return r}}class sf extends Ja{constructor(e){"prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}}class of extends Ua{constructor(e){super(e)}async format(e){return(await this.formatPromptValue(e)).toString()}async formatPromptValue(e){const t=await this.formatMessages(e);return new To(t)}}class uf extends sf{static lc_name(){return"ChatMessagePromptTemplate"}constructor(e,t){"prompt"in e||(e={prompt:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}async format(e){return new ir(await this.prompt.format(e),this.role)}static fromTemplate(e,t,r){return new this(Oe.fromTemplate(e,{templateFormat:r?.templateFormat}),t)}}function lf(n){return n===null||typeof n!="object"||Array.isArray(n)?!1:Object.keys(n).length===1&&"text"in n&&typeof n.text=="string"}function cf(n){return n===null||typeof n!="object"||Array.isArray(n)?!1:"image_url"in n&&(typeof n.image_url=="string"||typeof n.image_url=="object"&&n.image_url!==null&&"url"in n.image_url&&typeof n.image_url.url=="string")}class Ka extends Ja{static _messageClass(){throw new Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}constructor(e,t){if("prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"additionalOptions",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"messageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"chatMessageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,Array.isArray(this.prompt)){let r=[];this.prompt.forEach(a=>{"inputVariables"in a&&(r=r.concat(a.inputVariables))}),this.inputVariables=r}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=t??this.additionalOptions}createMessage(e){const t=this.constructor;if(t._messageClass()){const r=t._messageClass();return new r({content:e})}else if(t.chatMessageClass){const r=t.chatMessageClass();return new r({content:e,role:this.getRoleFromMessageClass(r.lc_name())})}else throw new Error("No message class defined")}getRoleFromMessageClass(e){switch(e){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw new Error("Invalid message class name")}}static fromTemplate(e,t){if(typeof e=="string")return new this(Oe.fromTemplate(e,t));const r=[];for(const a of e)if(typeof a=="string")r.push(Oe.fromTemplate(a,t));else if(a!==null)if(lf(a)){let i="";typeof a.text=="string"&&(i=a.text??"");const s={...t,additionalContentFields:a};r.push(Oe.fromTemplate(i,s))}else if(cf(a)){let i=a.image_url??"",s,o=[];if(typeof i=="string"){let u;t?.templateFormat==="mustache"?u=qa(i):u=Dr(i);const l=u.flatMap(c=>c.type==="variable"?[c.name]:[]);if((l?.length??0)>0){if(l.length>1)throw new Error(`Only one format variable allowed per image template.
Got: ${l}
From: ${i}`);o=[l[0]]}else o=[];i={url:i},s=new Kt({template:i,inputVariables:o,templateFormat:t?.templateFormat,additionalContentFields:a})}else if(typeof i=="object"){if("url"in i){let u;t?.templateFormat==="mustache"?u=qa(i.url):u=Dr(i.url),o=u.flatMap(l=>l.type==="variable"?[l.name]:[])}else o=[];s=new Kt({template:i,inputVariables:o,templateFormat:t?.templateFormat,additionalContentFields:a})}else throw new Error("Invalid image template");r.push(s)}else typeof a=="object"&&r.push(new Bo({template:a,templateFormat:t?.templateFormat}));return new this({prompt:r,additionalOptions:t})}async format(e){if(this.prompt instanceof Fr){const t=await this.prompt.format(e);return this.createMessage(t)}else{const t=[];for(const r of this.prompt){let a={};if(!("inputVariables"in r))throw new Error(`Prompt ${r} does not have inputVariables defined.`);for(const i of r.inputVariables)a||(a={[i]:e[i]}),a={...a,[i]:e[i]};if(r instanceof Fr){const i=await r.format(a);let s;"additionalContentFields"in r&&(s=r.additionalContentFields),t.push({...s,type:"text",text:i})}else if(r instanceof Kt){const i=await r.format(a);let s;"additionalContentFields"in r&&(s=r.additionalContentFields),t.push({...s,type:"image_url",image_url:i})}else if(r instanceof Bo){const i=await r.format(a);let s;"additionalContentFields"in r&&(s=r.additionalContentFields),t.push({...s,...i})}}return this.createMessage(t)}}async formatMessages(e){return[await this.format(e)]}}class Xa extends Ka{static _messageClass(){return At}static lc_name(){return"HumanMessagePromptTemplate"}}class df extends Ka{static _messageClass(){return nr}static lc_name(){return"AIMessagePromptTemplate"}}class qo extends Ka{static _messageClass(){return Vr}static lc_name(){return"SystemMessagePromptTemplate"}}function hf(n){return typeof n.formatMessages=="function"}function ff(n,e){if(hf(n)||ii(n))return n;if(Array.isArray(n)&&n[0]==="placeholder"){const a=n[1];if(e?.templateFormat==="mustache"&&typeof a=="string"&&a.slice(0,2)==="{{"&&a.slice(-2)==="}}"){const i=a.slice(2,-2);return new Vo({variableName:i,optional:!0})}else if(typeof a=="string"&&a[0]==="{"&&a[a.length-1]==="}"){const i=a.slice(1,-1);return new Vo({variableName:i,optional:!0})}throw new Error(`Invalid placeholder template for format ${e?.templateFormat??'"f-string"'}: "${n[1]}". Expected a variable name surrounded by ${e?.templateFormat==="mustache"?"double":"single"} curly braces.`)}const t=sr(n);let r;if(typeof t.content=="string"?r=t.content:r=t.content.map(a=>"text"in a?{...a,text:a.text}:"image_url"in a?{...a,image_url:a.image_url}:a),t._getType()==="human")return Xa.fromTemplate(r,e);if(t._getType()==="ai")return df.fromTemplate(r,e);if(t._getType()==="system")return qo.fromTemplate(r,e);if(ir.isInstance(t))return uf.fromTemplate(t.content,t.role,e);throw new Error(`Could not coerce message prompt template from input. Received message type: "${t._getType()}".`)}function pf(n){return n.constructor.lc_name()==="MessagesPlaceholder"}class Xt extends of{static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}constructor(e){if(super(e),Object.defineProperty(this,"promptMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),e.templateFormat==="mustache"&&e.validateTemplate===void 0&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){const t=new Set;for(const o of this.promptMessages)if(!(o instanceof Fe))for(const u of o.inputVariables)t.add(u);const r=this.inputVariables,a=new Set(this.partialVariables?r.concat(Object.keys(this.partialVariables)):r),i=new Set([...a].filter(o=>!t.has(o)));if(i.size>0)throw new Error(`Input variables \`${[...i]}\` are not used in any of the prompt messages.`);const s=new Set([...t].filter(o=>!a.has(o)));if(s.size>0)throw new Error(`Input variables \`${[...s]}\` are used in prompt messages but not in the prompt template.`)}}_getPromptType(){return"chat"}async _parseImagePrompts(e,t){if(typeof e.content=="string")return e;const r=await Promise.all(e.content.map(async a=>{if(a.type!=="image_url")return a;let i="";typeof a.image_url=="string"?i=a.image_url:i=a.image_url.url;const o=await Oe.fromTemplate(i,{templateFormat:this.templateFormat}).format(t);return typeof a.image_url!="string"&&"url"in a.image_url?a.image_url.url=o:a.image_url=o,a}));return e.content=r,e}async formatMessages(e){const t=await this.mergePartialAndUserVariables(e);let r=[];for(const a of this.promptMessages)if(a instanceof Fe)r.push(await this._parseImagePrompts(a,t));else{const i=a.inputVariables.reduce((o,u)=>{if(!(u in t)&&!(pf(a)&&a.optional))throw qr(new Error(`Missing value for input variable \`${u.toString()}\``),"INVALID_PROMPT_INPUT");return o[u]=t[u],o},{}),s=await a.formatMessages(i);r=r.concat(s)}return r}async partial(e){const t=this.inputVariables.filter(i=>!(i in e)),r={...this.partialVariables??{},...e},a={...this,inputVariables:t,partialVariables:r};return new Xt(a)}static fromTemplate(e,t){const r=Oe.fromTemplate(e,t),a=new Xa({prompt:r});return this.fromMessages([a])}static fromMessages(e,t){const r=e.reduce((s,o)=>s.concat(o instanceof Xt?o.promptMessages:[ff(o,t)]),[]),a=e.reduce((s,o)=>o instanceof Xt?Object.assign(s,o.partialVariables):s,Object.create(null)),i=new Set;for(const s of r)if(!(s instanceof Fe))for(const o of s.inputVariables)o in a||i.add(o);return new this({...t,inputVariables:[...i],promptMessages:r,partialVariables:a,templateFormat:t?.templateFormat})}static fromPromptMessages(e){return this.fromMessages(e)}}class Ur extends Fr{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:`

`}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.examples!==void 0&&this.exampleSelector!==void 0)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(this.examples===void 0&&this.exampleSelector===void 0)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),Ga(this.prefix+this.suffix,this.templateFormat,t)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}async getExamples(e){if(this.examples!==void 0)return this.examples;if(this.exampleSelector!==void 0)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async partial(e){const t=this.inputVariables.filter(i=>!(i in e)),r={...this.partialVariables??{},...e},a={...this,inputVariables:t,partialVariables:r};return new Ur(a)}async format(e){const t=await this.mergePartialAndUserVariables(e),r=await this.getExamples(t),a=await Promise.all(r.map(s=>this.examplePrompt.format(s))),i=[this.prefix,...a,this.suffix].join(this.exampleSeparator);return He(i,this.templateFormat,t)}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(this.outputParser!==void 0)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(e){const{example_prompt:t}=e;if(!t)throw new Error("Missing example prompt");const r=await Oe.deserialize(t);let a;if(Array.isArray(e.examples))a=e.examples;else throw new Error("Invalid examples format. Only list or string are supported.");return new Ur({inputVariables:e.input_variables,examplePrompt:r,examples:a,exampleSeparator:e.example_separator,prefix:e.prefix,suffix:e.suffix,templateFormat:e.template_format})}}var mf=Object.freeze({__proto__:null,FewShotPromptTemplate:Ur});let Ho;const gf={mcp_add:(n,e)=>Number(n)+Number(e),mcp_time:()=>new Date().toLocaleString(),mcp_animation:(...n)=>{let e=[];console.log("animation:",n);for(let t of n)e.push(["Dance","Death","Idle","Jump","Shake Head","Punch","Running","Sitting","Standing","ThumbsUp","Walking","WalkJump","Wave","Nod"].indexOf(t));return e}},yf=async()=>{function n(a){const{func_feature:i,func_name:s,wait:o}=a;return`我有一个可以让你${i}的方法，你想要使用的时候可以告诉我你想要调用这个方法，格式是"<call>${s}:["参数1","参数2",...]</call>"${o?"，调用后等待回复的结果，然后再给出相应回答":""}。`}const e=n({func_feature:"计算两个数相加结果",func_name:"mcp_add",wait:!0})+n({func_feature:"仅获取当前时间但是无法计算时间",func_name:"mcp_time",wait:!0})+n({func_feature:'做列表里的这些动作[ "Dance", "Death", "Idle", "Jump", "Shake Head", "Punch", "Running", "Sitting", "Standing", "ThumbsUp", "Walking", "WalkJump", "Wave", "Nod" ]',func_name:"mcp_animation",wait:!1});console.log(e);const t=Xt.fromMessages([qo.fromTemplate(e),Xa.fromTemplate("{userInput}")]),r=new Uh({model:"qwen3:14b"});Ho=t.pipe(r)},zo=async n=>{const e=await Ho.invoke({userInput:n});console.log(e);const t=e.split(`</think>

`)[1],[r,a]=t.split("</call");if(a){const i=r.split("<call>")[1];console.log(i);const[s,o]=i.split(":"),u=gf[s].apply(void 0,JSON.parse(o)),l=`<call>${s}:${o}</call>的结果是${u}`;console.log(`mcp msg: ${l}`);let c={result:""};return s==="mcp_animation"?(c.animations=u,JSON.stringify(c)):await zo(l)}else return JSON.stringify({result:t})};onmessage=async function(n){console.log(n);const{data:{type:e,data:t}}=n;if(e==="init"&&await yf(),e==="conversation"){const r=await zo(t);console.log(r),self.postMessage({type:"conversation-result",data:r})}}})();
